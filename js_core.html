<script>
/**
 * ğŸ§­ ã¿ã‚‰ã„ã‚³ãƒ³ãƒ‘ã‚¹ Ver. 2.0 - Core Logic (å…±é€šæ©Ÿèƒ½)
 * ==============================================================================
 * ã“ã®ãƒ•ã‚¡ã‚¤ãƒ«ã¯ã€ã‚¢ãƒ—ãƒªå…¨ä½“ã®åœŸå°ã¨ãªã‚‹ã€Œè¨­å®šã€ã€Œãƒ‡ãƒ¼ã‚¿ç®¡ç†ã€ã€Œé€šä¿¡å‡¦ç†ã€ã‚’æ‹…å½“ã—ã¾ã™ã€‚
 * ç”Ÿå¾’ç”»é¢ãƒ»å…ˆç”Ÿç”»é¢ã®ã©ã¡ã‚‰ã§ã‚‚ä½¿ã‚ã‚Œã‚‹å…±é€šã®é–¢æ•°ãŒå«ã¾ã‚Œã¦ã„ã¾ã™ã€‚
 */

// ==========================================
//  1. ã‚°ãƒ­ãƒ¼ãƒãƒ«è¨­å®šã¨å®šæ•° (Settings)
// ==========================================

const CONSTANTS = {
  LS_KEY_NAME: 'mirai_student_name',    // ãƒ–ãƒ©ã‚¦ã‚¶ã«ä¿å­˜ã™ã‚‹åå‰ã®ã‚­ãƒ¼
  LS_KEY_CLASS: 'mirai_student_class',  // ãƒ–ãƒ©ã‚¦ã‚¶ã«ä¿å­˜ã™ã‚‹ã‚¯ãƒ©ã‚¹ã®ã‚­ãƒ¼
  LS_KEY_UNIT: 'mirai_current_unit_id', // ãƒ–ãƒ©ã‚¦ã‚¶ã«ä¿å­˜ã™ã‚‹å‰å›ã®å˜å…ƒID
  UNIT_TIME: 45,                        // 1ã‚³ãƒã®æˆæ¥­æ™‚é–“ï¼ˆåˆ†ï¼‰
  REFRESH_INTERVAL: 10000,              // è‡ªå‹•æ›´æ–°ã®é–“éš”ï¼ˆãƒŸãƒªç§’ï¼‰ -> 10ç§’ã”ã¨ã«æ›´æ–°
  SEAT_GRID_SIZE: 110,                  // åº§å¸­è¡¨ã®ã‚°ãƒªãƒƒãƒ‰ã‚µã‚¤ã‚ºï¼ˆãƒ”ã‚¯ã‚»ãƒ«ï¼‰
  
  // æ™‚é–“å‰²ã®è¨­å®šï¼ˆå­¦æ ¡ã®ãƒãƒ£ã‚¤ãƒ ã«åˆã‚ã›ã¦å¤‰æ›´å¯èƒ½ã§ã™ï¼‰
  CLASS_PERIODS: [
    { id: 1, label: '1é™', start: '08:45', end: '09:30' },
    { id: 2, label: '2é™', start: '09:40', end: '10:25' },
    { id: 3, label: '3é™', start: '10:45', end: '11:30' },
    { id: 4, label: '4é™', start: '11:40', end: '12:25' },
    { id: 5, label: '5é™', start: '13:55', end: '14:40' },
    { id: 6, label: '6é™', start: '14:50', end: '15:35' }
  ]
};

// è³‡è³ªãƒ»èƒ½åŠ›ã‚¹ã‚­ãƒ«å®šç¾©ï¼ˆãµã‚Šã‹ãˆã‚Šæ™‚ã«é¸æŠã™ã‚‹ãƒãƒƒã‚¸ï¼‰
const SKILL_DEFINITIONS = [
  { id: 'self_manage', label: 'è‡ªå·±ç®¡ç†', group: 'è‡ªåˆ†', color: 'primary' },
  { id: 'planning', label: 'è¨ˆç”»æ€§', group: 'è‡ªåˆ†', color: 'primary' },
  { id: 'communication', label: 'å¯¾è©±', group: 'äºº', color: 'success' },
  { id: 'collaboration', label: 'å”åŠ›', group: 'äºº', color: 'success' },
  { id: 'challenge', label: 'æŒ‘æˆ¦', group: 'èª²é¡Œ', color: 'danger' },
  { id: 'thinking', label: 'å·¥å¤«', group: 'èª²é¡Œ', color: 'danger' },
  { id: 'habit', label: 'é›†ä¸­', group: 'ç”Ÿæ´»', color: 'warning' },
  { id: 'responsibility', label: 'è²¬ä»»', group: 'ç”Ÿæ´»', color: 'warning' }
];

// AIå˜å…ƒä½œæˆæ©Ÿèƒ½ã§ä½¿ç”¨ã™ã‚‹ã€Œå‘ªæ–‡ï¼ˆãƒ—ãƒ­ãƒ³ãƒ—ãƒˆï¼‰ã€ã®åˆæœŸå€¤
// [ä¿®æ­£] çœç•¥ã•ã‚Œã¦ã„ãŸãƒ—ãƒ­ãƒ³ãƒ—ãƒˆã‚’å®Œå…¨ç‰ˆã«æˆ»ã—ã¾ã™
const DEFAULT_AI_PROMPT = 
`ã‚ãªãŸã¯ã€å€‹åˆ¥æœ€é©ãªå­¦ã³ã¨å”åƒçš„ãªå­¦ã³ã‚’ä¸€ä½“åŒ–ã•ã›ãŸã€Œè‡ªç”±é€²åº¦å­¦ç¿’ã€ã®è¨­è¨ˆã‚¹ãƒšã‚·ãƒ£ãƒªã‚¹ãƒˆã§ã‚ã‚Šã€å­¦ç¿’æŒ‡å°è¦é ˜ã«ç²¾é€šã—ãŸãƒ™ãƒ†ãƒ©ãƒ³æ•™å¸«ã§ã™ã€‚
ãƒ¦ãƒ¼ã‚¶ãƒ¼ï¼ˆå…ˆç”Ÿï¼‰ã¨å¯¾è©±ã‚’è¡Œã„ã€æˆæ¥­å˜å…ƒã®è¨ˆç”»ã‚’ç·´ã‚Šä¸Šã’ãŸä¸Šã§ã€æœ€çµ‚çš„ã«ã‚¢ãƒ—ãƒªç”¨ã®ãƒ‡ãƒ¼ã‚¿ï¼ˆJSONï¼‰ã‚’å‡ºåŠ›ã—ã¦ãã ã•ã„ã€‚
## **â–  å¯¾è©±ã¨ç”Ÿæˆã®ãƒ—ãƒ­ã‚»ã‚¹**
### **Step 1: æƒ…å ±åé›†**
ã¾ãšã€ãƒ¦ãƒ¼ã‚¶ãƒ¼ã«ä»¥ä¸‹ã®æƒ…å ±ã‚’å°‹ã­ã¦ãã ã•ã„ã€‚
ã€Œå…ˆç”Ÿã€æˆæ¥­è¨ˆç”»ã‚’ä½œæˆã—ã¾ã™ã€‚**æ•™ç§‘ãƒ»å˜å…ƒåãƒ»å­¦å¹´ãƒ»å˜å…ƒã®ç·æ™‚æ•°** ã‚’æ•™ãˆã¦ãã ã•ã„ã€‚ã€
### **Step 2: è¨ˆç”»æ¡ˆã®æç¤º**
å…¥åŠ›ã•ã‚ŒãŸæƒ…å ±ã«åŸºã¥ãã€ä»¥ä¸‹ã®ã€Œæˆæ¥­ãƒ‡ã‚¶ã‚¤ãƒ³ã®ãƒ«ãƒ¼ãƒ«ã€ã«å¾“ã£ã¦ã€å…·ä½“çš„ãªæŒ‡å°è¨ˆç”»æ¡ˆï¼ˆã‚·ãƒ©ãƒã‚¹ï¼‰ã‚’æç¤ºã—ã¦ãã ã•ã„ã€‚
ã“ã“ã§ã¯JSONã§ã¯ãªãã€äººé–“ãŒèª­ã¿ã‚„ã™ã„ãƒ†ã‚­ã‚¹ãƒˆå½¢å¼ã§ã€ã€Œç¬¬ä½•æ™‚ã«ä½•ã‚’ã™ã‚‹ã‹ã€ã€Œã©ã‚“ãªé¸æŠèª²é¡Œã‚’ç”¨æ„ã™ã‚‹ã‹ã€ã‚’ææ¡ˆã—ã¦ãã ã•ã„ã€‚
**ææ¡ˆã®ãƒã‚¤ãƒ³ãƒˆ:**
1. **å­ä¾›ã®èˆˆå‘³é–¢å¿ƒ**: å…ç«¥ãŒãƒ¯ã‚¯ãƒ¯ã‚¯ã™ã‚‹ã‚ˆã†ãªã€Œé¸æŠèª²é¡Œï¼ˆChallengeï¼‰ã€ã®ã‚¢ã‚¤ãƒ‡ã‚¢ã‚’è¤‡æ•°ææ¡ˆã™ã‚‹ã“ã¨ã€‚  
2. **åŸºç¤ã®ä¿éšœ**: å­¦ç¿’æŒ‡å°è¦é ˜ã‚’ç¶²ç¾…ã™ã‚‹ã€Œå¿…ä¿®èª²é¡Œï¼ˆMustï¼‰ã€ã‚’é©åˆ‡ãªé †åºã§é…ç½®ã™ã‚‹ã“ã¨ã€‚  
3. **æŸ”è»Ÿæ€§**: ã‚¿ã‚¹ã‚¯æ•°ã¯æ™‚æ•°ã‚ˆã‚Šã‚‚å¤šã‚ã«ç”¨æ„ã—ã€å…ç«¥ãŒé¸ã¹ã‚‹ä½™åœ°ã‚’ä½œã‚‹ã“ã¨ã€‚
### **Step 3: ä¿®æ­£ã¨åˆæ„**
ãƒ¦ãƒ¼ã‚¶ãƒ¼ã«ã€Œã“ã®è¨ˆç”»ã§ã‚ˆã‚ã—ã„ã§ã™ã‹ï¼Ÿ ä¿®æ­£ç‚¹ãŒã‚ã‚Œã°æ•™ãˆã¦ãã ã•ã„ã€‚ã€ã¨ç¢ºèªã—ã¦ãã ã•ã„ã€‚
ä¿®æ­£æŒ‡ç¤ºãŒã‚ã‚Œã°è¨ˆç”»ã‚’ç·´ã‚Šç›´ã—ã€å†æç¤ºã—ã¦ãã ã•ã„ã€‚
### **Step 4: JSONå‡ºåŠ›**
ãƒ¦ãƒ¼ã‚¶ãƒ¼ã‹ã‚‰ã€ŒOKã€ã€Œä½œæˆã—ã¦ã€ç­‰ã®æ‰¿èªãŒå¾—ã‚‰ã‚ŒãŸã‚‰ã€**ç¢ºå®šã—ãŸè¨ˆç”»ã‚’JSONå½¢å¼ã«å¤‰æ›ã—ã€ã‚³ãƒ¼ãƒ‰ãƒ–ãƒ­ãƒƒã‚¯ã§å‡ºåŠ›**ã—ã¦ãã ã•ã„ã€‚
**ã“ã®æ®µéšã§ã¯ã€JSONãƒ‡ãƒ¼ã‚¿ä»¥å¤–ï¼ˆè§£èª¬ã‚„æŒ¨æ‹¶ãªã©ï¼‰ã¯ä¸€åˆ‡å‡ºåŠ›ã—ãªã„ã§ãã ã•ã„ã€‚**
## **â–  æˆæ¥­ãƒ‡ã‚¶ã‚¤ãƒ³ã®ãƒ«ãƒ¼ãƒ«**
### **1\. æˆæ¥­ã®æ™‚é–“æ§‹æˆï¼ˆã‚µãƒ³ãƒ‰ã‚¤ãƒƒãƒå‹ï¼‰**
* **ç¬¬1æ™‚**:  
  * å…¨ä½“ã‚’ teacher\_ledï¼ˆå…ˆç”Ÿä¸»å°ï¼‰ã¨ã—ã€å˜å…ƒã®å°å…¥ã¨å­¦ç¿’è¨ˆç”»ã®ä½œæˆï¼ˆã‚ªãƒªã‚¨ãƒ³ãƒ†ãƒ¼ã‚·ãƒ§ãƒ³ï¼‰ã‚’è¡Œã†ã€‚  
* **ç¬¬2æ™‚ä»¥é™**:  
  * ä»¥ä¸‹ã®é †åºã§æ§‹æˆã™ã‚‹ï¼ˆ45åˆ†æˆæ¥­ã®ãƒ¢ãƒ‡ãƒ«ï¼‰ã€‚  
  * **â‘  å°å…¥ï¼ˆ10åˆ†ï¼‰**: å…ˆç”Ÿä¸»å°ã®ãƒŸãƒ‹ãƒ¬ãƒƒã‚¹ãƒ³ã€‚é‡è¦ãªæ¦‚å¿µã®è§£èª¬ã‚„ã€å…¨ä½“ã¸ã®å…±æœ‰äº‹é …ã€‚ï¼ˆteacher\_led, ã‚¿ã‚¤ãƒˆãƒ«ã«ã€å°å…¥ã€‘ã¨è¨˜è¼‰ï¼‰  
  * **â‘¡ å±•é–‹ï¼ˆ30åˆ†ï¼‰**: å…ç«¥ä¸»ä½“ã®è‡ªç”±é€²åº¦å­¦ç¿’ã€‚ï¼ˆindividualï¼‰  
  * **â‘¢ çµ‚æœ«ï¼ˆ5åˆ†ï¼‰**: å…ˆç”Ÿä¸»å°ã®æŒ¯ã‚Šè¿”ã‚Šã€æ¬¡æ™‚ã®äºˆå‘Šã€‚ï¼ˆteacher\_led, ã‚¿ã‚¤ãƒˆãƒ«ã«ã€çµ‚æœ«ã€‘ã¨è¨˜è¼‰ï¼‰
### **2\. ã‚¿ã‚¹ã‚¯ï¼ˆèª²é¡Œï¼‰ã®ä½œæˆæ–¹é‡**
* **å¿…ä¿®èª²é¡Œ (must)**:  
  * ã€Œæ¨™æº–çš„ãªé€²åº¦ã€ã‚’ç¤ºã™ãŸã‚ã€æ¨å¥¨ã™ã‚‹å®Ÿæ–½å›ï¼ˆstepï¼‰ã‚’è¨­å®šã™ã‚‹ã€‚  
* **é¸æŠèª²é¡Œ (challenge)**:  
  * å…ç«¥ã®èˆˆå‘³ã«åˆã‚ã›ãŸç™ºå±•çš„ãªèª²é¡Œã‚„ã€åˆ¥ã®ã‚¢ãƒ—ãƒ­ãƒ¼ãƒã®èª²é¡Œã€‚  
  * æ¨å¥¨å›ï¼ˆstepï¼‰ã‚’è¨­å®šã—ã¦ã‚‚ã‚ˆã„ã—ã€ã„ã¤ã§ã‚‚å–ã‚Šçµ„ã‚ã‚‹ãƒ—ãƒ¼ãƒ«èª²é¡Œã¨ã—ã¦ step ã‚’ç©ºæ¬„ï¼ˆ""ï¼‰ã«ã—ã¦ã‚‚ã‚ˆã„ã€‚  
* **æ™‚é–“ã®ç²’åº¦**:  
  * è‡ªç”±é€²åº¦å­¦ç¿’ã®æ™‚é–“ã¯30åˆ†ç¢ºä¿ã•ã‚Œã¦ã„ã‚‹ãŒã€ã‚¿ã‚¹ã‚¯ã®ç›®å®‰æ™‚é–“ï¼ˆestimatedTimeï¼‰ã¯15åˆ†ã€œ45åˆ†ãªã©ã€å†…å®¹ã«å¿œã˜ã¦æŸ”è»Ÿã«è¨­å®šã™ã‚‹ï¼ˆå¿…ãšã—ã‚‚15åˆ†åˆ»ã¿ã§ãªãã¦ã‚ˆã„ï¼‰ã€‚
### **3\. ãƒ‡ãƒ¼ã‚¿å‡ºåŠ›ã®ãƒ«ãƒ¼ãƒ«ï¼ˆé‡è¦ï¼šã‚¢ãƒ—ãƒªã®ä»•æ§˜å¯¾å¿œï¼‰**
ã‚¢ãƒ—ãƒªå´ã§æ­£ã—ãè¡¨ç¤ºã•ã›ã‚‹ãŸã‚ã€JSONã® tasks é…åˆ—ã‚’å‡ºåŠ›ã™ã‚‹éš›ã¯ã€**åŒä¸€Stepå†…ã§ä»¥ä¸‹ã®é †åºã«ãªã‚‹ã‚ˆã†ã«å¿…ãšã‚½ãƒ¼ãƒˆï¼ˆä¸¦ã¹æ›¿ãˆï¼‰**ã—ã¦å‡ºåŠ›ã™ã‚‹ã“ã¨ã€‚
1. **å…ˆé ­**: teacher\_led ã‹ã¤ ã‚¿ã‚¤ãƒˆãƒ«ã«ã€å°å…¥ã€‘ã‚’å«ã‚€ã‚¿ã‚¹ã‚¯  
2. **ä¸­é–“**: individual ãªã‚¿ã‚¹ã‚¯ï¼ˆå¿…ä¿®ãƒ»é¸æŠï¼‰  
3. **æœ€å¾Œ**: teacher\_led ã‹ã¤ ã‚¿ã‚¤ãƒˆãƒ«ã«ã€çµ‚æœ«ã€‘ã‚’å«ã‚€ã‚¿ã‚¹ã‚¯
## **â–  å‡ºåŠ›JSONãƒ•ã‚©ãƒ¼ãƒãƒƒãƒˆï¼ˆå³å®ˆï¼‰**
{  
  "unitInfo": {  
    "subject": "æ•™ç§‘å",  
    "grade": å­¦å¹´(æ•°å€¤),  
    "unitName": "å˜å…ƒå",  
    "totalHours": ç·æ™‚æ•°(æ•°å€¤),  
    "goal": "å­ä¾›å‘ã‘ã®å˜å…ƒç›®æ¨™",  
    "description": "å˜å…ƒã®æ¦‚è¦"  
  },  

  "tasks": [  
    {  
      "id": "ä¸€æ„ã®ID (ä¾‹: t\_01, t\_02...)",  
      "category": "ã¤ã‹ã‚€ / ã¾ãªã¶ / ãµã‹ã‚ã‚‹ / ã¾ã¨ã‚ã‚‹",  
      "type": "must (å¿…ä¿®) / challenge (é¸æŠ)",  
      "format": "student (å€‹åˆ¥) / teacher (å…ˆç”Ÿä¸»å°)",  
      "step": "Step 1 (1æ™‚é–“ç›®ã«å›ºå®šã™ã‚‹å ´åˆ) / Step 2 ... / (ç©ºæ¬„ãªã‚‰è‡ªç”±é…ç½®)",  
      "title": "ã‚¿ã‚¹ã‚¯å (å…ˆç”Ÿä¸»å°ã®å ´åˆã¯ã€å°å…¥ã€‘ã€çµ‚æœ«ã€‘ãªã©ã‚’ä»˜è¨˜)",  
      "description": "å†…å®¹ã®èª¬æ˜",  
      "estimatedTime": ç›®å®‰æ™‚é–“(åˆ†ãƒ»æ•°å€¤),  
      "prerequisites": ["å‰æã‚¿ã‚¹ã‚¯ID"] // ãªã‘ã‚Œã° []  
    }  
  ] 
}`;

// ==========================================
//  2. ãƒ‡ãƒ¼ã‚¿ç®¡ç† (State Management)
// ==========================================

// ã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³ã®çŠ¶æ…‹ï¼ˆä»Šã€èª°ãŒã€ã©ã®ç”»é¢ã‚’è¦‹ã¦ã„ã‚‹ã‹ï¼‰
let appState = {
  mode: 'student', // ç¾åœ¨ã®ãƒ¢ãƒ¼ãƒ‰ ('student' ã¾ãŸã¯ 'teacher')
  user: {
    name: "",      // ãƒ­ã‚°ã‚¤ãƒ³ä¸­ã®åå‰
    classId: ""    // ãƒ­ã‚°ã‚¤ãƒ³ä¸­ã®ã‚¯ãƒ©ã‚¹
  },
  view: {
    student: 'daily',   // ç”Ÿå¾’ã®è¡¨ç¤º ('daily':ä»Šæ—¥ã®èª²é¡Œ, 'planning':è¨ˆç”»)
    teacher: 'cards',   // å…ˆç”Ÿã®è¡¨ç¤º ('cards':ä¸€è¦§, 'heatmap':é€²æ—, 'seating':åº§å¸­, 'summaries':ã¾ã¨ã‚, 'design':è¨­è¨ˆ)
    teacherClassId: 'All' // å…ˆç”ŸãŒè¦‹ã¦ã„ã‚‹ã‚¯ãƒ©ã‚¹ãƒ•ã‚£ãƒ«ã‚¿ãƒ¼
  },
  sound: { enabled: true, unlocked: false, prevSosCount: 0 }, // éŸ³å£°é€šçŸ¥ã®è¨­å®š
  unit: { id: "", title: "", totalHours: 8, currentHour: 1 }, // ç¾åœ¨é¸æŠä¸­ã®å˜å…ƒæƒ…å ±
  unitList: [],       // å…¨å˜å…ƒã®ãƒªã‚¹ãƒˆ
  schedules: [],      // é…ä¿¡ã•ã‚ŒãŸã‚¹ã‚±ã‚¸ãƒ¥ãƒ¼ãƒ«é€šçŸ¥
  passportUrl: "",    // ã¿ã‚‰ã„ãƒ‘ã‚¹ãƒãƒ¼ãƒˆï¼ˆå¤–éƒ¨é€£æºã‚¢ãƒ—ãƒªï¼‰ã®URL
  passportDbId: ""    // ã¿ã‚‰ã„ãƒ‘ã‚¹ãƒãƒ¼ãƒˆã®é€£æºç”¨DB ID
};

// ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ã‹ã‚‰å–å¾—ã—ãŸãƒ‡ãƒ¼ã‚¿ã®æ ¼ç´åº«
// â€»ã‚µãƒ¼ãƒãƒ¼ã®ãƒ‡ãƒ¼ã‚¿ã‚’ã“ã“ã«ã‚³ãƒ”ãƒ¼ã—ã¦ç”»é¢ã«è¡¨ç¤ºã—ã¾ã™
let dataStore = {
  masterTasks: [],      // [UnitMasterã‚·ãƒ¼ãƒˆ] èª²é¡Œãƒã‚¹ã‚¿
  myTasks: [],          // [MyTasksã‚·ãƒ¼ãƒˆ] ç”Ÿå¾’ãŒè‡ªåˆ†ã§ä½œã£ãŸèª²é¡Œ
  clsMyTasks: {},       // [MyTasksã‚·ãƒ¼ãƒˆ] ã‚¯ãƒ©ã‚¹å…¨å“¡ã®è‡ªä½œèª²é¡Œï¼ˆå…ˆç”Ÿç”¨ï¼‰
  liveStatus: [],       // [LiveStatusã‚·ãƒ¼ãƒˆ] ãƒªã‚¢ãƒ«ã‚¿ã‚¤ãƒ çŠ¶æ³ï¼ˆSOSãªã©ï¼‰
  clsProgress: {},      // [LearningLogsã‚·ãƒ¼ãƒˆ] ã‚¯ãƒ©ã‚¹å…¨å“¡ã®é€²æ—çŠ¶æ³
  clsFeedback: {},      // [Feedbackã‚·ãƒ¼ãƒˆ] å…ˆç”Ÿã‹ã‚‰ã®ã‚¹ã‚¿ãƒ³ãƒ—å±¥æ­´
  clsPlans: {},         // [StudentPlansã‚·ãƒ¼ãƒˆ] ã‚¯ãƒ©ã‚¹å…¨å“¡ã®å­¦ç¿’è¨ˆç”»
  clsReflections: {},   // [DailyReflectionsã‚·ãƒ¼ãƒˆ] ã‚¯ãƒ©ã‚¹å…¨å“¡ã®æ¯æ™‚é–“ã®ãµã‚Šã‹ãˆã‚Š
  clsPortfolios: {},    // [Portfoliosã‚·ãƒ¼ãƒˆ] ã‚¯ãƒ©ã‚¹å…¨å“¡ã®å˜å…ƒã®ã¾ã¨ã‚
  studentProgress: {},  // (è‡ªåˆ†ç”¨) é€²æ—çŠ¶æ³
  studentFeedback: {},  // (è‡ªåˆ†ç”¨) ã‚¹ã‚¿ãƒ³ãƒ—å±¥æ­´
  studentPlan: {},      // (è‡ªåˆ†ç”¨) å­¦ç¿’è¨ˆç”»
  portfolioData: {},    // (è‡ªåˆ†ç”¨) ãƒãƒ¼ãƒˆãƒ•ã‚©ãƒªã‚ª
  studentReflections: {}, // (è‡ªåˆ†ç”¨) ãµã‚Šã‹ãˆã‚Šå±¥æ­´
  classList: [],        // ã‚¯ãƒ©ã‚¹åãƒªã‚¹ãƒˆ
  roster: []            // [StudentRosterã‚·ãƒ¼ãƒˆ] åç°¿ãƒ‡ãƒ¼ã‚¿
};

// è¨ˆç®—çµæœã®ä¸€æ™‚ä¿å­˜ç”¨
let computedState = { todaysPlanIds: new Set() };
let autoRefreshTimer = null; // è‡ªå‹•æ›´æ–°ã‚¿ã‚¤ãƒãƒ¼ã®ID
let ssUrl = "";              // ã‚¹ãƒ—ãƒ¬ãƒƒãƒ‰ã‚·ãƒ¼ãƒˆã®URL

// è‡ªåˆ†ç”¨ã‚¿ã‚¤ãƒãƒ¼ã®çŠ¶æ…‹
let myTimer = {
  interval: null,
  seconds: 0,
  isActive: false,
  mode: 'up', // 'up':ã‚«ã‚¦ãƒ³ãƒˆã‚¢ãƒƒãƒ—, 'down':ã‚¿ã‚¤ãƒãƒ¼
  target: 0
};

// ==========================================
//  3. åˆæœŸåŒ–ãƒ—ãƒ­ã‚»ã‚¹ (Initialization)
// ==========================================

/**
 * [æ©Ÿèƒ½] ç”»é¢èª­ã¿è¾¼ã¿æ™‚ã«å®Ÿè¡Œã•ã‚Œã‚‹é–¢æ•°
 * ãƒ–ãƒ©ã‚¦ã‚¶ãŒãƒšãƒ¼ã‚¸ã‚’é–‹ã„ãŸç¬é–“ã«å‘¼ã³å‡ºã•ã‚Œã¾ã™ã€‚
 */
window.onload = function() {
  // Google Apps Scriptã®APIãŒä½¿ãˆã‚‹ã‹ç¢ºèª
  if (typeof google === 'undefined' || typeof google.script === 'undefined') {
    console.warn('Google Script API not found. (ãƒ­ãƒ¼ã‚«ãƒ«ãƒ†ã‚¹ãƒˆç’°å¢ƒã§ã™ã‹ï¼Ÿ)');
    return;
  }

  // ã‚µãƒ¼ãƒãƒ¼(Code.gs)ã® getAppInitialData é–¢æ•°ã‚’å‘¼ã³å‡ºã™
  google.script.run
    .withSuccessHandler(handleInitialResponse) // æˆåŠŸã—ãŸã‚‰ handleInitialResponse ã¸
    .withFailureHandler(handleError)           // å¤±æ•—ã—ãŸã‚‰ handleError ã¸
    .getAppInitialData();
};

/**
 * [æ©Ÿèƒ½] åˆæœŸãƒ‡ãƒ¼ã‚¿ã®å—ä¿¡å‡¦ç†
 * ã‚¹ãƒ—ãƒ¬ãƒƒãƒ‰ã‚·ãƒ¼ãƒˆIDãŒã‚ã‚‹ã‹ç¢ºèªã—ã€ã‚ã‚Œã°ãƒ‡ãƒ¼ã‚¿ã‚’èª­ã¿è¾¼ã¿ã¾ã™ã€‚
 */
function handleInitialResponse(res) {
  if (!res.success) { handleError({ message: res.error }); return; }
  ssUrl = res.ssUrl;

  // ã€ŒDBã‚’é–‹ãã€ãƒœã‚¿ãƒ³ã®è¨­å®š
  const btnSs = document.getElementById('btn-view-ss');
  if (btnSs && ssUrl) btnSs.onclick = () => window.open(ssUrl, '_blank');

  // ã‚·ã‚¹ãƒ†ãƒ æœªåˆæœŸåŒ–ï¼ˆã‚¹ãƒ—ãƒ¬ãƒƒãƒ‰ã‚·ãƒ¼ãƒˆãŒãªã„ï¼‰ã®å ´åˆ
  if (!res.isInitialized) {
    renderSetupOverlay(); // åˆæœŸè¨­å®šç”»é¢ã‚’è¡¨ç¤º
  } else {
    loadMainData();       // ãƒ¡ã‚¤ãƒ³ãƒ‡ãƒ¼ã‚¿ã‚’èª­ã¿è¾¼ã¿é–‹å§‹
  }
}

/**
 * [æ©Ÿèƒ½] ãƒ¡ã‚¤ãƒ³ãƒ‡ãƒ¼ã‚¿ã®èª­ã¿è¾¼ã¿
 * ã‚µãƒ¼ãƒãƒ¼ã‹ã‚‰å˜å…ƒã€ç”Ÿå¾’ãƒ­ã‚°ãªã©ã®å…¨ãƒ‡ãƒ¼ã‚¿ã‚’å–å¾—ã—ã¾ã™ã€‚
 */
function loadMainData() {
  const container = document.getElementById('app-container');
  // ç”»é¢ãŒç©ºã£ã½ãªã‚‰ãƒ­ãƒ¼ãƒ‡ã‚£ãƒ³ã‚°è¡¨ç¤º
  if (!container.hasChildNodes() || container.innerHTML === '') showLoading();
  
  // ã€é€£æºã€‘ã¿ã‚‰ã„ãƒ‘ã‚¹ãƒãƒ¼ãƒˆã®è¨­å®šï¼ˆURLã¨IDï¼‰ã‚’å–å¾—
  google.script.run.withSuccessHandler(url => { appState.passportUrl = url; }).getPassportUrl();
  google.script.run.withSuccessHandler(id => { appState.passportDbId = id; }).getPassportDbId();

  // ã€DBèª­è¾¼ã€‘getDataé–¢æ•°ã‚’å®Ÿè¡Œ (UnitMaster, LearningLogsç­‰ å…¨ã‚·ãƒ¼ãƒˆ)
  google.script.run
    .withSuccessHandler(res => {
      if (res.success) {
        updateDataStore(res.json); // ãƒ‡ãƒ¼ã‚¿ã‚’å¤‰æ•°ã«æ ¼ç´
        renderUnitSelector();      // å˜å…ƒé¸æŠãƒ¡ãƒ‹ãƒ¥ãƒ¼ã‚’æç”»
        renderApp();               // ã‚¢ãƒ—ãƒªã®ãƒ¡ã‚¤ãƒ³ç”»é¢ã‚’æç”»
        hideLoading();             // ãƒ­ãƒ¼ãƒ‡ã‚£ãƒ³ã‚°ã‚’æ¶ˆã™
        
        // ç”Ÿå¾’ãƒ¢ãƒ¼ãƒ‰ãªã‚‰è¿½åŠ ã®ãƒã‚§ãƒƒã‚¯
        if (appState.mode === 'student') {
          if (typeof renderMyTimer === 'function') renderMyTimer(); // ã‚¿ã‚¤ãƒãƒ¼è¡¨ç¤º (js_student.html)
          checkScheduleAndNotify(); // æˆæ¥­é€šçŸ¥ãƒã‚§ãƒƒã‚¯
          unlockAudio();            // éŸ³å£°å†ç”Ÿã®æº–å‚™
        }
      } else { 
        handleError({ message: res.error }); 
      }
    })
    .withFailureHandler(handleError)
    .getData();
}

/**
 * [æ©Ÿèƒ½] åˆæœŸã‚»ãƒƒãƒˆã‚¢ãƒƒãƒ—ç”»é¢ã®è¡¨ç¤º
 * åˆã‚ã¦ä½¿ã†æ™‚ã«è¡¨ç¤ºã•ã‚Œã‚‹ã€ŒåˆæœŸè¨­å®šã‚’é–‹å§‹ã™ã‚‹ã€ç”»é¢ã§ã™ã€‚
 */
function renderSetupOverlay() {
  const container = document.getElementById('app-container');
  container.innerHTML = `
    <div class="d-flex flex-column justify-content-center align-items-center vh-100 text-center">
      <div class="card p-5 shadow-lg border-0 rounded-4" style="max-width: 600px;">
        <h1 class="text-primary mb-4 fw-bold"><i class="bi bi-compass me-2"></i>ã‚ˆã†ã“ã</h1>
        <div class="text-start bg-light p-4 rounded-3 mb-4">
          <p class="mb-3">ã€Œã¿ã‚‰ã„ã‚³ãƒ³ãƒ‘ã‚¹ã€ã¯ã€å­ã©ã‚‚ãŸã¡ãŒä¸»ä½“çš„ã«å­¦ã¶ã€Œè‡ªç”±é€²åº¦å­¦ç¿’ã€ã‚’ã‚µãƒãƒ¼ãƒˆã™ã‚‹Webã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³ã§ã™ã€‚</p>
          <p class="mb-0">åˆæœŸè¨­å®šãƒœã‚¿ãƒ³ã‚’æŠ¼ã™ã¨ã€Googleãƒ‰ãƒ©ã‚¤ãƒ–ã«ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ï¼ˆã‚¹ãƒ—ãƒ¬ãƒƒãƒ‰ã‚·ãƒ¼ãƒˆï¼‰ãŒè‡ªå‹•ä½œæˆã•ã‚Œã¾ã™ã€‚</p>
        </div>
        <div class="alert alert-warning mb-4" role="alert">
          <div class="fw-bold mb-1">ã€é‡è¦ã€‘å…ˆç”Ÿç”¨ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ï¼ˆåˆæœŸï¼‰</div>
          <div class="display-6 fw-bold text-danger" style="letter-spacing: 2px;">admin</div>
        </div>
        <button class="btn btn-primary btn-lg rounded-pill px-5 shadow-sm" onclick="startInitialization()">åˆæœŸè¨­å®šã‚’é–‹å§‹ã™ã‚‹</button>
      </div>
    </div>`;
  hideLoading();
}

/**
 * [æ©Ÿèƒ½] ã‚·ã‚¹ãƒ†ãƒ åˆæœŸåŒ–ã®å®Ÿè¡Œ
 * æ–°ã—ã„ã‚¹ãƒ—ãƒ¬ãƒƒãƒ‰ã‚·ãƒ¼ãƒˆã‚’ä½œæˆã—ã¾ã™ã€‚
 */
function startInitialization() {
  showLoading();
  google.script.run
    .withSuccessHandler(r => {
      if (r.success) {
        Swal.fire('åˆæœŸåŒ–å®Œäº†', 'ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ã‚’ä½œæˆã—ã¾ã—ãŸã€‚', 'success');
        loadMainData(); // ãƒ‡ãƒ¼ã‚¿èª­ã¿è¾¼ã¿ã¸
      } else handleError({ message: r.error });
    })
    .withFailureHandler(handleError)
    .initSystem();
}

// ==========================================
//  4. ãƒ‡ãƒ¼ã‚¿ã®æ›´æ–°ã¨åŒæœŸ (Sync & Refresh)
// ==========================================

/**
 * [æ©Ÿèƒ½] è‡ªå‹•æ›´æ–°ã‚¿ã‚¤ãƒãƒ¼ï¼ˆãƒãƒ¼ãƒªãƒ³ã‚°ï¼‰
 * 10ç§’ã”ã¨ã«ã‚µãƒ¼ãƒãƒ¼ã‹ã‚‰æœ€æ–°ã®ã€ŒçŠ¶æ³ãƒ‡ãƒ¼ã‚¿ï¼ˆLiveStatusï¼‰ã€ã ã‘ã‚’å–å¾—ã—ã¾ã™ã€‚
 * ã“ã‚Œã«ã‚ˆã‚Šã€å…ˆç”Ÿã®ç”»é¢ã§å­ä¾›ãŸã¡ã®SOSãªã©ãŒãƒªã‚¢ãƒ«ã‚¿ã‚¤ãƒ ã«åæ˜ ã•ã‚Œã¾ã™ã€‚
 */
function startAutoRefresh() {
  if (autoRefreshTimer) clearInterval(autoRefreshTimer);
  
  autoRefreshTimer = setInterval(() => {
    // ãƒ–ãƒ©ã‚¦ã‚¶ã®ã‚¿ãƒ–ãŒè£ã«éš ã‚Œã¦ã„ã‚‹æ™‚ã¯é€šä¿¡ã‚’æ­¢ã‚ã‚‹ï¼ˆPCè² è·è»½æ¸›ï¼‰
    if (document.hidden) return;

    // ã€DBèª­è¾¼ã€‘LiveStatusã‚·ãƒ¼ãƒˆã®ã¿ã‚’è»½é‡å–å¾—
    google.script.run
      .withSuccessHandler(res => {
        if (res.success && res.live) {
          // ãƒ‡ãƒ¼ã‚¿ã‚’æ›´æ–°
          dataStore.liveStatus = res.live;
          
          // å…ˆç”Ÿãƒ¢ãƒ¼ãƒ‰ãªã‚‰ã€ç”»é¢å…¨ä½“ã‚’å†æç”»ã›ãšã€ã‚«ãƒ¼ãƒ‰ã®ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹ã ã‘æ›¸ãæ›ãˆã‚‹ï¼ˆé«˜é€ŸåŒ–ï¼‰
          if (appState.mode === 'teacher') {
            if (typeof updateLiveViews === 'function') updateLiveViews(); // js_teacher.htmlã§å®šç¾©
            checkSosAndPlaySound();
          }
          // ç”Ÿå¾’ãƒ¢ãƒ¼ãƒ‰ãªã‚‰ã€å…ˆç”Ÿã‹ã‚‰ã®å‘¼ã³å‡ºã—é€šçŸ¥ãªã©ã‚’ãƒã‚§ãƒƒã‚¯
          else if (appState.mode === 'student') {
            checkScheduleAndNotify();
          }
        }
      })
      .withFailureHandler(e => console.error("Polling Error", e))
      .getLiveStatusSnapshot(); // ã‚µãƒ¼ãƒãƒ¼å´ã®è»½é‡é–¢æ•°
      
  }, CONSTANTS.REFRESH_INTERVAL);
}

/**
 * [æ©Ÿèƒ½] å–å¾—ã—ãŸãƒ‡ãƒ¼ã‚¿ã‚’å¤‰æ•°(dataStore)ã«æ ¼ç´ãƒ»æ•´ç†ã™ã‚‹
 */
function updateDataStore(jsonStr) {
  const d = JSON.parse(jsonStr);
  dataStore.masterTasks = d.unit || [];
  dataStore.liveStatus = d.live || [];
  dataStore.clsProgress = d.progress || {};
  dataStore.clsFeedback = d.feedback || {};
  dataStore.clsMyTasks = d.myTasks || {};
  dataStore.clsPlans = d.plans || {};
  dataStore.clsReflections = d.dailyReflections || {};
  dataStore.clsPortfolios = d.portfolios || {};
  dataStore.roster = d.roster || [];
  appState.schedules = d.schedules || [];

  // å˜å…ƒãƒªã‚¹ãƒˆã‚’ä½œæˆï¼ˆUnitMasterã‹ã‚‰å˜å…ƒIDã”ã¨ã«ã¾ã¨ã‚ã‚‹ï¼‰
  const unitsMap = new Map();
  dataStore.masterTasks.forEach(t => {
    if (t.unitId && !unitsMap.has(t.unitId)) {
      const uInfo = t.unitInfo || {};
      unitsMap.set(t.unitId, {
        id: t.unitId,
        title: uInfo.title || 'ç„¡é¡Œã®å˜å…ƒ',
        subject: uInfo.subject || '',
        totalHours: Number(t.totalHours) || 8,
        grade: uInfo.grade || '',
        goal: uInfo.goal || '',
        description: uInfo.description || ''
      });
    }
  });
  // æ–°ã—ã„å˜å…ƒé †ã«ä¸¦ã¹æ›¿ãˆ
  appState.unitList = Array.from(unitsMap.values()).sort((a, b) => b.id.localeCompare(a.id));

  // ç¾åœ¨ã®å˜å…ƒã‚’é¸æŠï¼ˆæœªé¸æŠãªã‚‰æœ€æ–°ã®å˜å…ƒï¼‰
  if (appState.unitList.length > 0 && !appState.unit.id) {
    const savedId = localStorage.getItem(CONSTANTS.LS_KEY_UNIT);
    const target = appState.unitList.find(u => u.id === savedId) || appState.unitList[0];
    appState.unit.id = target.id;
    appState.unit.title = target.title;
    appState.unit.totalHours = target.totalHours;
  } else if (appState.unitList.length === 0) {
    appState.unit.id = "";
    appState.unit.title = "å˜å…ƒãƒ‡ãƒ¼ã‚¿ãªã—";
  }

  // ã‚¯ãƒ©ã‚¹ãƒªã‚¹ãƒˆã‚’ä½œæˆï¼ˆãƒ‡ãƒ¼ã‚¿ãŒå­˜åœ¨ã™ã‚‹ã‚¯ãƒ©ã‚¹ä¸€è¦§ï¼‰
  const classes = new Set();
  dataStore.liveStatus.forEach(s => { if(s.classId) classes.add(s.classId); });
  dataStore.roster.forEach(r => { if(r.classId) classes.add(r.classId); });
  if(classes.size === 0) classes.add('1çµ„');
  dataStore.classList = Array.from(classes).sort();
}

// ==========================================
//  5. å…±é€šã‚¢ã‚¯ã‚·ãƒ§ãƒ³ (Common Actions)
// ==========================================

/**
 * [æ©Ÿèƒ½] å˜å…ƒã®åˆ‡ã‚Šæ›¿ãˆ
 * ãƒ‰ãƒ­ãƒƒãƒ—ãƒ€ã‚¦ãƒ³ã§å˜å…ƒãŒå¤‰æ›´ã•ã‚ŒãŸæ™‚ã«å‘¼ã°ã‚Œã¾ã™ã€‚
 */
function changeUnit(unitId) {
  const target = appState.unitList.find(u => u.id === unitId);
  if (target) {
    appState.unit.id = target.id;
    appState.unit.title = target.title;
    appState.unit.totalHours = target.totalHours;
    localStorage.setItem(CONSTANTS.LS_KEY_UNIT, unitId);
    
    // ç”Ÿå¾’ãƒ¢ãƒ¼ãƒ‰ï¼šè‡ªåˆ†ã®ãƒ‡ãƒ¼ã‚¿ã‚’å†èª­ã¿è¾¼ã¿
    if(appState.mode === 'student' && appState.user.name) {
      if (typeof syncStudentPlan === 'function') syncStudentPlan();
      if (typeof renderStudentView === 'function') renderStudentView();
      if (typeof loginStudent === 'function') loginStudent(true); // ã‚µãƒ¼ãƒãƒ¼ã‹ã‚‰ãƒ‡ãƒ¼ã‚¿å–å¾—
      if (typeof submitUserStatus === 'function') submitUserStatus(getSelfStatusMode()); 
    } 
    // å…ˆç”Ÿãƒ¢ãƒ¼ãƒ‰ï¼šç”»é¢å†æç”»
    else if (appState.mode === 'teacher') {
      if (typeof renderTeacherView === 'function') renderTeacherView();
    }
  }
}

/**
 * [æ©Ÿèƒ½] ãƒ¢ãƒ¼ãƒ‰åˆ‡æ›¿ï¼ˆç”Ÿå¾’ â‡” å…ˆç”Ÿï¼‰
 */
function switchMode(newMode) {
  appState.mode = newMode;
  
  // ç”Ÿå¾’ãƒ¢ãƒ¼ãƒ‰ã¸ã®åˆ‡ã‚Šæ›¿ãˆæ™‚ã¯ãƒ‡ãƒ¼ã‚¿ã‚’å†å–å¾—ã—ã¦æœ€æ–°çŠ¶æ…‹ã«ã™ã‚‹
  if(newMode === 'student') {
    showLoading();
    google.script.run
      .withSuccessHandler(res => {
        if (res.success) {
          updateDataStore(res.json);
          renderApp(); // ç”»é¢æç”»
          startAutoRefresh(); // è‡ªå‹•æ›´æ–°é–‹å§‹
          hideLoading();
        } else {
          handleError({message: res.error});
        }
      })
      .withFailureHandler(handleError)
      .getData();
  } else {
    // å…ˆç”Ÿãƒ¢ãƒ¼ãƒ‰ã¸ã¯å³æ™‚åˆ‡ã‚Šæ›¿ãˆ
    renderApp();
  }
}

/**
 * [æ©Ÿèƒ½] ç”»é¢å…¨ä½“ã®æç”»ãƒ‡ã‚£ã‚¹ãƒ‘ãƒƒãƒãƒ£ï¼ˆæŒ¯ã‚Šåˆ†ã‘ï¼‰
 * ç¾åœ¨ã®ãƒ¢ãƒ¼ãƒ‰ã«åˆã‚ã›ã¦ã€ç”Ÿå¾’ç”¨ã¾ãŸã¯å…ˆç”Ÿç”¨ã®ç”»é¢ã‚’æç”»ã—ã¾ã™ã€‚
 */
function renderApp() {
  try {
    const mainEl = document.querySelector('main');
    const settingsBtn = document.getElementById('btn-settings');
    const exitBtn = document.getElementById('btn-exit-teacher');
    
    if (appState.mode === 'teacher') {
      // å…ˆç”Ÿãƒ¢ãƒ¼ãƒ‰
      mainEl.classList.add('teacher-mode'); // æ¨ªå¹…åˆ¶é™ã‚’è§£é™¤
      settingsBtn.classList.remove('d-none'); // è¨­å®šãƒœã‚¿ãƒ³è¡¨ç¤º
      exitBtn.classList.remove('d-none');     // çµ‚äº†ãƒœã‚¿ãƒ³è¡¨ç¤º
      if (typeof renderTeacherView === 'function') renderTeacherView();
    } else {
      // ç”Ÿå¾’ãƒ¢ãƒ¼ãƒ‰
      mainEl.classList.remove('teacher-mode');
      settingsBtn.classList.add('d-none');
      exitBtn.classList.add('d-none');
      
      const savedName = localStorage.getItem(CONSTANTS.LS_KEY_NAME);
      const savedClass = localStorage.getItem(CONSTANTS.LS_KEY_CLASS);
      
      // åå‰ãŒã¾ã å…¥åŠ›ã•ã‚Œã¦ã„ãªã„å ´åˆ
      if (!appState.user.name && savedName) {
        // ä¿å­˜ã•ã‚ŒãŸåå‰ãŒã‚ã‚Œã°è‡ªå‹•ãƒ­ã‚°ã‚¤ãƒ³
        appState.user.name = savedName;
        appState.user.classId = savedClass || "1çµ„";
        if (typeof loginStudent === 'function') loginStudent(true);
      } else if (!appState.user.name) {
        // åå‰å…¥åŠ›ç”»é¢ã‚’è¡¨ç¤º
        if (typeof renderNameEntry === 'function') renderNameEntry();
      } else {
        // ãƒ­ã‚°ã‚¤ãƒ³æ¸ˆã¿ãªã‚‰å­¦ç¿’ç”»é¢ã‚’è¡¨ç¤º
        if (typeof syncStudentPlan === 'function') syncStudentPlan();
        if (typeof renderStudentView === 'function') renderStudentView();
      }
    }
  } catch (e) {
    console.error(e);
    handleError({ message: "æç”»ã‚¨ãƒ©ãƒ¼: " + e.message });
  }
}

/**
 * [æ©Ÿèƒ½] å˜å…ƒé¸æŠãƒ‰ãƒ­ãƒƒãƒ—ãƒ€ã‚¦ãƒ³ã®æç”»
 */
function renderUnitSelector() {
  const options = appState.unitList.map(u => 
    `<option value="${u.id}" ${u.id === appState.unit.id ? 'selected' : ''}>${u.subject ? 'ã€'+u.subject+'ã€‘' : ''} ${u.title}</option>`
  ).join('');
  
  const html = `
    <div class="input-group input-group-sm">
      <span class="input-group-text bg-white border-end-0 text-primary"><i class="bi bi-book-half"></i></span>
      <!-- ä¿®æ­£: max-widthã‚’ 200px ã‹ã‚‰ 450px ã«å¤‰æ›´ -->
      <select class="form-select border-start-0 fw-bold text-primary bg-light" onchange="changeUnit(this.value)" style="box-shadow:none; max-width: 450px;">
        ${options.length > 0 ? options : '<option>å˜å…ƒãªã—</option>'}
      </select>
      <button class="btn btn-outline-secondary border-start-0" type="button" onclick="showUnitInfoModal()" title="å˜å…ƒã®è©³ç´°">
        <i class="bi bi-info-circle"></i>
      </button>
    </div>
  `;
  
  const c1 = document.getElementById('unit-selector-container'); // PCç”¨
  const c2 = document.getElementById('unit-selector-mobile');    // ã‚¹ãƒãƒ›ç”¨
  if(c1) c1.innerHTML = html;
  if(c2) c2.innerHTML = html;
}

// ==========================================
//  6. ãƒ˜ãƒ«ãƒ‘ãƒ¼é–¢æ•° (Helpers & Utils)
// ==========================================

// è‡ªåˆ†ã®ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹ï¼ˆé€šå¸¸/SOS/é›†ä¸­ï¼‰ã‚’å–å¾—
function getSelfStatusMode() {
  const me = dataStore.liveStatus.find(s => s.name === appState.user.name);
  return me ? me.mode : 'é€šå¸¸';
}

// ç¾åœ¨ã®å˜å…ƒã®ã‚¿ã‚¹ã‚¯ä¸€è¦§ã‚’å–å¾—
function getCurrentUnitTasks() {
  return dataStore.masterTasks.filter(t => t.unitId === appState.unit.id);
}

// ã‚¹ã‚±ã‚¸ãƒ¥ãƒ¼ãƒ«é€šçŸ¥ã®ãƒã‚§ãƒƒã‚¯ï¼ˆç”Ÿå¾’ç”¨ï¼‰
function checkScheduleAndNotify() {
  if (!appState.user.classId || appState.schedules.length === 0) return;
  
  const now = new Date();
  const dateStr = now.getFullYear() + "-" + ('0' + (now.getMonth() + 1)).slice(-2) + "-" + ('0' + now.getDate()).slice(-2);
  const timeStr = ('0' + now.getHours()).slice(-2) + ":" + ('0' + now.getMinutes()).slice(-2);
  
  // ä»Šã®æ—¥æ™‚ãƒ»ã‚¯ãƒ©ã‚¹ã«ä¸€è‡´ã™ã‚‹ã‚¹ã‚±ã‚¸ãƒ¥ãƒ¼ãƒ«ã‚’æ¢ã™
  const currentSchedule = appState.schedules.find(s => 
    s.classId === appState.user.classId && 
    s.date === dateStr &&
    s.startTime <= timeStr && s.endTime >= timeStr
  );

  let notifyBar = document.getElementById('schedule-notify-bar');
  
  if (currentSchedule) {
    const unit = appState.unitList.find(u => u.id === currentSchedule.unitId);
    const unitTitle = unit ? unit.title : "ä¸æ˜ãªå˜å…ƒ";
    const msg = currentSchedule.message || `ãŸã ä»Šã®æˆæ¥­ï¼š${unitTitle} ç¬¬${currentSchedule.hour}æ™‚`;
    
    // é€šçŸ¥ãƒãƒ¼ã‚’ä½œæˆãƒ»æ›´æ–°
    if (!notifyBar) {
      notifyBar = document.createElement('div');
      notifyBar.id = 'schedule-notify-bar';
      notifyBar.className = 'bg-info text-white text-center py-2 px-3 shadow-sm cursor-pointer animate__animated animate__fadeInDown';
      notifyBar.style.cssText = 'position:fixed; top:60px; left:0; right:0; z-index:1020;';
      notifyBar.onclick = () => {
        // é€šçŸ¥ã‚¯ãƒªãƒƒã‚¯ã§è©²å½“å˜å…ƒã¸ç§»å‹•
        if(unit) {
          changeUnit(unit.id);
          if (typeof changeCurrentHour === 'function') changeCurrentHour(currentSchedule.hour);
          if(currentSchedule.message) Swal.fire({ title: 'å…ˆç”Ÿã‹ã‚‰ã®ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸', text: currentSchedule.message, icon: 'info' });
        }
      };
      document.body.appendChild(notifyBar);
    }
    notifyBar.innerHTML = `<i class="bi bi-broadcast me-2"></i><span class="fw-bold">${msg}</span> <small class="ms-2 border rounded-pill px-2">ç§»å‹•ã™ã‚‹</small>`;
  } else {
    // æ™‚é–“å¤–ãªã‚‰é€šçŸ¥ãƒãƒ¼ã‚’æ¶ˆã™
    if (notifyBar) notifyBar.remove();
  }
}

// éŸ³å£°é€šçŸ¥ï¼ˆSOSç”¨ï¼‰
function unlockAudio() { 
  const audio = document.getElementById('sos-chime'); 
  if (audio && !appState.sound.unlocked) { 
    // ãƒ¦ãƒ¼ã‚¶ãƒ¼æ“ä½œæ™‚ã«ä¸€åº¦ç„¡éŸ³ã§å†ç”Ÿã—ã¦ã€ãƒ–ãƒ©ã‚¦ã‚¶ã®è‡ªå‹•å†ç”Ÿåˆ¶é™ã‚’è§£é™¤ã™ã‚‹
    audio.volume = 0; 
    audio.play().then(() => { 
      audio.pause(); 
      audio.currentTime = 0; 
      audio.volume = 0.5; 
      appState.sound.unlocked = true; 
    }).catch(e => {}); 
  } 
}

function checkSosAndPlaySound() { 
  const currentSosCount = dataStore.liveStatus.filter(d => d.mode === 'ãŸã™ã‘ã¦' || d.mode === 'sos').length; 
  // SOSã®æ•°ãŒå¢—ãˆãŸæ™‚ã ã‘éŸ³ã‚’é³´ã‚‰ã™
  if (currentSosCount > appState.sound.prevSosCount) { 
    const audio = document.getElementById('sos-chime'); 
    if (audio) audio.play().catch(e => {}); 
  } 
  appState.sound.prevSosCount = currentSosCount; 
}

// ã‚«ãƒ†ã‚´ãƒªã«å¿œã˜ãŸCSSã‚¯ãƒ©ã‚¹ã‚’è¿”ã™
function getCategoryColorClass(cat) {
  if (cat.includes('ã¾ãªã¶')) return 'border-start-manabu';
  if (cat.includes('ãµã‹ã‚ã‚‹')) return 'border-start-fukameru';
  if (cat.includes('ã¾ã¨ã‚ã‚‹')) return 'border-start-matomeru';
  if (cat === 'ãƒã‚¤ã‚¿ã‚¹ã‚¯') return 'border-start-mytask';
  return 'border-start-other';
}

// ã‚¹ãƒ†ãƒƒãƒ—æ–‡å­—åˆ— ("Step 1") ã‹ã‚‰æ•°å€¤ (1) ã‚’å–ã‚Šå‡ºã™
function getStepNumber(stepStr) {
  if(!stepStr) return -1;
  const match = stepStr.match(/\d+/);
  return match ? parseInt(match[0], 10) : -1;
}

// ãƒˆãƒ¼ã‚¹ãƒˆé€šçŸ¥ï¼ˆå³ä¸Šã®ãƒãƒƒãƒ—ã‚¢ãƒƒãƒ—ï¼‰
function showToast(icon, title) { 
  Swal.fire({ toast: true, position: 'top-end', icon: icon, title: title, timer: 2000, showConfirmButton: false }); 
}

// ã‚¨ãƒ©ãƒ¼è¡¨ç¤º
function handleError(err) { 
  hideLoading(); 
  Swal.fire({ title: 'ã‚·ã‚¹ãƒ†ãƒ ã‚¨ãƒ©ãƒ¼', text: err.message || err.toString(), icon: 'error' }); 
}

// ãƒ­ãƒ¼ãƒ‡ã‚£ãƒ³ã‚°ç”»é¢ã®åˆ¶å¾¡
function showLoading() { const e = document.getElementById('loading'); if (e) e.classList.remove('d-none'); }
function hideLoading() { const e = document.getElementById('loading'); if (e) e.classList.add('d-none'); }

// ==========================================
//  7. å¤–éƒ¨é€£æº (Passport Integration)
// ==========================================

/**
 * [æ©Ÿèƒ½] ã¿ã‚‰ã„ãƒ‘ã‚¹ãƒãƒ¼ãƒˆï¼ˆåˆ¥ã‚¢ãƒ—ãƒªï¼‰ã®èµ·å‹•
 * @param {string} taskId - ç¾åœ¨å–ã‚Šçµ„ã‚“ã§ã„ã‚‹èª²é¡ŒID
 */
function launchPassport(taskId) {
  if (!appState.passportUrl) {
    Swal.fire({
      icon: 'warning',
      title: 'é€£æºæœªè¨­å®š',
      text: 'ã€Œã¿ã‚‰ã„ãƒ‘ã‚¹ãƒãƒ¼ãƒˆã€ã®URLãŒè¨­å®šã•ã‚Œã¦ã„ã¾ã›ã‚“ã€‚å…ˆç”Ÿã«ç¢ºèªã—ã¦ãã ã•ã„ã€‚'
    });
    return;
  }

  // è‡ªå‹•ãƒ­ã‚°ã‚¤ãƒ³ç”¨ã®æƒ…å ±ã‚’URLãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿ã¨ã—ã¦ä»˜ä¸
  const params = new URLSearchParams({
    mode: 'student',
    taskId: taskId,
    studentId: appState.user.name, // ç°¡æ˜“çš„ã«åå‰ã‚’IDã¨ã—ã¦ä½¿ç”¨
    studentName: appState.user.name
  });

  const url = `${appState.passportUrl}?${params.toString()}`;
  window.open(url, '_blank'); // åˆ¥ã‚¿ãƒ–ã§é–‹ã
}

/**
 * [æ©Ÿèƒ½] è¨­å®šãƒ¢ãƒ¼ãƒ€ãƒ«ï¼ˆé€£æºè¨­å®šãªã©ï¼‰
 */
function toggleSettings() { 
  Swal.fire({
    title: 'è¨­å®š',
    html: `
      <div class="text-start">
        <label class="form-label small fw-bold">ã¿ã‚‰ã„ãƒ‘ã‚¹ãƒãƒ¼ãƒˆ URL</label>
        <input type="url" id="swal-passport-url" class="form-control mb-3" placeholder="https://script.google.com/..." value="${appState.passportUrl || ''}">
        
        <label class="form-label small fw-bold">ã¿ã‚‰ã„ãƒ‘ã‚¹ãƒãƒ¼ãƒˆ DB ID</label>
        <input type="text" id="swal-passport-db-id" class="form-control mb-3" placeholder="ã‚¹ãƒ—ãƒ¬ãƒƒãƒ‰ã‚·ãƒ¼ãƒˆID" value="${appState.passportDbId || ''}">
        
        <div class="d-grid gap-2">
          <button class="btn btn-outline-secondary btn-sm" onclick="changePasswordPrompt()">æ•™å“¡ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰å¤‰æ›´</button>
          <button class="btn btn-outline-secondary btn-sm" onclick="openRosterManagerModal()">åç°¿ç®¡ç†</button>
        </div>
      </div>
    `,
    showCancelButton: true,
    confirmButtonText: 'ä¿å­˜',
    preConfirm: () => {
      return {
        url: document.getElementById('swal-passport-url').value,
        dbId: document.getElementById('swal-passport-db-id').value
      };
    }
  }).then((result) => {
    if (result.isConfirmed) {
      const data = result.value;
      if (data.url && !data.url.startsWith('http')) {
        Swal.fire('ã‚¨ãƒ©ãƒ¼', 'æ­£ã—ã„URLã‚’å…¥åŠ›ã—ã¦ãã ã•ã„', 'error');
        return;
      }
      showLoading();
      // ã€é€£æºã€‘è¨­å®šã‚’ã‚µãƒ¼ãƒãƒ¼ãƒ—ãƒ­ãƒ‘ãƒ†ã‚£ã«ä¿å­˜
      google.script.run
        .withSuccessHandler(() => {
          appState.passportUrl = data.url;
          appState.passportDbId = data.dbId;
          hideLoading();
          showToast('success', 'è¨­å®šã‚’ä¿å­˜ã—ã¾ã—ãŸ');
        })
        .withFailureHandler(handleError)
        .savePassportConfig(data.dbId, data.url);
    }
  });
}

/**
 * [ãƒ¢ãƒ¼ãƒ€ãƒ«] å˜å…ƒè©³ç´°æƒ…å ±ï¼ˆã‚ã‚ã¦ãƒ»æ¦‚è¦ï¼‰ã‚’è¡¨ç¤º
 * ãƒ˜ãƒƒãƒ€ãƒ¼ã® (i) ãƒœã‚¿ãƒ³ã‹ã‚‰å‘¼ã³å‡ºã•ã‚Œã¾ã™ã€‚
 */
function showUnitInfoModal() {
  const unit = appState.unitList.find(u => u.id === appState.unit.id);
  if (!unit) return;

  Swal.fire({
    title: `<div class="fs-5 fw-bold text-primary">${unit.subject || ''} ${unit.grade ? '('+unit.grade+')' : ''}</div><div class="fs-4">${unit.title}</div>`,
    html: `
      <div class="text-start p-2">
        <div class="mb-3">
          <label class="small text-muted fw-bold">å˜å…ƒã®ã‚ã‚ã¦</label>
          <div class="p-3 bg-light rounded border-start border-5 border-success">
            <i class="bi bi-flag-fill text-success me-2"></i>
            <span class="fw-bold text-dark">${unit.goal || 'ï¼ˆç›®æ¨™ã¯è¨­å®šã•ã‚Œã¦ã„ã¾ã›ã‚“ï¼‰'}</span>
          </div>
        </div>
        <div class="mb-3">
          <label class="small text-muted fw-bold">æ¦‚è¦</label>
          <div class="small text-secondary">
            ${unit.description ? unit.description.replace(/\n/g, '<br>') : 'ï¼ˆæ¦‚è¦ã¯ã‚ã‚Šã¾ã›ã‚“ï¼‰'}
          </div>
        </div>
        <div class="text-end small text-muted">
          ç·æ™‚æ•°: ${unit.totalHours}æ™‚é–“
        </div>
      </div>
    `,
    showCloseButton: true,
    showConfirmButton: false,
    width: '500px'
  });
}
</script>
