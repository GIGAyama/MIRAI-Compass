<script>
/**
 * ã¿ã‚‰ã„ã‚³ãƒ³ãƒ‘ã‚¹ Ver. 1.0 - ã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆã‚µã‚¤ãƒ‰ãƒ­ã‚¸ãƒƒã‚¯
 * * ç”»é¢ã®æç”»ã€ãƒœã‚¿ãƒ³æ“ä½œã€ã‚µãƒ¼ãƒãƒ¼ã¨ã®é€šä¿¡ãªã©ã‚’åˆ¶å¾¡ã—ã¾ã™ã€‚
 */

// ==========================================
//  1. ã‚°ãƒ­ãƒ¼ãƒãƒ«è¨­å®šã¨å®šæ•°
// ==========================================

const CONSTANTS = {
  LS_KEY_NAME: 'mirai_student_name',
  LS_KEY_CLASS: 'mirai_student_class',
  LS_KEY_UNIT: 'mirai_current_unit_id',
  UNIT_TIME: 45,
  REFRESH_INTERVAL: 30000,
  SEAT_GRID_SIZE: 110,
  
  CLASS_PERIODS: [
    { id: 1, label: '1é™', start: '08:45', end: '09:30' },
    { id: 2, label: '2é™', start: '09:40', end: '10:25' },
    { id: 3, label: '3é™', start: '10:45', end: '11:30' },
    { id: 4, label: '4é™', start: '11:40', end: '12:25' },
    { id: 5, label: '5é™', start: '13:55', end: '14:40' },
    { id: 6, label: '6é™', start: '14:50', end: '15:35' }
  ]
};

// è³‡è³ªãƒ»èƒ½åŠ›ã‚¹ã‚­ãƒ«å®šç¾©
const SKILL_DEFINITIONS = [
  { id: 'self_manage', label: 'è‡ªå·±ç®¡ç†', group: 'è‡ªåˆ†', color: 'primary' },
  { id: 'planning', label: 'è¨ˆç”»æ€§', group: 'è‡ªåˆ†', color: 'primary' },
  { id: 'communication', label: 'å¯¾è©±', group: 'äºº', color: 'success' },
  { id: 'collaboration', label: 'å”åŠ›', group: 'äºº', color: 'success' },
  { id: 'challenge', label: 'æŒ‘æˆ¦', group: 'èª²é¡Œ', color: 'danger' },
  { id: 'thinking', label: 'å·¥å¤«', group: 'èª²é¡Œ', color: 'danger' },
  { id: 'habit', label: 'é›†ä¸­', group: 'ç”Ÿæ´»', color: 'warning' },
  { id: 'responsibility', label: 'è²¬ä»»', group: 'ç”Ÿæ´»', color: 'warning' }
];

// ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆAIãƒ—ãƒ­ãƒ³ãƒ—ãƒˆ
const DEFAULT_AI_PROMPT = 
`ã‚ãªãŸã¯ã€å€‹åˆ¥æœ€é©ãªå­¦ã³ã¨å”åƒçš„ãªå­¦ã³ã‚’ä¸€ä½“åŒ–ã•ã›ãŸã€Œè‡ªç”±é€²åº¦å­¦ç¿’ã€ã®è¨­è¨ˆã‚¹ãƒšã‚·ãƒ£ãƒªã‚¹ãƒˆã§ã‚ã‚Šã€å­¦ç¿’æŒ‡å°è¦é ˜ã«ç²¾é€šã—ãŸãƒ™ãƒ†ãƒ©ãƒ³æ•™å¸«ã§ã™ã€‚
ãƒ¦ãƒ¼ã‚¶ãƒ¼ï¼ˆå…ˆç”Ÿï¼‰ã¨å¯¾è©±ã‚’è¡Œã„ã€æˆæ¥­å˜å…ƒã®è¨ˆç”»ã‚’ç·´ã‚Šä¸Šã’ãŸä¸Šã§ã€æœ€çµ‚çš„ã«ã‚¢ãƒ—ãƒªç”¨ã®ãƒ‡ãƒ¼ã‚¿ï¼ˆJSONï¼‰ã‚’å‡ºåŠ›ã—ã¦ãã ã•ã„ã€‚
## **â–  å¯¾è©±ã¨ç”Ÿæˆã®ãƒ—ãƒ­ã‚»ã‚¹**
### **Step 1: æƒ…å ±åé›†**
ã¾ãšã€ãƒ¦ãƒ¼ã‚¶ãƒ¼ã«ä»¥ä¸‹ã®æƒ…å ±ã‚’å°‹ã­ã¦ãã ã•ã„ã€‚
ã€Œå…ˆç”Ÿã€æˆæ¥­è¨ˆç”»ã‚’ä½œæˆã—ã¾ã™ã€‚**æ•™ç§‘ãƒ»å˜å…ƒåãƒ»å­¦å¹´ãƒ»å˜å…ƒã®ç·æ™‚æ•°** ã‚’æ•™ãˆã¦ãã ã•ã„ã€‚ã€
### **Step 2: è¨ˆç”»æ¡ˆã®æç¤º**
å…¥åŠ›ã•ã‚ŒãŸæƒ…å ±ã«åŸºã¥ãã€ä»¥ä¸‹ã®ã€Œæˆæ¥­ãƒ‡ã‚¶ã‚¤ãƒ³ã®ãƒ«ãƒ¼ãƒ«ã€ã«å¾“ã£ã¦ã€å…·ä½“çš„ãªæŒ‡å°è¨ˆç”»æ¡ˆï¼ˆã‚·ãƒ©ãƒã‚¹ï¼‰ã‚’æç¤ºã—ã¦ãã ã•ã„ã€‚
ã“ã“ã§ã¯JSONã§ã¯ãªãã€äººé–“ãŒèª­ã¿ã‚„ã™ã„ãƒ†ã‚­ã‚¹ãƒˆå½¢å¼ã§ã€ã€Œç¬¬ä½•æ™‚ã«ä½•ã‚’ã™ã‚‹ã‹ã€ã€Œã©ã‚“ãªé¸æŠèª²é¡Œã‚’ç”¨æ„ã™ã‚‹ã‹ã€ã‚’ææ¡ˆã—ã¦ãã ã•ã„ã€‚
**ææ¡ˆã®ãƒã‚¤ãƒ³ãƒˆ:**
1. **å­ä¾›ã®èˆˆå‘³é–¢å¿ƒ**: å…ç«¥ãŒãƒ¯ã‚¯ãƒ¯ã‚¯ã™ã‚‹ã‚ˆã†ãªã€Œé¸æŠèª²é¡Œï¼ˆChallengeï¼‰ã€ã®ã‚¢ã‚¤ãƒ‡ã‚¢ã‚’è¤‡æ•°ææ¡ˆã™ã‚‹ã“ã¨ã€‚  
2. **åŸºç¤ã®ä¿éšœ**: å­¦ç¿’æŒ‡å°è¦é ˜ã‚’ç¶²ç¾…ã™ã‚‹ã€Œå¿…ä¿®èª²é¡Œï¼ˆMustï¼‰ã€ã‚’é©åˆ‡ãªé †åºã§é…ç½®ã™ã‚‹ã“ã¨ã€‚  
3. **æŸ”è»Ÿæ€§**: ã‚¿ã‚¹ã‚¯æ•°ã¯æ™‚æ•°ã‚ˆã‚Šã‚‚å¤šã‚ã«ç”¨æ„ã—ã€å…ç«¥ãŒé¸ã¹ã‚‹ä½™åœ°ã‚’ä½œã‚‹ã“ã¨ã€‚
### **Step 3: ä¿®æ­£ã¨åˆæ„**
ãƒ¦ãƒ¼ã‚¶ãƒ¼ã«ã€Œã“ã®è¨ˆç”»ã§ã‚ˆã‚ã—ã„ã§ã™ã‹ï¼Ÿ ä¿®æ­£ç‚¹ãŒã‚ã‚Œã°æ•™ãˆã¦ãã ã•ã„ã€‚ã€ã¨ç¢ºèªã—ã¦ãã ã•ã„ã€‚
ä¿®æ­£æŒ‡ç¤ºãŒã‚ã‚Œã°è¨ˆç”»ã‚’ç·´ã‚Šç›´ã—ã€å†æç¤ºã—ã¦ãã ã•ã„ã€‚
### **Step 4: JSONå‡ºåŠ›**
ãƒ¦ãƒ¼ã‚¶ãƒ¼ã‹ã‚‰ã€ŒOKã€ã€Œä½œæˆã—ã¦ã€ç­‰ã®æ‰¿èªãŒå¾—ã‚‰ã‚ŒãŸã‚‰ã€**ç¢ºå®šã—ãŸè¨ˆç”»ã‚’JSONå½¢å¼ã«å¤‰æ›ã—ã€ã‚³ãƒ¼ãƒ‰ãƒ–ãƒ­ãƒƒã‚¯ã§å‡ºåŠ›**ã—ã¦ãã ã•ã„ã€‚
**ã“ã®æ®µéšã§ã¯ã€JSONãƒ‡ãƒ¼ã‚¿ä»¥å¤–ï¼ˆè§£èª¬ã‚„æŒ¨æ‹¶ãªã©ï¼‰ã¯ä¸€åˆ‡å‡ºåŠ›ã—ãªã„ã§ãã ã•ã„ã€‚**
## **â–  æˆæ¥­ãƒ‡ã‚¶ã‚¤ãƒ³ã®ãƒ«ãƒ¼ãƒ«**
### **1\. æˆæ¥­ã®æ™‚é–“æ§‹æˆï¼ˆã‚µãƒ³ãƒ‰ã‚¤ãƒƒãƒå‹ï¼‰**
* **ç¬¬1æ™‚**:  
  * å…¨ä½“ã‚’ teacher\_ledï¼ˆå…ˆç”Ÿä¸»å°ï¼‰ã¨ã—ã€å˜å…ƒã®å°å…¥ã¨å­¦ç¿’è¨ˆç”»ã®ä½œæˆï¼ˆã‚ªãƒªã‚¨ãƒ³ãƒ†ãƒ¼ã‚·ãƒ§ãƒ³ï¼‰ã‚’è¡Œã†ã€‚  
* **ç¬¬2æ™‚ä»¥é™**:  
  * ä»¥ä¸‹ã®é †åºã§æ§‹æˆã™ã‚‹ï¼ˆ45åˆ†æˆæ¥­ã®ãƒ¢ãƒ‡ãƒ«ï¼‰ã€‚  
  * **â‘  å°å…¥ï¼ˆ10åˆ†ï¼‰**: å…ˆç”Ÿä¸»å°ã®ãƒŸãƒ‹ãƒ¬ãƒƒã‚¹ãƒ³ã€‚é‡è¦ãªæ¦‚å¿µã®è§£èª¬ã‚„ã€å…¨ä½“ã¸ã®å…±æœ‰äº‹é …ã€‚ï¼ˆteacher\_led, ã‚¿ã‚¤ãƒˆãƒ«ã«ã€å°å…¥ã€‘ã¨è¨˜è¼‰ï¼‰  
  * **â‘¡ å±•é–‹ï¼ˆ30åˆ†ï¼‰**: å…ç«¥ä¸»ä½“ã®è‡ªç”±é€²åº¦å­¦ç¿’ã€‚ï¼ˆindividualï¼‰  
  * **â‘¢ çµ‚æœ«ï¼ˆ5åˆ†ï¼‰**: å…ˆç”Ÿä¸»å°ã®æŒ¯ã‚Šè¿”ã‚Šã€æ¬¡æ™‚ã®äºˆå‘Šã€‚ï¼ˆteacher\_led, ã‚¿ã‚¤ãƒˆãƒ«ã«ã€çµ‚æœ«ã€‘ã¨è¨˜è¼‰ï¼‰
### **2\. ã‚¿ã‚¹ã‚¯ï¼ˆèª²é¡Œï¼‰ã®ä½œæˆæ–¹é‡**
* **å¿…ä¿®èª²é¡Œ (must)**:  
  * ã€Œæ¨™æº–çš„ãªé€²åº¦ã€ã‚’ç¤ºã™ãŸã‚ã€æ¨å¥¨ã™ã‚‹å®Ÿæ–½å›ï¼ˆstepï¼‰ã‚’è¨­å®šã™ã‚‹ã€‚  
* **é¸æŠèª²é¡Œ (challenge)**:  
  * å…ç«¥ã®èˆˆå‘³ã«åˆã‚ã›ãŸç™ºå±•çš„ãªèª²é¡Œã‚„ã€åˆ¥ã®ã‚¢ãƒ—ãƒ­ãƒ¼ãƒã®èª²é¡Œã€‚  
  * æ¨å¥¨å›ï¼ˆstepï¼‰ã‚’è¨­å®šã—ã¦ã‚‚ã‚ˆã„ã—ã€ã„ã¤ã§ã‚‚å–ã‚Šçµ„ã‚ã‚‹ãƒ—ãƒ¼ãƒ«èª²é¡Œã¨ã—ã¦ step ã‚’ç©ºæ¬„ï¼ˆ""ï¼‰ã«ã—ã¦ã‚‚ã‚ˆã„ã€‚  
* **æ™‚é–“ã®ç²’åº¦**:  
  * è‡ªç”±é€²åº¦å­¦ç¿’ã®æ™‚é–“ã¯30åˆ†ç¢ºä¿ã•ã‚Œã¦ã„ã‚‹ãŒã€ã‚¿ã‚¹ã‚¯ã®ç›®å®‰æ™‚é–“ï¼ˆestimatedTimeï¼‰ã¯15åˆ†ã€œ45åˆ†ãªã©ã€å†…å®¹ã«å¿œã˜ã¦æŸ”è»Ÿã«è¨­å®šã™ã‚‹ï¼ˆå¿…ãšã—ã‚‚15åˆ†åˆ»ã¿ã§ãªãã¦ã‚ˆã„ï¼‰ã€‚
### **3\. ãƒ‡ãƒ¼ã‚¿å‡ºåŠ›ã®ãƒ«ãƒ¼ãƒ«ï¼ˆé‡è¦ï¼šã‚¢ãƒ—ãƒªã®ä»•æ§˜å¯¾å¿œï¼‰**
ã‚¢ãƒ—ãƒªå´ã§æ­£ã—ãè¡¨ç¤ºã•ã›ã‚‹ãŸã‚ã€JSONã® tasks é…åˆ—ã‚’å‡ºåŠ›ã™ã‚‹éš›ã¯ã€\*\*åŒä¸€Stepå†…ã§ä»¥ä¸‹ã®é †åºã«ãªã‚‹ã‚ˆã†ã«å¿…ãšã‚½ãƒ¼ãƒˆï¼ˆä¸¦ã¹æ›¿ãˆï¼‰\*\*ã—ã¦å‡ºåŠ›ã™ã‚‹ã“ã¨ã€‚
1. **å…ˆé ­**: teacher\_led ã‹ã¤ ã‚¿ã‚¤ãƒˆãƒ«ã«ã€å°å…¥ã€‘ã‚’å«ã‚€ã‚¿ã‚¹ã‚¯  
2. **ä¸­é–“**: individual ãªã‚¿ã‚¹ã‚¯ï¼ˆå¿…ä¿®ãƒ»é¸æŠï¼‰  
3. **æœ€å¾Œ**: teacher\_led ã‹ã¤ ã‚¿ã‚¤ãƒˆãƒ«ã«ã€çµ‚æœ«ã€‘ã‚’å«ã‚€ã‚¿ã‚¹ã‚¯
## **â–  å‡ºåŠ›JSONãƒ•ã‚©ãƒ¼ãƒãƒƒãƒˆï¼ˆå³å®ˆï¼‰**
{  
  "unitInfo": {  
    "subject": "æ•™ç§‘å",  
    "grade": å­¦å¹´(æ•°å€¤),  
    "unitName": "å˜å…ƒå",  
    "totalHours": ç·æ™‚æ•°(æ•°å€¤),  
    "goal": "å­ä¾›å‘ã‘ã®å˜å…ƒç›®æ¨™",  
    "description": "å˜å…ƒã®æ¦‚è¦"  
  },  

  "tasks": \[  
    {  
      "id": "ä¸€æ„ã®ID (ä¾‹: t\_01, t\_02...)",  
      "category": "ã¤ã‹ã‚€ / ã¾ãªã¶ / ãµã‹ã‚ã‚‹ / ã¾ã¨ã‚ã‚‹",  
      "type": "must (å¿…ä¿®) / challenge (é¸æŠ)",  
      "format": "student (å€‹åˆ¥) / teacher (å…ˆç”Ÿä¸»å°)",  
      "step": "Step 1 (1æ™‚é–“ç›®ã«å›ºå®šã™ã‚‹å ´åˆ) / Step 2 ... / (ç©ºæ¬„ãªã‚‰è‡ªç”±é…ç½®)",  
      "title": "ã‚¿ã‚¹ã‚¯å (å…ˆç”Ÿä¸»å°ã®å ´åˆã¯ã€å°å…¥ã€‘ã€çµ‚æœ«ã€‘ãªã©ã‚’ä»˜è¨˜)",  
      "description": "å†…å®¹ã®èª¬æ˜",  
      "estimatedTime": ç›®å®‰æ™‚é–“(åˆ†ãƒ»æ•°å€¤),  
      "prerequisites": \["å‰æã‚¿ã‚¹ã‚¯ID"\] // ãªã‘ã‚Œã° \[\]  
    }  
  \] 
}`;

// ã‚¢ãƒ—ãƒªã®çŠ¶æ…‹ç®¡ç†
let appState = {
  mode: 'student', // å¸¸ã«studentã§é–‹å§‹
  user: {
    name: "",
    classId: ""
  },
  view: {
    student: 'daily',
    teacher: 'cards', // cards, heatmap, seating, summaries, design, control
    teacherClassId: 'All'
  },
  sound: { enabled: true, unlocked: false, prevSosCount: 0 },
  unit: { id: "", title: "", totalHours: 8, currentHour: 1 },
  unitList: [],
  schedules: []
};

// ãƒ‡ãƒ¼ã‚¿ã‚¹ãƒˆã‚¢
let dataStore = {
  masterTasks: [], 
  myTasks: [], 
  clsMyTasks: {},
  liveStatus: [], 
  clsProgress: {}, 
  clsFeedback: {},
  clsPlans: {}, 
  clsReflections: {},
  studentProgress: {}, 
  studentFeedback: {}, 
  studentPlan: {}, 
  portfolioData: {},
  studentReflections: {},
  clsPortfolios: {},
  classList: [],
  roster: []
};

let computedState = { todaysPlanIds: new Set() };
let autoRefreshTimer = null;
let ssUrl = "";
let dragSrcEl = null;
let isDraggingSeat = false;

// ã‚¿ã‚¤ãƒãƒ¼ã®çŠ¶æ…‹
let myTimer = {
  interval: null,
  seconds: 0,
  isActive: false,
  mode: 'up',
  target: 0
};

// ==========================================
//  2. åˆæœŸåŒ–ãƒ—ãƒ­ã‚»ã‚¹ (Initialization)
// ==========================================

window.onload = function() {
  if (typeof google === 'undefined' || typeof google.script === 'undefined') {
    console.warn('Google Script API not found.');
    return;
  }

  google.script.run
    .withSuccessHandler(handleInitialResponse)
    .withFailureHandler(handleError)
    .getAppInitialData();
};

function handleInitialResponse(res) {
  if (!res.success) { handleError({ message: res.error }); return; }
  ssUrl = res.ssUrl;

  const btnSs = document.getElementById('btn-view-ss');
  if (btnSs && ssUrl) btnSs.onclick = () => window.open(ssUrl, '_blank');

  if (!res.isInitialized) {
    renderSetupOverlay();
  } else {
    loadMainData();
  }
}

function loadMainData() {
  const container = document.getElementById('app-container');
  if (!container.hasChildNodes() || container.innerHTML === '') showLoading();
  
  google.script.run
    .withSuccessHandler(res => {
      if (res.success) {
        updateDataStore(res.json);
        renderUnitSelector();
        renderApp();
        hideLoading();
        
        if (appState.mode === 'student') {
          renderMyTimer();
          checkScheduleAndNotify();
          unlockAudio(); 
        }
      } else { handleError({ message: res.error }); }
    })
    .withFailureHandler(handleError)
    .getData();
}

function renderSetupOverlay() {
  const container = document.getElementById('app-container');
  container.innerHTML = `
    <div class="d-flex flex-column justify-content-center align-items-center vh-100 text-center">
      <div class="card p-5 shadow-lg border-0 rounded-4" style="max-width: 600px;">
        <h1 class="text-primary mb-4 fw-bold"><i class="bi bi-compass me-2"></i>ã‚ˆã†ã“ã</h1>
        <div class="text-start bg-light p-4 rounded-3 mb-4">
          <p class="mb-3">ã€Œã¿ã‚‰ã„ã‚³ãƒ³ãƒ‘ã‚¹ã€ã¯ã€å­ã©ã‚‚ãŸã¡ãŒä¸»ä½“çš„ã«å­¦ã¶ã€Œè‡ªç”±é€²åº¦å­¦ç¿’ã€ã‚’ã‚µãƒãƒ¼ãƒˆã™ã‚‹Webã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³ã§ã™ã€‚</p>
          <p class="mb-0">è‡ªåˆ†ã§è¨ˆç”»ã‚’ç«‹ã¦ã€å­¦ç¿’ã‚’é€²ã‚ã€æŒ¯ã‚Šè¿”ã‚‹ã“ã¨ã§ã€è‡ªã‚‰å­¦ã¶åŠ›ã‚’è‚²ã¿ã¾ã™ã€‚å…ˆç”Ÿã¯ãƒªã‚¢ãƒ«ã‚¿ã‚¤ãƒ ã§å­ã©ã‚‚ãŸã¡ã®çŠ¶æ³ã‚’è¦‹å®ˆã‚Šã€ä¸€äººã²ã¨ã‚Šã«å¯„ã‚Šæ·»ã£ãŸã‚µãƒãƒ¼ãƒˆãŒå¯èƒ½ã«ãªã‚Šã¾ã™ã€‚</p>
        </div>
        <div class="alert alert-warning mb-4" role="alert">
          <div class="fw-bold mb-1">ã€é‡è¦ã€‘å…ˆç”Ÿç”¨ç®¡ç†ç”»é¢ã®åˆæœŸãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰</div>
          <div class="display-6 fw-bold text-danger" style="letter-spacing: 2px;">admin</div>
          <small class="text-muted">â€»ã‚»ãƒƒãƒˆã‚¢ãƒƒãƒ—å®Œäº†å¾Œã€å…ˆç”Ÿç”¨ãƒ¡ãƒ‹ãƒ¥ãƒ¼ã‹ã‚‰å¤‰æ›´ã—ã¦ãã ã•ã„ã€‚</small>
        </div>
        <p class="text-muted mb-4 small">ä¸‹ã®ãƒœã‚¿ãƒ³ã‚’æŠ¼ã™ã¨ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹(ã‚¹ãƒ—ãƒ¬ãƒƒãƒ‰ã‚·ãƒ¼ãƒˆ)ã‚’è‡ªå‹•ä½œæˆã—ã€ã™ãã«åˆ©ç”¨ã‚’é–‹å§‹ã§ãã¾ã™ã€‚</p>
        <button class="btn btn-primary btn-lg rounded-pill px-5 shadow-sm" onclick="startInitialization()">åˆæœŸè¨­å®šã‚’é–‹å§‹ã™ã‚‹</button>
      </div>
    </div>`;
  hideLoading();
}

function startInitialization() {
  showLoading();
  google.script.run
    .withSuccessHandler(r => {
      if (r.success) {
        Swal.fire('åˆæœŸåŒ–å®Œäº†', 'åˆæœŸãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ã¯ admin ã§ã™', 'success');
        loadMainData();
      } else handleError({ message: r.error });
    })
    .withFailureHandler(handleError)
    .initSystem();
}

function startAutoRefresh() {
  if (autoRefreshTimer) clearInterval(autoRefreshTimer);
  autoRefreshTimer = setInterval(() => {
    google.script.run
      .withSuccessHandler(res => {
        if (res.success) {
          updateDataStore(res.json);
          if (appState.mode === 'teacher' && document.getElementById('t-area')) {
            if (appState.view.teacher !== 'seating' || !isDraggingSeat) {
              renderTeacherDashboardContent();
            }
            checkSosAndPlaySound();
          } 
          else if (appState.mode === 'student') {
            checkScheduleAndNotify();
          }
        }
      })
      .withFailureHandler(e => console.error("AutoRefresh Failed", e))
      .getData();
  }, CONSTANTS.REFRESH_INTERVAL);
}

function updateDataStore(jsonStr) {
  const d = JSON.parse(jsonStr);
  dataStore.masterTasks = d.unit || [];
  dataStore.liveStatus = d.live || [];
  dataStore.clsProgress = d.progress || {};
  dataStore.clsFeedback = d.feedback || {};
  dataStore.clsMyTasks = d.myTasks || {};
  dataStore.clsPlans = d.plans || {};
  dataStore.clsReflections = d.dailyReflections || {};
  dataStore.clsPortfolios = d.portfolios || {};
  dataStore.roster = d.roster || [];
  appState.schedules = d.schedules || [];

  const unitsMap = new Map();
  dataStore.masterTasks.forEach(t => {
    if (t.unitId && !unitsMap.has(t.unitId)) {
      const uInfo = t.unitInfo || {};
      unitsMap.set(t.unitId, {
        id: t.unitId,
        title: uInfo.title || 'ç„¡é¡Œã®å˜å…ƒ',
        subject: uInfo.subject || '',
        totalHours: Number(t.totalHours) || 8,
        grade: uInfo.grade || '',
        goal: uInfo.goal || '',
        description: uInfo.description || ''
      });
    }
  });
  appState.unitList = Array.from(unitsMap.values()).sort((a, b) => b.id.localeCompare(a.id));

  if (appState.unitList.length > 0 && !appState.unit.id) {
    const savedId = localStorage.getItem(CONSTANTS.LS_KEY_UNIT);
    const target = appState.unitList.find(u => u.id === savedId) || appState.unitList[0];
    appState.unit.id = target.id;
    appState.unit.title = target.title;
    appState.unit.totalHours = target.totalHours;
  } else if (appState.unitList.length === 0) {
    appState.unit.id = "";
    appState.unit.title = "å˜å…ƒãƒ‡ãƒ¼ã‚¿ãªã—";
  }

  const classes = new Set();
  dataStore.liveStatus.forEach(s => { if(s.classId) classes.add(s.classId); });
  dataStore.roster.forEach(r => { if(r.classId) classes.add(r.classId); });
  if(classes.size === 0) classes.add('1çµ„');
  dataStore.classList = Array.from(classes).sort();
}

function changeUnit(unitId) {
  const target = appState.unitList.find(u => u.id === unitId);
  if (target) {
    appState.unit.id = target.id;
    appState.unit.title = target.title;
    appState.unit.totalHours = target.totalHours;
    localStorage.setItem(CONSTANTS.LS_KEY_UNIT, unitId);
    
    if(appState.mode === 'student' && appState.user.name) {
      syncStudentPlan();
      renderStudentView();
      loginStudent(true); 
      submitUserStatus(getSelfStatusMode()); 
    } else if (appState.mode === 'teacher') {
      renderTeacherView();
    }
  }
}

function getSelfStatusMode() {
  const me = dataStore.liveStatus.find(s => s.name === appState.user.name);
  return me ? me.mode : 'é€šå¸¸';
}

function getCurrentUnitTasks() {
  return dataStore.masterTasks.filter(t => t.unitId === appState.unit.id);
}

function checkScheduleAndNotify() {
  if (!appState.user.classId || appState.schedules.length === 0) return;
  
  const now = new Date();
  const dateStr = now.getFullYear() + "-" + ('0' + (now.getMonth() + 1)).slice(-2) + "-" + ('0' + now.getDate()).slice(-2);
  const timeStr = ('0' + now.getHours()).slice(-2) + ":" + ('0' + now.getMinutes()).slice(-2);
  
  const currentSchedule = appState.schedules.find(s => 
    s.classId === appState.user.classId && 
    s.date === dateStr &&
    s.startTime <= timeStr && s.endTime >= timeStr
  );

  let notifyBar = document.getElementById('schedule-notify-bar');
  
  if (currentSchedule) {
    const unit = appState.unitList.find(u => u.id === currentSchedule.unitId);
    const unitTitle = unit ? unit.title : "ä¸æ˜ãªå˜å…ƒ";
    const msg = currentSchedule.message || `ãŸã ä»Šã®æˆæ¥­ï¼š${unitTitle} ç¬¬${currentSchedule.hour}æ™‚`;
    
    if (!notifyBar) {
      notifyBar = document.createElement('div');
      notifyBar.id = 'schedule-notify-bar';
      notifyBar.className = 'bg-info text-white text-center py-2 px-3 shadow-sm cursor-pointer animate__animated animate__fadeInDown';
      notifyBar.style.position = 'fixed';
      notifyBar.style.top = '60px'; 
      notifyBar.style.left = '0';
      notifyBar.style.right = '0';
      notifyBar.style.zIndex = '1020';
      notifyBar.innerHTML = `<i class="bi bi-broadcast me-2"></i><span class="fw-bold">${msg}</span> <small class="ms-2 border rounded-pill px-2">ç§»å‹•ã™ã‚‹</small>`;
      notifyBar.onclick = () => {
        if(unit) {
          changeUnit(unit.id);
          changeCurrentHour(currentSchedule.hour);
          if(currentSchedule.message) Swal.fire({ title: 'å…ˆç”Ÿã‹ã‚‰ã®ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸', text: currentSchedule.message, icon: 'info' });
        }
      };
      document.body.appendChild(notifyBar);
    } else {
      notifyBar.querySelector('span').innerHTML = `<i class="bi bi-broadcast me-2"></i><span class="fw-bold">${msg}</span> <small class="ms-2 border rounded-pill px-2">ç§»å‹•ã™ã‚‹</small>`;
    }
  } else {
    if (notifyBar) notifyBar.remove();
  }
}

// ==========================================
//  3. æç”»ãƒ‡ã‚£ã‚¹ãƒ‘ãƒƒãƒãƒ£
// ==========================================

function renderUnitSelector() {
  const options = appState.unitList.map(u => 
    `<option value="${u.id}" ${u.id === appState.unit.id ? 'selected' : ''}>${u.subject ? 'ã€'+u.subject+'ã€‘' : ''} ${u.title}</option>`
  ).join('');
  
  const html = `
    <div class="input-group input-group-sm">
      <span class="input-group-text bg-white border-end-0 text-primary"><i class="bi bi-book-half"></i></span>
      <select class="form-select border-start-0 fw-bold text-primary bg-light" onchange="changeUnit(this.value)" style="box-shadow:none; max-width: 200px;">
        ${options.length > 0 ? options : '<option>å˜å…ƒãªã—</option>'}
      </select>
      <button class="btn btn-outline-secondary border-start-0" type="button" onclick="showUnitInfoModal()" title="å˜å…ƒã®è©³ç´°">
        <i class="bi bi-info-circle"></i>
      </button>
    </div>
  `;
  
  const c1 = document.getElementById('unit-selector-container');
  const c2 = document.getElementById('unit-selector-mobile');
  if(c1) c1.innerHTML = html;
  if(c2) c2.innerHTML = html;
}

function renderApp() {
  try {
    const container = document.getElementById('app-container');
    const settingsBtn = document.getElementById('btn-settings');
    const exitBtn = document.getElementById('btn-exit-teacher');
    const mainEl = document.querySelector('main');
    
    if (appState.mode === 'teacher') {
      mainEl.classList.add('teacher-mode');
      settingsBtn.classList.remove('d-none'); 
      exitBtn.classList.remove('d-none');     
      renderTeacherView();
    } else {
      mainEl.classList.remove('teacher-mode');
      settingsBtn.classList.add('d-none'); 
      exitBtn.classList.add('d-none'); 
      const savedName = localStorage.getItem(CONSTANTS.LS_KEY_NAME);
      const savedClass = localStorage.getItem(CONSTANTS.LS_KEY_CLASS);
      
      if (!appState.user.name && savedName) {
        appState.user.name = savedName;
        appState.user.classId = savedClass || "1çµ„";
        loginStudent(true);
      } else if (!appState.user.name) {
        renderNameEntry();
      } else {
        syncStudentPlan();
        renderStudentView();
      }
    }
  } catch (e) {
    console.error(e);
    handleError({ message: "æç”»ã‚¨ãƒ©ãƒ¼: " + e.message });
  }
}

function switchMode(newMode) {
  appState.mode = newMode;
  renderApp();
  if(newMode === 'student') {
    startAutoRefresh(); 
  }
}

// ==========================================
//  4. å…ç«¥ãƒ¢ãƒ¼ãƒ‰ãƒ­ã‚¸ãƒƒã‚¯
// ==========================================

function renderNameEntry() {
  let classOptions = '';
  if (dataStore.classList.length > 0) {
     classOptions = dataStore.classList.map(c => `<option value="${c}">${c}</option>`).join('');
  } else {
     classOptions = '<option value="1çµ„">1çµ„</option><option value="2çµ„">2çµ„</option>';
  }

  document.getElementById('app-container').innerHTML = `
    <div class="row justify-content-center animate__animated animate__fadeIn">
      <div class="col-md-6">
        <div class="card shadow-sm p-5 text-center border-0 rounded-4">
          <h4 class="fw-bold mb-4"><ruby>å§‹<rt>ã¯ã˜</rt></ruby>ã‚ã‚‹</h4>
          <div class="mb-3">
             <label class="form-label small text-muted">ã‚¯ãƒ©ã‚¹</label>
             <select id="input-class" class="form-select form-select-lg text-center rounded-pill border-0 bg-light" onchange="updateNameSelect()">
               ${classOptions}
             </select>
          </div>
          <div class="mb-4">
             <label class="form-label small text-muted">ãªã¾ãˆ</label>
             <div id="name-input-container">
               <input type="text" id="input-name" class="form-control form-control-lg text-center rounded-pill border-0 bg-light" placeholder="ä¾‹ï¼šã‚„ã¾ã  ãŸã‚ã†">
             </div>
          </div>
          <div class="form-check mb-4 d-inline-block">
            <input class="form-check-input" type="checkbox" id="rm-me" checked>
            <label class="form-check-label small" for="rm-me"><ruby>æƒ…å ±<rt>ã˜ã‚‡ã†ã»ã†</rt></ruby>ã‚’<ruby>ä¿å­˜<rt>ã»ãã‚“</rt></ruby>ã™ã‚‹</label>
          </div>
          <button class="btn btn-primary btn-lg w-100 rounded-pill shadow-sm" onclick="handleLoginClick()">ã‚¹ã‚¿ãƒ¼ãƒˆ</button>
        </div>
      </div>
    </div>`;
    
    updateNameSelect();
}

function updateNameSelect() {
  const classVal = document.getElementById('input-class').value;
  const container = document.getElementById('name-input-container');
  const students = dataStore.roster.filter(r => r.classId === classVal).sort((a,b) => a.number - b.number);

  if (students.length > 0) {
    const options = students.map(s => `<option value="${s.name}">${s.name}</option>`).join('');
    container.innerHTML = `
      <select id="input-name" class="form-select form-select-lg text-center rounded-pill border-0 bg-light">
        <option value="" disabled selected>åå‰ã‚’ãˆã‚‰ã‚“ã§ã­</option>
        ${options}
      </select>`;
  } else {
    container.innerHTML = `<input type="text" id="input-name" class="form-control form-control-lg text-center rounded-pill border-0 bg-light" placeholder="ä¾‹ï¼šã‚„ã¾ã  ãŸã‚ã†">`;
  }
}

function handleLoginClick() {
  const nameInput = document.getElementById('input-name');
  const classInput = document.getElementById('input-class');
  const remember = document.getElementById('rm-me').checked;
  const name = nameInput.value.trim();
  const cls = classInput.value;
  
  if (!name) return;
  
  if (remember) {
    localStorage.setItem(CONSTANTS.LS_KEY_NAME, name);
    localStorage.setItem(CONSTANTS.LS_KEY_CLASS, cls);
  } else {
    localStorage.removeItem(CONSTANTS.LS_KEY_NAME);
    localStorage.removeItem(CONSTANTS.LS_KEY_CLASS);
  }
  
  appState.user.name = name;
  appState.user.classId = cls;
  loginStudent(false);
}

function loginStudent(isAuto) {
  if (!isAuto) showLoading();
  google.script.run
    .withSuccessHandler(res => {
      if (res.success) {
        const d = JSON.parse(res.json);
        dataStore.studentProgress = d.progress || {};
        dataStore.studentFeedback = d.feedback || {};
        dataStore.myTasks = d.myTasks || [];
        dataStore.portfolioData = d.portfolio || { summary: '' };
        dataStore.studentReflections = d.reflections?.[appState.unit.id] || {};
        
        if (d.plans && d.plans[appState.unit.id]) {
           dataStore.clsPlans[appState.user.name] = { [appState.unit.id]: d.plans[appState.unit.id] };
        }
        syncStudentPlan();
        renderStudentView();
        if (!isAuto) hideLoading();
        renderMyTimer();
        checkScheduleAndNotify();
        unlockAudio(); 
      }
    })
    .withFailureHandler(handleError)
    .getStudentProgress(appState.user.name, appState.user.classId, appState.unit.id);
}

// ---------------- ã‚¿ã‚¤ãƒãƒ¼æ©Ÿèƒ½ ----------------

function renderMyTimer() {
  if (document.getElementById('my-timer-widget')) return;
  
  const timerHtml = `
    <div id="my-timer-widget" class="card shadow rounded-4 bg-white" style="position:fixed; bottom:20px; right:20px; width:180px; z-index:1050; border:1px solid #ddd;">
      <div class="card-header bg-light border-0 py-1 d-flex justify-content-between align-items-center" style="cursor:move;" onmousedown="dragElement(document.getElementById('my-timer-widget'))">
        <small class="fw-bold text-muted"><i class="bi bi-clock me-1"></i>Timer</small>
        <button type="button" class="btn-close btn-close-sm" aria-label="Close" onclick="document.getElementById('my-timer-widget').classList.toggle('d-none')"></button>
      </div>
      <div class="card-body p-2 text-center">
        <div class="display-5 fw-bold mb-2" id="timer-display" style="font-family:monospace;">00:00</div>
        <div class="btn-group btn-group-sm w-100 mb-2">
          <button class="btn btn-outline-secondary" onclick="setTimerMode('up')">UP</button>
          <button class="btn btn-outline-secondary" onclick="setTimerMode('down')">DOWN</button>
        </div>
        <div class="input-group input-group-sm mb-2" id="timer-input-group" style="display:none;">
          <input type="number" id="timer-input-min" class="form-control" placeholder="åˆ†" min="1" max="60">
          <button class="btn btn-primary" onclick="setTimerTime()">è¨­å®š</button>
        </div>
        <div class="d-flex justify-content-between">
          <button class="btn btn-primary btn-sm rounded-pill px-3" onclick="toggleTimer()" id="timer-btn-toggle"><ruby>é–‹å§‹<rt>ã‹ã„ã—</rt></ruby></button>
          <button class="btn btn-outline-secondary btn-sm rounded-pill" onclick="resetTimer()">ãƒªã‚»ãƒƒãƒˆ</button>
        </div>
      </div>
    </div>
    <button id="timer-launcher" class="btn btn-primary rounded-circle shadow" style="position:fixed; bottom:20px; right:20px; width:50px; height:50px; z-index:1040;" onclick="document.getElementById('my-timer-widget').classList.remove('d-none');">
      <i class="bi bi-stopwatch fs-4"></i>
    </button>
  `;
  document.body.insertAdjacentHTML('beforeend', timerHtml);
}

function setTimerMode(mode) {
  myTimer.mode = mode;
  document.getElementById('timer-input-group').style.display = (mode === 'down' && !myTimer.isActive) ? 'flex' : 'none';
  resetTimer();
}

function setTimerTime() {
  const min = parseInt(document.getElementById('timer-input-min').value);
  if (min > 0) {
    myTimer.seconds = min * 60;
    updateTimerDisplay();
    document.getElementById('timer-input-group').style.display = 'none';
  }
}

function toggleTimer() {
  if (myTimer.isActive) {
    clearInterval(myTimer.interval);
    myTimer.isActive = false;
    document.getElementById('timer-btn-toggle').innerHTML = '<ruby>å†é–‹<rt>ã•ã„ã‹ã„</rt></ruby>';
    document.getElementById('timer-btn-toggle').className = 'btn btn-primary btn-sm rounded-pill px-3';
  } else {
    if (myTimer.mode === 'down' && myTimer.seconds === 0) return;
    myTimer.isActive = true;
    document.getElementById('timer-btn-toggle').innerHTML = '<ruby>åœæ­¢<rt>ã¦ã„ã—</rt></ruby>';
    document.getElementById('timer-btn-toggle').className = 'btn btn-danger btn-sm rounded-pill px-3';
    
    myTimer.interval = setInterval(() => {
      if (myTimer.mode === 'up') {
        myTimer.seconds++;
      } else {
        myTimer.seconds--;
        if (myTimer.seconds <= 0) {
          clearInterval(myTimer.interval);
          myTimer.isActive = false;
          myTimer.seconds = 0;
          document.getElementById('timer-btn-toggle').innerHTML = '<ruby>é–‹å§‹<rt>ã‹ã„ã—</rt></ruby>';
          document.getElementById('timer-btn-toggle').className = 'btn btn-primary btn-sm rounded-pill px-3';
          showToast('info', 'æ™‚é–“ã§ã™ï¼');
        }
      }
      updateTimerDisplay();
    }, 1000);
  }
}

function resetTimer() {
  clearInterval(myTimer.interval);
  myTimer.isActive = false;
  myTimer.seconds = 0;
  updateTimerDisplay();
  document.getElementById('timer-btn-toggle').innerHTML = '<ruby>é–‹å§‹<rt>ã‹ã„ã—</rt></ruby>';
  document.getElementById('timer-btn-toggle').className = 'btn btn-primary btn-sm rounded-pill px-3';
  if(myTimer.mode === 'down') document.getElementById('timer-input-group').style.display = 'flex';
}

function updateTimerDisplay() {
  const m = Math.floor(myTimer.seconds / 60);
  const s = myTimer.seconds % 60;
  document.getElementById('timer-display').textContent = `${('0'+m).slice(-2)}:${('0'+s).slice(-2)}`;
}

function dragElement(elmnt) {
  let pos1 = 0, pos2 = 0, pos3 = 0, pos4 = 0;
  elmnt.onmousedown = dragMouseDown;

  function dragMouseDown(e) {
    e = e || window.event;
    pos3 = e.clientX;
    pos4 = e.clientY;
    document.onmouseup = closeDragElement;
    document.onmousemove = elementDrag;
  }

  function elementDrag(e) {
    e = e || window.event;
    e.preventDefault();
    pos1 = pos3 - e.clientX;
    pos2 = pos4 - e.clientY;
    pos3 = e.clientX;
    pos4 = e.clientY;
    elmnt.style.top = (elmnt.offsetTop - pos2) + "px";
    elmnt.style.left = (elmnt.offsetLeft - pos1) + "px";
  }

  function closeDragElement() {
    document.onmouseup = null;
    document.onmousemove = null;
  }
}

// ------------------------------------------

function submitTaskProgress(taskId, status, btnElement) {
  if (status === 'å®Œäº†') {
    btnElement.className = "btn btn-secondary rounded-pill px-4 btn-sm fw-bold animate__animated animate__heartBeat";
    btnElement.innerHTML = `<i class="bi bi-check-circle-fill me-1"></i><ruby>å®Œäº†<rt>ã‹ã‚“ã‚Šã‚‡ã†</rt></ruby>`; 
    btnElement.disabled = true;
  }
  if (!dataStore.studentProgress[taskId]) dataStore.studentProgress[taskId] = {};
  dataStore.studentProgress[taskId].status = status;
  
  const allTasks = [...dataStore.masterTasks, ...dataStore.myTasks];
  const t = allTasks.find(x => x.taskId === taskId);
  const mem = dataStore.studentProgress[taskId].reflection || "";
  
  google.script.run
    .withFailureHandler(err => console.error(err))
    .updateStatus(appState.user.name, t.taskId, t.title, status, 'é€šå¸¸', mem, appState.user.classId, appState.unit.id);
  
  if (status === 'é€”ä¸­') showToast('info', 'é€”ä¸­çµŒéã‚’ä¿å­˜ã—ã¾ã—ãŸ');
  if (status === 'å®Œäº†') setTimeout(renderStudentView, 1000);
}

function submitUserStatus(mode) {
  const idx = dataStore.liveStatus.findIndex(d => d.name === appState.user.name);
  if (idx >= 0) {
    dataStore.liveStatus[idx].mode = (mode === 'é€šå¸¸' ? '' : mode);
    dataStore.liveStatus[idx].classId = appState.user.classId;
    dataStore.liveStatus[idx].currentUnitId = appState.unit.id;
  }
  renderStudentView();
  
  let msg = "ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹è§£é™¤"; let icon = "success";
  if (mode === 'ãŸã™ã‘ã¦') { msg = "SOSé€ä¿¡ï¼"; icon = "warning"; }
  else if (mode === 'ã—ã‚…ã†ã¡ã‚…ã†') { msg = "é›†ä¸­ãƒ¢ãƒ¼ãƒ‰é–‹å§‹"; icon = "info"; }
  if (mode !== 'é€šå¸¸' && mode !== '') showToast(icon, msg);
  
  google.script.run
    .withFailureHandler(err => console.error(err))
    .updateStatus(appState.user.name, 'st_upd', 'ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹', 'æ›´æ–°', mode, '', appState.user.classId, appState.unit.id);
}

function savePlan() {
  google.script.run
    .withFailureHandler(handleError)
    .saveStudentPlan(appState.user.name, appState.unit.id, dataStore.studentPlan, appState.user.classId);
}

function openDailyReflectionModal(targetHour = null) {
  const hourToEdit = targetHour || appState.unit.currentHour;
  let ref = { achievement: 'A', comment: '', skills: [] };
  
  if (dataStore.studentReflections && dataStore.studentReflections[hourToEdit]) {
    ref = dataStore.studentReflections[hourToEdit];
  } else if (dataStore.clsReflections[appState.user.name]?.[appState.unit.id]?.[hourToEdit]) {
     ref = dataStore.clsReflections[appState.user.name][appState.unit.id][hourToEdit];
  }

  const skillButtons = SKILL_DEFINITIONS.map(s => {
    const isChecked = ref.skills && ref.skills.includes(s.id);
    return `
      <div class="col-3 col-md-3 mb-2">
        <input type="checkbox" class="btn-check skill-check" id="skill-${s.id}" value="${s.id}" ${isChecked ? 'checked' : ''}>
        <label class="btn btn-outline-${s.color} w-100 rounded-pill btn-sm py-2" for="skill-${s.id}">
          <div class="small fw-light" style="font-size:0.7rem">${s.group}</div>
          <div class="fw-bold">${s.label}</div>
        </label>
      </div>`;
  }).join('');

  Swal.fire({
    title: `<div class="fs-4 fw-bold">ç¬¬${hourToEdit}æ™‚ã®ãµã‚Šã‹ãˆã‚Š</div>`,
    html: `
      <div class="text-start">
        <div class="mb-4">
          <label class="form-label small fw-bold text-muted"><ruby>é”æˆåº¦<rt>ãŸã£ã›ã„ã©</rt></ruby></label>
          <div class="btn-group w-100" role="group">
            <input type="radio" class="btn-check" name="ach-btn" id="ach-a" value="A" ${ref.achievement==='A'?'checked':''}>
            <label class="btn btn-outline-primary" for="ach-a">â— <ruby>è¨ˆç”»<rt>ã‘ã„ã‹ã</rt></ruby>é€šã‚Š</label>
            <input type="radio" class="btn-check" name="ach-btn" id="ach-b" value="B" ${ref.achievement==='B'?'checked':''}>
            <label class="btn btn-outline-primary" for="ach-b">ã€‡ ã¾ã‚ã¾ã‚</label>
            <input type="radio" class="btn-check" name="ach-btn" id="ach-c" value="C" ${ref.achievement==='C'?'checked':''}>
            <label class="btn btn-outline-primary" for="ach-c">â–³ ã‚ã¾ã‚Š</label>
          </div>
        </div>

        <div class="mb-4">
          <label class="form-label small fw-bold text-muted">ä»Šæ—¥<ruby>ç™ºæ®<rt>ã¯ã£ã</rt></ruby>ã—ãŸ<ruby>åŠ›<rt>ã¡ã‹ã‚‰</rt></ruby>ï¼ˆè¤‡æ•°é¸æŠå¯ï¼‰</label>
          <div class="row gx-2">
            ${skillButtons}
          </div>
        </div>

        <div>
          <label class="form-label small fw-bold text-muted">ã²ã¨ã“ã¨ã‚³ãƒ¡ãƒ³ãƒˆ</label>
          <textarea id="rf-com" class="form-control bg-light border-0" rows="3" placeholder="ã‚ã‹ã£ãŸã“ã¨ã€æ¬¡ãŒã‚“ã°ã‚ŠãŸã„ã“ã¨">${ref.comment||''}</textarea>
        </div>
      </div>
    `,
    width: '600px',
    showCancelButton: true,
    confirmButtonText: 'è¨˜éŒ²ã™ã‚‹',
    confirmButtonColor: '#1a73e8',
    customClass: { popup: 'rounded-5' },
    preConfirm: () => {
      const achEl = document.querySelector('input[name="ach-btn"]:checked');
      if (!achEl) { Swal.showValidationMessage('é”æˆåº¦ã‚’é¸æŠã—ã¦ãã ã•ã„'); return false; }
      
      const skills = Array.from(document.querySelectorAll('.skill-check:checked')).map(el => el.value);
      return {
        achievement: achEl.value,
        comment: document.getElementById('rf-com').value,
        skills: skills
      };
    }
  }).then(r => {
    if (r.isConfirmed) {
      const v = r.value;
      if(!dataStore.studentReflections) dataStore.studentReflections = {};
      dataStore.studentReflections[hourToEdit] = v;

      google.script.run.saveDailyReflection(appState.user.name, appState.unit.id, hourToEdit, v.achievement, v.comment, appState.user.classId, v.skills);
      showToast('success', 'ãµã‚Šã‹ãˆã‚Šã‚’è¨˜éŒ²ã—ã¾ã—ãŸ');
      renderStudentView();
    }
  });
}

function renderPortfolioModal(name, isTeacherMode = false) {
  let reflections = {};
  let summary = "";
  let feedback = "";
  let stamp = "";

  if (isTeacherMode) {
    if (dataStore.clsReflections[name] && dataStore.clsReflections[name][appState.unit.id]) {
      reflections = dataStore.clsReflections[name][appState.unit.id];
    }
    const pf = (dataStore.clsPortfolios && dataStore.clsPortfolios[name] && dataStore.clsPortfolios[name][appState.unit.id]);
    if(pf) {
      summary = pf.summary || (typeof pf === 'string' ? pf : "");
      feedback = pf.feedback || "";
      stamp = pf.stamp || "";
    }
  } else {
    reflections = dataStore.studentReflections || {};
    summary = dataStore.portfolioData ? dataStore.portfolioData.summary : "";
    feedback = dataStore.portfolioData ? dataStore.portfolioData.feedback : "";
    stamp = dataStore.portfolioData ? dataStore.portfolioData.stamp : "";
  }

  const skillCounts = {};
  SKILL_DEFINITIONS.forEach(s => skillCounts[s.id] = 0);
  Object.values(reflections).forEach(r => {
    if (r.skills && Array.isArray(r.skills)) {
      r.skills.forEach(sId => {
        if (skillCounts[sId] !== undefined) skillCounts[sId]++;
      });
    }
  });

  const chartLabels = SKILL_DEFINITIONS.map(s => s.label);
  const chartData = SKILL_DEFINITIONS.map(s => skillCounts[s.id]);
  const maxVal = Math.max(5, ...chartData) + 1;

  let timelineHtml = '<div class="timeline-wrapper ps-2 border-start border-3 ms-3">';
  const sortedHours = Object.keys(reflections).map(Number).sort((a,b)=>a-b);
  
  if (sortedHours.length === 0) {
    timelineHtml += '<div class="text-muted ms-3 small">ã¾ã ãµã‚Šã‹ãˆã‚Šã®è¨˜éŒ²ãŒã‚ã‚Šã¾ã›ã‚“</div>';
  } else {
    sortedHours.forEach(h => {
      const r = reflections[h];
      const achIcon = r.achievement === 'A' ? 'â—' : (r.achievement === 'B' ? 'ã€‡' : 'â–³');
      const achColor = r.achievement === 'A' ? 'text-primary' : (r.achievement === 'B' ? 'text-success' : 'text-secondary');
      
      let tagsHtml = '';
      if(r.skills && r.skills.length > 0) {
        tagsHtml = '<div class="mt-1">' + r.skills.map(sid => {
          const def = SKILL_DEFINITIONS.find(d => d.id === sid);
          return def ? `<span class="badge rounded-pill bg-light text-dark border me-1 small fw-normal">${def.label}</span>` : '';
        }).join('') + '</div>';
      }

      const editBtn = !isTeacherMode ? `<i class="bi bi-pencil-square text-muted ms-2 cursor-pointer edit-icon" onclick="Swal.close(); setTimeout(() => openDailyReflectionModal(${h}), 300);"></i>` : '';

      timelineHtml += `
        <div class="position-relative mb-4 ms-3">
          <div class="position-absolute top-0 start-0 translate-middle rounded-circle bg-white border border-2" style="width:12px;height:12px;left:-22px!important;"></div>
          <div class="small fw-bold text-muted mb-1 d-flex align-items-center">
            ç¬¬${h}æ™‚ <span class="${achColor} ms-2 fs-6">${achIcon}</span>
            ${editBtn}
          </div>
          <div class="bg-light p-2 rounded small">${r.comment || 'ã‚³ãƒ¡ãƒ³ãƒˆãªã—'}</div>
          ${tagsHtml}
        </div>`;
    });
  }
  timelineHtml += '</div>';

  let feedbackHtml = '';
  // ç”Ÿå¾’ãƒ¢ãƒ¼ãƒ‰ã§ãƒ•ã‚£ãƒ¼ãƒ‰ãƒãƒƒã‚¯ãŒã‚ã‚‹å ´åˆã®ã¿è¡¨ç¤º
  if (!isTeacherMode && (feedback || stamp)) {
    const stampIcon = {'check':'âœ…','good':'ğŸ‘','great':'ğŸ’®','support':'ğŸš©'}[stamp] || '';
    feedbackHtml = `
      <div class="mt-4 border p-3 rounded bg-white shadow-sm">
        <div class="small fw-bold text-primary mb-2"><i class="bi bi-person-badge-fill me-1"></i>å…ˆç”Ÿã‹ã‚‰ã®ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸</div>
        <div class="d-flex align-items-start">
          <div class="display-4 me-3">${stampIcon}</div>
          <div class="flex-grow-1 bg-light p-2 rounded small text-dark">${feedback || 'ï¼ˆã‚³ãƒ¡ãƒ³ãƒˆãªã—ï¼‰'}</div>
        </div>
      </div>
    `;
  }

  const readonlyAttr = isTeacherMode ? 'readonly' : '';
  const saveBtnHtml = isTeacherMode ? '' : `<button class="btn btn-primary rounded-pill w-100 mt-3" onclick="saveSummary()"><ruby>ä¿å­˜<rt>ã»ãã‚“</rt></ruby>ã™ã‚‹</button>`;
  const summaryHtml = `
    <div class="p-2">
      <div class="small text-muted mb-2">ã“ã®å˜å…ƒã‚’é€šã—ã¦å­¦ã‚“ã ã“ã¨ã€ã§ãã‚‹ã‚ˆã†ã«ãªã£ãŸã“ã¨ã‚’æ›¸ãã¾ã—ã‚‡ã†ã€‚</div>
      <textarea id="pf-summary" class="form-control bg-light border-0" rows="8" placeholder="ã“ã“ã«ã¾ã¨ã‚ã‚’æ›¸ã“ã†..." ${readonlyAttr}>${summary||''}</textarea>
      ${saveBtnHtml}
      ${feedbackHtml}
    </div>
  `;

  Swal.fire({
    title: `<div class="fs-4 fw-bold"><i class="bi bi-journal-text me-2"></i>${name} ã•ã‚“ã®ãƒãƒ¼ãƒˆãƒ•ã‚©ãƒªã‚ª</div>`,
    html: `
      <div class="container-fluid text-start px-0">
        <ul class="nav nav-pills mb-3 justify-content-center" id="pills-tab" role="tablist">
          <li class="nav-item"><button class="nav-link active rounded-pill px-4" id="pills-graph-tab" data-bs-toggle="pill" data-bs-target="#pills-graph" type="button">ã‚°ãƒ©ãƒ•</button></li>
          <li class="nav-item"><button class="nav-link rounded-pill px-4" id="pills-log-tab" data-bs-toggle="pill" data-bs-target="#pills-log" type="button">ã‚ã‚†ã¿</button></li>
          <li class="nav-item"><button class="nav-link rounded-pill px-4" id="pills-sum-tab" data-bs-toggle="pill" data-bs-target="#pills-sum" type="button">ã¾ã¨ã‚</button></li>
        </ul>
        <div class="tab-content" id="pills-tabContent" style="min-height: 300px;">
          <div class="tab-pane fade show active" id="pills-graph" role="tabpanel">
            <div class="chart-container" style="position: relative; height:300px; width:100%">
              <canvas id="skillRadarChart"></canvas>
            </div>
            <div class="text-center small text-muted mt-2">â€»æ—¥ã€…ã®ãµã‚Šã‹ãˆã‚Šã§é¸æŠã—ãŸã‚¹ã‚­ãƒ«ãŒé›†è¨ˆã•ã‚Œã¾ã™</div>
          </div>
          <div class="tab-pane fade" id="pills-log" role="tabpanel">
            <div style="max-height: 350px; overflow-y: auto;">${timelineHtml}</div>
          </div>
          <div class="tab-pane fade" id="pills-sum" role="tabpanel">${summaryHtml}</div>
        </div>
      </div>
    `,
    width: '650px',
    showCloseButton: true,
    showConfirmButton: false,
    didOpen: () => {
      const ctx = document.getElementById('skillRadarChart').getContext('2d');
      new Chart(ctx, {
        type: 'radar',
        data: {
          labels: chartLabels,
          datasets: [{
            label: 'ç™ºæ®ã—ãŸåŠ›',
            data: chartData,
            backgroundColor: 'rgba(26, 115, 232, 0.2)',
            borderColor: 'rgba(26, 115, 232, 1)',
            pointBackgroundColor: 'rgba(26, 115, 232, 1)',
            borderWidth: 2
          }]
        },
        options: {
          scales: {
            r: {
              angleLines: { display: true },
              suggestedMin: 0,
              suggestedMax: maxVal,
              ticks: { stepSize: 1, backdropColor: 'transparent' }
            }
          },
          plugins: { legend: { display: false } },
          maintainAspectRatio: false
        }
      });
    }
  });
}

function saveSummary() {
  const val = document.getElementById('pf-summary').value;
  if(!dataStore.portfolioData) dataStore.portfolioData = {};
  dataStore.portfolioData.summary = val;
  google.script.run.savePortfolio(appState.user.name, appState.unit.id, val, appState.user.classId);
  Swal.fire({ toast: true, position: 'top-end', icon: 'success', title: 'ä¿å­˜ã—ã¾ã—ãŸ', timer: 2000, showConfirmButton: false });
}

// ==========================================
//  5. å…ˆç”Ÿãƒ¢ãƒ¼ãƒ‰ãƒ­ã‚¸ãƒƒã‚¯
// ==========================================

function renderTeacherView() {
  const container = document.getElementById('app-container');
  const classes = ['All', ...dataStore.classList];
  const tabsHtml = classes.map(c => 
    `<li class="nav-item"><a class="nav-link ${appState.view.teacherClassId === c ? 'active fw-bold' : ''}" href="#" onclick="setTeacherClass('${c}')">${c === 'All' ? 'å…¨å“¡' : c}</a></li>`
  ).join('');

  container.innerHTML = `
    <div class="card shadow-sm p-4 border-0 rounded-4 teacher-view-card h-100">
      <div class="d-flex justify-content-between align-items-center mb-3 flex-shrink-0">
        <h5 class="fw-bold m-0 text-primary"><i class="bi bi-speedometer2 me-2"></i>ãƒ¢ãƒ‹ã‚¿ãƒ¼ <span class="badge bg-success ms-2 small" style="font-size:0.6rem">AUTO</span></h5>
        <div class="d-flex gap-3 align-items-center">
          <div class="btn-group shadow-sm rounded-pill" role="group">
            <button class="btn btn-sm ${appState.view.teacher === 'cards' ? 'btn-primary' : 'btn-outline-primary'}" onclick="setTeacherView('cards')">LIVE</button>
            <button class="btn btn-sm ${appState.view.teacher === 'heatmap' ? 'btn-primary' : 'btn-outline-primary'}" onclick="setTeacherView('heatmap')">ä¸€è¦§</button>
            <button class="btn btn-sm ${appState.view.teacher === 'seating' ? 'btn-primary' : 'btn-outline-primary'}" onclick="setTeacherView('seating')">åº§å¸­</button>
            <button class="btn btn-sm ${appState.view.teacher === 'summaries' ? 'btn-primary' : 'btn-outline-primary'}" onclick="setTeacherView('summaries')">ã¾ã¨ã‚</button>
            <button class="btn btn-sm ${appState.view.teacher === 'design' ? 'btn-primary' : 'btn-outline-primary'}" onclick="setTeacherView('design')"><i class="bi bi-pencil-ruler me-1"></i>è¨­è¨ˆ</button>
            <button class="btn btn-sm ${appState.view.teacher === 'control' ? 'btn-primary' : 'btn-outline-primary'}" onclick="setTeacherView('control')">é€²è¡Œ</button>
          </div>
          <button class="btn btn-primary btn-sm rounded-pill px-3 shadow-sm" onclick="openUnitManagerModal()"><i class="bi bi-plus-circle me-1"></i>æ–°è¦å˜å…ƒç™»éŒ²</button>
        </div>
      </div>
      <ul class="nav nav-tabs mb-4 border-bottom-0 flex-shrink-0">${tabsHtml}</ul>
      <div id="t-area" class="position-relative flex-grow-1 d-flex flex-column overflow-hidden"></div>
    </div>`;
  renderTeacherDashboardContent();
}

function setTeacherClass(cls) { appState.view.teacherClassId = cls; renderTeacherView(); }
function setTeacherView(mode) { appState.view.teacher = mode; renderTeacherView(); }

function renderTeacherDashboardContent() {
  const el = document.getElementById('t-area');
  if (!el) return;
  const scrollPos = el.scrollTop;

  if (appState.view.teacher === 'summaries') { renderSummaryListView(el); el.scrollTop = scrollPos; return; }
  if (appState.view.teacher === 'seating') { renderSeatingView(el); return; }
  if (appState.view.teacher === 'control') { renderControlView(el); return; }
  if (appState.view.teacher === 'design') { renderTeacherDesignView(el); return; } 
  
  const targetStudents = getFilteredStudents();
  if (appState.view.teacher === 'cards') {
    renderLiveCards(el, targetStudents);
  } else {
    renderHeatmap(el, targetStudents);
  }
  
  if(scrollPos > 0) el.scrollTop = scrollPos;
}

// ----------------------------------------------------
//  ã¾ã¨ã‚ä¸€è¦§æ©Ÿèƒ½ (New Table View)
// ----------------------------------------------------

function renderSummaryListView(container) {
  container.className = "flex-grow-1 p-3 overflow-hidden d-flex flex-column"; 
  
  const students = getFilteredStudents().sort((a,b) => a.name.localeCompare(b.name));
  
  if (students.length === 0) {
    container.innerHTML = `<div class="text-center p-5 text-muted">è¡¨ç¤ºã™ã‚‹ç”Ÿå¾’ãŒã„ã¾ã›ã‚“</div>`;
    return;
  }

  let tableRows = '';
  students.forEach((s, index) => {
    // ãƒãƒ¼ãƒˆãƒ•ã‚©ãƒªã‚ªãƒ‡ãƒ¼ã‚¿å–å¾—
    let pf = {};
    if (dataStore.clsPortfolios && dataStore.clsPortfolios[s.name] && dataStore.clsPortfolios[s.name][appState.unit.id]) {
      const rawPf = dataStore.clsPortfolios[s.name][appState.unit.id];
      pf = (typeof rawPf === 'object') ? rawPf : { summary: rawPf, feedback: "", stamp: "" };
    }
    const summary = pf.summary || "";
    const feedback = pf.feedback || "";
    const stamp = pf.stamp || "";

    // ã‚¹ã‚­ãƒ«é›†è¨ˆ
    const skillCounts = {};
    SKILL_DEFINITIONS.forEach(def => skillCounts[def.id] = 0);
    
    if (dataStore.clsReflections && dataStore.clsReflections[s.name] && dataStore.clsReflections[s.name][appState.unit.id]) {
      const reflections = dataStore.clsReflections[s.name][appState.unit.id];
      Object.values(reflections).forEach(r => {
        if (r.skills && Array.isArray(r.skills)) {
          r.skills.forEach(sid => { if (skillCounts[sid] !== undefined) skillCounts[sid]++; });
        }
      });
    }

    // ã‚¹ã‚­ãƒ«ãƒãƒƒã‚¸HTMLç”Ÿæˆ
    let skillBadges = '';
    SKILL_DEFINITIONS.forEach(def => {
      const count = skillCounts[def.id];
      if (count > 0) {
        skillBadges += `<span class="skill-mini-badge bg-${def.color}" title="${def.label}: ${count}å›">${def.label.charAt(0)}${count}</span>`;
      }
    });
    if (!skillBadges) skillBadges = '<span class="text-muted small">-</span>';

    const uniqueId = `pf-${index}`;

    tableRows += `
      <tr>
        <td class="st-col-name text-center text-muted small align-middle">${index + 1}</td>
        <td class="st-col-name align-middle">
          <div class="fw-bold text-primary" style="cursor:pointer;" onclick="renderPortfolioModal('${s.name}', true)">
            ${s.name} <i class="bi bi-box-arrow-up-right small ms-1 text-muted"></i>
          </div>
        </td>
        <td class="st-col-skills align-middle">
          <div class="skill-badge-group">${skillBadges}</div>
        </td>
        <td class="st-col-summary">
          <div class="summary-text-area" id="summary-${uniqueId}" onclick="this.style.maxHeight='none'; this.style.cursor='text';" title="ã‚¯ãƒªãƒƒã‚¯ã§å…¨æ–‡è¡¨ç¤º">
            ${summary ? summary.replace(/\n/g, '<br>') : '<span class="summary-empty">æœªæå‡º</span>'}
          </div>
        </td>
        <td class="st-col-feedback align-middle">
          <div class="stamp-select-group">
            <label>
              <input type="radio" name="stamp-${uniqueId}" value="check" class="stamp-input" ${stamp==='check'?'checked':''}>
              <span class="stamp-option" title="ç¢ºèª">âœ…</span>
            </label>
            <label>
              <input type="radio" name="stamp-${uniqueId}" value="good" class="stamp-input" ${stamp==='good'?'checked':''}>
              <span class="stamp-option" title="ã„ã„ã­">ğŸ‘</span>
            </label>
            <label>
              <input type="radio" name="stamp-${uniqueId}" value="great" class="stamp-input" ${stamp==='great'?'checked':''}>
              <span class="stamp-option" title="ã™ã°ã‚‰ã—ã„">ğŸ’®</span>
            </label>
            <label>
              <input type="radio" name="stamp-${uniqueId}" value="support" class="stamp-input" ${stamp==='support'?'checked':''}>
              <span class="stamp-option" title="å¿œæ´">ğŸš©</span>
            </label>
          </div>
          <div class="input-group input-group-sm">
            <input type="text" id="fb-text-${uniqueId}" class="form-control" placeholder="ã‚³ãƒ¡ãƒ³ãƒˆã‚’å…¥åŠ›..." value="${feedback}">
            <button id="btn-save-${uniqueId}" class="btn btn-primary" onclick="saveListFeedback('${s.name}', '${uniqueId}')">ä¿å­˜</button>
          </div>
        </td>
      </tr>
    `;
  });

  container.innerHTML = `
    <div class="summary-table-container h-100">
      <table class="summary-table">
        <thead>
          <tr>
            <th class="text-center" style="width:40px;">#</th>
            <th class="st-col-name">åå‰</th>
            <th class="st-col-skills">ç²å¾—ã‚¹ã‚­ãƒ«</th>
            <th class="st-col-summary">å˜å…ƒã®ã¾ã¨ã‚</th>
            <th class="st-col-feedback">
              <div class="d-flex justify-content-between align-items-center">
                <span>ãƒ•ã‚£ãƒ¼ãƒ‰ãƒãƒƒã‚¯</span>
                <button id="btn-bulk-save" class="btn btn-success btn-sm rounded-pill px-3 shadow-sm" onclick="saveAllListFeedbacks()">
                  <i class="bi bi-save me-1"></i>ä¸€æ‹¬ä¿å­˜
                </button>
              </div>
            </th>
          </tr>
        </thead>
        <tbody>
          ${tableRows}
        </tbody>
      </table>
    </div>
  `;
}

function saveListFeedback(studentName, uniqueId) {
  const comment = document.getElementById(`fb-text-${uniqueId}`).value;
  const stampEl = document.querySelector(`input[name="stamp-${uniqueId}"]:checked`);
  const stamp = stampEl ? stampEl.value : "";
  
  // ãƒœã‚¿ãƒ³è¦ç´ ã‚’å–å¾—ã—ã¦ãƒ­ãƒ¼ãƒ‡ã‚£ãƒ³ã‚°çŠ¶æ…‹ã«ã™ã‚‹
  const btn = document.getElementById(`btn-save-${uniqueId}`);
  const originalText = btn.innerHTML; // å…ƒã®ãƒ†ã‚­ã‚¹ãƒˆ("ä¿å­˜")ã‚’é€€é¿
  
  btn.disabled = true;
  btn.innerHTML = '<span class="spinner-border spinner-border-sm me-1" role="status" aria-hidden="true"></span>';
  
  // ãƒ­ãƒ¼ã‚«ãƒ«ãƒ‡ãƒ¼ã‚¿æ›´æ–°
  if (!dataStore.clsPortfolios[studentName]) dataStore.clsPortfolios[studentName] = {};
  if (!dataStore.clsPortfolios[studentName][appState.unit.id]) dataStore.clsPortfolios[studentName][appState.unit.id] = {};
  
  let pf = dataStore.clsPortfolios[studentName][appState.unit.id];
  if (typeof pf !== 'object') {
    pf = { summary: pf || "" };
    dataStore.clsPortfolios[studentName][appState.unit.id] = pf;
  }
  pf.feedback = comment;
  pf.stamp = stamp;

  // ã‚µãƒ¼ãƒãƒ¼ã¸ä¿å­˜
  google.script.run
    .withSuccessHandler(() => {
      showToast('success', 'ä¿å­˜ã—ã¾ã—ãŸ');
      // ãƒœã‚¿ãƒ³ã‚’å…ƒã®çŠ¶æ…‹ã«æˆ»ã™
      btn.disabled = false;
      btn.innerHTML = originalText;
    })
    .withFailureHandler((e) => {
      handleError(e);
      // ã‚¨ãƒ©ãƒ¼æ™‚ã‚‚ãƒœã‚¿ãƒ³ã‚’æˆ»ã™
      btn.disabled = false;
      btn.innerHTML = originalText;
    })
    .savePortfolioFeedback(studentName, appState.unit.id, comment, stamp);
}

function saveAllListFeedbacks() {
  const students = getFilteredStudents();
  if (students.length === 0) return;

  // ãƒœã‚¿ãƒ³ã‚’ãƒ­ãƒ¼ãƒ‡ã‚£ãƒ³ã‚°çŠ¶æ…‹ã«ã™ã‚‹
  const btn = document.getElementById('btn-bulk-save');
  const originalHtml = btn.innerHTML;
  btn.disabled = true;
  btn.innerHTML = '<span class="spinner-border spinner-border-sm me-1"></span>ä¿å­˜ä¸­...';

  const feedbackList = [];

  // è¡¨ç¤ºã•ã‚Œã¦ã„ã‚‹å…¨ç”Ÿå¾’ã®å…¥åŠ›ã‚’åé›†
  students.forEach((s, index) => {
    const uniqueId = `pf-${index}`;
    const commentInput = document.getElementById(`fb-text-${uniqueId}`);
    const stampEl = document.querySelector(`input[name="stamp-${uniqueId}"]:checked`);
    
    // å…¥åŠ›æ¬„ãŒå­˜åœ¨ã™ã‚‹å ´åˆã®ã¿å‡¦ç†
    if (commentInput) {
      const comment = commentInput.value;
      const stamp = stampEl ? stampEl.value : "";
      const unitId = appState.unit.id;

      // å¤‰æ›´ãŒã‚ã‚‹ã‹ã©ã†ã‹ã®å³å¯†ãªãƒã‚§ãƒƒã‚¯ã¯çœç•¥ã—ã€ç¾åœ¨ã®ç”»é¢çŠ¶æ…‹ã‚’æ­£ã¨ã—ã¦å…¨ã¦é€ä¿¡
      // ãƒ­ãƒ¼ã‚«ãƒ«ãƒ‡ãƒ¼ã‚¿ã‚’æ›´æ–°
      if (!dataStore.clsPortfolios[s.name]) dataStore.clsPortfolios[s.name] = {};
      if (!dataStore.clsPortfolios[s.name][unitId]) dataStore.clsPortfolios[s.name][unitId] = {};

      let pf = dataStore.clsPortfolios[s.name][unitId];
      if (typeof pf !== 'object') {
        pf = { summary: pf || "" };
        dataStore.clsPortfolios[s.name][unitId] = pf;
      }
      pf.feedback = comment;
      pf.stamp = stamp;

      // é€ä¿¡ãƒªã‚¹ãƒˆã«è¿½åŠ 
      feedbackList.push({
        studentName: s.name,
        unitId: unitId,
        feedback: comment,
        stamp: stamp
      });
    }
  });

  // ã‚µãƒ¼ãƒãƒ¼ã¸ä¸€æ‹¬é€ä¿¡
  google.script.run
    .withSuccessHandler(() => {
      showToast('success', 'å…¨å“¡åˆ†ã‚’ä¿å­˜ã—ã¾ã—ãŸ');
      btn.disabled = false;
      btn.innerHTML = originalHtml;
    })
    .withFailureHandler((e) => {
      handleError(e);
      btn.disabled = false;
      btn.innerHTML = originalHtml;
    })
    .saveAllPortfolios(feedbackList);
}

// ------------------------------------
//  å…ˆç”Ÿç”¨ï¼šå˜å…ƒãƒ‡ã‚¶ã‚¤ãƒ³ï¼ˆè¨­è¨ˆï¼‰æ©Ÿèƒ½
// ------------------------------------

function renderTeacherDesignView(container) {
  container.className = "flex-grow-1 overflow-hidden d-flex flex-column";
  
  const currentTasks = getCurrentUnitTasks(); 
  const totalHours = appState.unit.totalHours; 
  
  const taskPool = [];
  const hoursMap = {}; 
  
  for(let i = 1; i <= totalHours; i++) {
    hoursMap[i] = [];
  }
  
  currentTasks.forEach(t => {
    const stepNum = getStepNumber(t.step);
    if (stepNum > 0 && hoursMap[stepNum]) {
      hoursMap[stepNum].push(t);
    } else {
      taskPool.push(t);
    }
  });

  let taskPoolHtml = '';
  taskPool.forEach(t => {
    const borderClass = getCategoryColorClass(t.category);
    const badge = t.format === 'teacher' ? '<span class="badge bg-info text-white me-1">å…ˆç”Ÿ</span>' : '';
    taskPoolHtml += `
      <div class="card p-2 mb-2 shadow-sm task-draggable ${borderClass}" data-id="${t.taskId}" onclick="openTeacherTaskEditModal('${t.taskId}')" style="cursor:pointer">
        <div class="small fw-bold">${badge}${t.title}</div>
        <div class="d-flex justify-content-between align-items-center mt-1">
          <span class="badge bg-light text-secondary border rounded-pill" style="font-size:0.6rem">${t.category}</span>
          <div class="x-small text-muted">${t.time}åˆ†</div>
        </div>
      </div>`;
  });

  let hoursHtml = '';
  for(let i = 1; i <= totalHours; i++) {
    let hourTasksHtml = '';
    let totalTime = 0;
    
    hoursMap[i].forEach(t => {
      totalTime += t.time;
      const borderClass = getCategoryColorClass(t.category);
      const badge = t.format === 'teacher' ? '<span class="badge bg-info text-white me-1">å…ˆç”Ÿ</span>' : '';
      hourTasksHtml += `
        <div class="card p-2 mb-2 shadow-sm task-draggable ${borderClass}" data-id="${t.taskId}" onclick="openTeacherTaskEditModal('${t.taskId}')" style="cursor:pointer">
          <div class="d-flex justify-content-between">
            <span class="small fw-bold text-truncate">${badge}${t.title}</span>
          </div>
          <div class="d-flex justify-content-between align-items-center mt-1">
            <span class="badge bg-light text-secondary border rounded-pill" style="font-size:0.6rem">${t.category}</span>
            <div class="x-small text-muted text-end">${t.time}åˆ†</div>
          </div>
        </div>`;
    });

    const timeRatio = Math.min(totalTime / CONSTANTS.UNIT_TIME, 1) * 100;
    const barColor = totalTime > CONSTANTS.UNIT_TIME ? '#ffcdd2' : '#c8e6c9';
    const headerStyle = `background: linear-gradient(90deg, ${barColor} ${timeRatio}%, #f8f9fa ${timeRatio}%);`;

    hoursHtml += `
      <div class="plan-hour-row mb-3">
        <div class="plan-hour-header-v p-2 fw-bold text-center border rounded-top position-relative" style="${headerStyle}">
          ç¬¬${i}æ™‚ <span class="small ms-2 fw-normal badge bg-white text-dark border">${totalTime}åˆ†</span>
        </div>
        <div class="plan-drop-zone-v p-2 border border-top-0 rounded-bottom teacher-design-dropzone" data-step="Step ${i}" style="min-height: 80px; background-color: #fff;">
          ${hourTasksHtml}
        </div>
      </div>`;
  }

  // â˜…å¤‰æ›´ç‚¹ï¼šãƒ˜ãƒƒãƒ€ãƒ¼éƒ¨åˆ†ã«ç·¨é›†ãƒœã‚¿ãƒ³ã‚’è¿½åŠ 
  container.innerHTML = `
    <div class="d-flex justify-content-between align-items-center mb-3 p-3 pb-0">
      <div class="d-flex align-items-center">
        <h5 class="fw-bold m-0 text-muted me-2">å˜å…ƒè¨ˆç”»</h5>
        
        <!-- å˜å…ƒæƒ…å ±ç·¨é›†ãƒœã‚¿ãƒ³ -->
        <button class="btn btn-light btn-sm text-secondary rounded-circle me-3" onclick="openUnitInfoEditModal()" title="å˜å…ƒæƒ…å ±ã®ç·¨é›†">
          <i class="bi bi-pencil-fill"></i>
        </button>

        <div class="input-group input-group-sm w-auto">
          <span class="input-group-text">å…¨</span>
          <input type="text" class="form-control text-center fw-bold" value="${totalHours}" style="width:50px;" readonly>
          <span class="input-group-text">æ™‚é–“</span>
          <button class="btn btn-outline-secondary" onclick="changeUnitTotalHours(1)"><i class="bi bi-plus-lg"></i></button>
          <button class="btn btn-outline-secondary" onclick="changeUnitTotalHours(-1)"><i class="bi bi-dash-lg"></i></button>
        </div>
      </div>
    </div>
    <div class="row flex-grow-1 h-100 px-3 pb-3" style="min-height:0;">
      <!-- å·¦å´ï¼šæœªé…ç½®ãƒ—ãƒ¼ãƒ« -->
      <div class="col-4 h-100 border-end bg-white rounded-start d-flex flex-column">
        <div class="p-2 border-bottom fw-bold text-muted d-flex justify-content-between align-items-center">
          <span><i class="bi bi-inbox me-2"></i>æœªé…ç½®ãƒ»ãã®ä»–</span>
          <button class="btn btn-outline-primary btn-sm rounded-circle" onclick="openTeacherTaskEditModal('NEW')"><i class="bi bi-plus"></i></button>
        </div>
        <div id="teacher-pool-container" class="flex-grow-1 overflow-auto p-2 teacher-design-dropzone" data-step="">
          ${taskPoolHtml}
        </div>
      </div>
      <!-- å³å´ï¼šæ™‚æ•°ãƒ¬ãƒ¼ãƒ³ -->
      <div class="col-8 h-100 overflow-auto bg-light rounded-end">
        <div class="p-3">
          <div class="alert alert-info small py-2 mb-3"><i class="bi bi-info-circle me-2"></i>ã“ã“ã§ã®å¤‰æ›´ã¯<strong>å…¨å“¡ã®åˆæœŸè¨ˆç”»ï¼ˆãƒ‡ãƒ•ã‚©ãƒ«ãƒˆï¼‰</strong>ã¨ã—ã¦ä¿å­˜ã•ã‚Œã¾ã™ã€‚</div>
          ${hoursHtml}
        </div>
      </div>
    </div>`;

  // Sortableã®è¨­å®š
  const dropZones = document.querySelectorAll('.teacher-design-dropzone');
  
  dropZones.forEach(el => {
    new Sortable(el, {
      group: 'teacher-design',
      sort: true,
      animation: 150,
      onAdd: function (evt) {
        const taskId = evt.item.getAttribute('data-id');
        const newStep = evt.to.getAttribute('data-step') || ""; 
        
        // ãƒ­ãƒ¼ã‚«ãƒ«ãƒ‡ãƒ¼ã‚¿ã‚’æ›´æ–°
        const task = dataStore.masterTasks.find(t => t.taskId === taskId);
        if (task) {
          task.step = newStep;
          renderTeacherDesignView(document.getElementById('t-area')); // å†æç”»ã—ã¦åˆè¨ˆæ™‚é–“ã‚’æ›´æ–°
          
          // ã‚µãƒ¼ãƒãƒ¼ã¸ä¿å­˜
          google.script.run
            .withFailureHandler(handleError)
            .updateUnitTask(taskId, { step: newStep });
        }
      }
    });
  });
}

/**
 * å˜å…ƒæƒ…å ±ï¼ˆã‚¿ã‚¤ãƒˆãƒ«ã€ã‚ã‚ã¦ã€æ¦‚è¦ï¼‰ã‚’ç·¨é›†ã™ã‚‹ãƒ¢ãƒ¼ãƒ€ãƒ«
 */
function openUnitInfoEditModal() {
  const unit = appState.unitList.find(u => u.id === appState.unit.id);
  if (!unit) return;

  Swal.fire({
    title: 'å˜å…ƒæƒ…å ±ã®ç·¨é›†',
    html: `
      <div class="text-start">
        <div class="mb-3">
          <label class="form-label small fw-bold">å˜å…ƒå <span class="text-danger">*</span></label>
          <input id="ue-title" class="form-control" value="${unit.title || ''}">
        </div>
        <div class="row mb-3">
          <div class="col">
            <label class="form-label small fw-bold">æ•™ç§‘</label>
            <input id="ue-subject" class="form-control" value="${unit.subject || ''}">
          </div>
          <div class="col">
            <label class="form-label small fw-bold">å­¦å¹´</label>
            <input id="ue-grade" class="form-control" value="${unit.grade || ''}">
          </div>
        </div>
        <div class="mb-3">
          <label class="form-label small fw-bold">å˜å…ƒã®ã‚ã‚ã¦</label>
          <textarea id="ue-goal" class="form-control" rows="2">${unit.goal || ''}</textarea>
        </div>
        <div class="mb-3">
          <label class="form-label small fw-bold">æ¦‚è¦</label>
          <textarea id="ue-description" class="form-control" rows="3">${unit.description || ''}</textarea>
        </div>
      </div>
    `,
    showCancelButton: true,
    confirmButtonText: 'æ›´æ–°ã™ã‚‹',
    preConfirm: () => {
      const title = document.getElementById('ue-title').value;
      if (!title) {
        Swal.showValidationMessage('å˜å…ƒåã¯å¿…é ˆã§ã™');
        return false;
      }
      return {
        title: title,
        subject: document.getElementById('ue-subject').value,
        grade: document.getElementById('ue-grade').value,
        goal: document.getElementById('ue-goal').value,
        description: document.getElementById('ue-description').value
      };
    }
  }).then(r => {
    if (r.isConfirmed) {
      const newData = r.value;
      
      // ãƒ­ãƒ¼ã‚«ãƒ«ãƒ‡ãƒ¼ã‚¿ã‚’å³æ™‚æ›´æ–°
      unit.title = newData.title;
      unit.subject = newData.subject;
      unit.grade = newData.grade;
      unit.goal = newData.goal;
      unit.description = newData.description;
      
      // ç”»é¢æ›´æ–°
      appState.unit.title = unit.title; // ãƒ˜ãƒƒãƒ€ãƒ¼ç­‰ã®è¡¨ç¤ºç”¨
      renderUnitSelector();
      renderTeacherDesignView(document.getElementById('t-area'));
      
      // ã‚µãƒ¼ãƒãƒ¼ã¸ä¿å­˜
      google.script.run
        .withSuccessHandler(() => showToast('success', 'å˜å…ƒæƒ…å ±ã‚’æ›´æ–°ã—ã¾ã—ãŸ'))
        .withFailureHandler(handleError)
        .updateUnitBasicInfo(unit.id, newData);
    }
  });
}

function changeUnitTotalHours(delta) {
  const current = appState.unit.totalHours;
  const next = current + delta;
  if (next < 1) return;
  
  appState.unit.totalHours = next;
  renderTeacherDesignView(document.getElementById('t-area'));
  
  google.script.run
    .withFailureHandler(e => {
      appState.unit.totalHours = current; 
      handleError(e);
      renderTeacherDesignView(document.getElementById('t-area'));
    })
    .withSuccessHandler(() => showToast('success', 'æ™‚æ•°ã‚’å¤‰æ›´ã—ã¾ã—ãŸ'))
    .updateUnitTotalHours(appState.unit.id, next);
}

function openTeacherTaskEditModal(taskId) {
  let task = {};
  let isNew = false;
  
  if (taskId === 'NEW') {
    isNew = true;
    task = { title: '', description: '', estimatedTime: 15, category: 'ã¾ãªã¶', format: 'student', type: 'must', step: '' };
  } else {
    task = dataStore.masterTasks.find(t => t.taskId === taskId);
    if (!task) return;
  }

  Swal.fire({
    title: isNew ? 'æ–°ã—ã„ã‚¿ã‚¹ã‚¯' : 'ã‚¿ã‚¹ã‚¯ç·¨é›†',
    html: `
      <div class="text-start">
        <div class="mb-3">
          <label class="form-label small fw-bold">ã‚¿ã‚¤ãƒˆãƒ«</label>
          <input id="ed-title" class="form-control" value="${task.title || ''}">
        </div>
        <div class="mb-3">
          <label class="form-label small fw-bold">èª¬æ˜æ–‡</label>
          <textarea id="ed-desc" class="form-control" rows="3">${task.desc || task.description || ''}</textarea>
        </div>
        <div class="row mb-3">
          <div class="col">
            <label class="form-label small fw-bold">ç›®å®‰æ™‚é–“(åˆ†)</label>
            <input type="number" id="ed-time" class="form-control" value="${task.time || task.estimatedTime || 15}">
          </div>
          <div class="col">
            <label class="form-label small fw-bold">ã‚«ãƒ†ã‚´ãƒª</label>
            <select id="ed-cat" class="form-select">
              <option value="ã¾ãªã¶" ${task.category==='ã¾ãªã¶'?'selected':''}>ã¾ãªã¶</option>
              <option value="ãµã‹ã‚ã‚‹" ${task.category==='ãµã‹ã‚ã‚‹'?'selected':''}>ãµã‹ã‚ã‚‹</option>
              <option value="ã¾ã¨ã‚ã‚‹" ${task.category==='ã¾ã¨ã‚ã‚‹'?'selected':''}>ã¾ã¨ã‚ã‚‹</option>
              <option value="å°å…¥" ${task.category==='å°å…¥'?'selected':''}>å°å…¥</option>
            </select>
          </div>
        </div>
        <div class="mb-3 form-check form-switch border p-2 rounded bg-light">
          <input class="form-check-input ms-0 me-2" type="checkbox" id="ed-teacher" ${task.format === 'teacher' ? 'checked' : ''} style="float:none;">
          <label class="form-check-label fw-bold" for="ed-teacher">å…ˆç”Ÿã‚¿ã‚¹ã‚¯ï¼ˆå›ºå®šè¡¨ç¤ºï¼‰ã«ã™ã‚‹</label>
          <div class="form-text x-small ps-1">ONã«ã™ã‚‹ã¨ã€æŒ‡å®šã—ãŸæ™‚æ•°ã«è‡ªå‹•çš„ã«å›ºå®šè¡¨ç¤ºã•ã‚Œã¾ã™ã€‚</div>
        </div>
      </div>
    `,
    showCancelButton: true,
    confirmButtonText: 'ä¿å­˜',
    showDenyButton: !isNew,
    denyButtonText: 'å‰Šé™¤',
    denyButtonColor: '#d33',
    preConfirm: () => {
      return {
        title: document.getElementById('ed-title').value,
        description: document.getElementById('ed-desc').value,
        estTime: parseInt(document.getElementById('ed-time').value),
        category: document.getElementById('ed-cat').value,
        format: document.getElementById('ed-teacher').checked ? 'teacher' : 'student'
      };
    }
  }).then(r => {
    if (r.isConfirmed) {
      const newData = r.value;
      
      if (isNew) {
        showLoading();
        google.script.run
          .withSuccessHandler(res => {
             if(res.success) {
               // ãƒ­ãƒ¼ã‚«ãƒ«ãƒ‡ãƒ¼ã‚¿ã«å³æ™‚åæ˜ 
               const newTaskId = res.taskId;
               const newTask = {
                 unitId: appState.unit.id,
                 taskId: newTaskId,
                 title: newData.title,
                 description: newData.description,
                 estTime: newData.estTime,
                 category: newData.category,
                 format: newData.format,
                 step: '',
                 time: newData.estTime, 
                 desc: newData.description,
                 type: 'must'
               };
               dataStore.masterTasks.push(newTask);
               renderTeacherDesignView(document.getElementById('t-area'));
               hideLoading(); // Loading hidden here
               showToast('success', 'ã‚¿ã‚¹ã‚¯ã‚’è¿½åŠ ã—ã¾ã—ãŸ');
             } else { handleError(res); }
          })
          .withFailureHandler(handleError)
          .addUnitTask(appState.unit.id, newData);
      } else {
        const t = dataStore.masterTasks.find(x => x.taskId === taskId);
        t.title = newData.title;
        t.desc = newData.description;
        t.time = newData.estTime;
        t.category = newData.category;
        t.format = newData.format;
        
        renderTeacherDesignView(document.getElementById('t-area'));
        
        google.script.run
          .withSuccessHandler(() => showToast('success', 'æ›´æ–°ã—ã¾ã—ãŸ'))
          .withFailureHandler(handleError)
          .updateUnitTask(taskId, newData);
      }
    } else if (r.isDenied) {
      Swal.fire({
        title: 'å‰Šé™¤ã—ã¾ã™ã‹ï¼Ÿ',
        text: 'ã“ã®ã‚¿ã‚¹ã‚¯ã‚’å‰Šé™¤ã—ã¾ã™ã€‚å…ƒã«æˆ»ã›ã¾ã›ã‚“ã€‚',
        icon: 'warning',
        showCancelButton: true,
        confirmButtonColor: '#d33',
        confirmButtonText: 'å‰Šé™¤å®Ÿè¡Œ'
      }).then(delRes => {
        if(delRes.isConfirmed) {
          dataStore.masterTasks = dataStore.masterTasks.filter(t => t.taskId !== taskId);
          renderTeacherDesignView(document.getElementById('t-area'));
          
          google.script.run
            .withSuccessHandler(() => showToast('info', 'å‰Šé™¤ã—ã¾ã—ãŸ'))
            .withFailureHandler(handleError)
            .deleteUnitTask(taskId);
        }
      });
    }
  });
}

// ------------------------------------
//  å˜å…ƒç®¡ç†ï¼ˆçµ±åˆãƒ¢ãƒ¼ãƒ€ãƒ«ï¼‰æ©Ÿèƒ½
// ------------------------------------

// [å¤‰æ›´] ã‚µãƒ¼ãƒãƒ¼ã‹ã‚‰ãƒ—ãƒ­ãƒ³ãƒ—ãƒˆã‚’å–å¾—ã—ã¦ã‹ã‚‰è¡¨ç¤ºã™ã‚‹ã‚ˆã†ã«å¤‰æ›´
function openUnitManagerModal() {
  showLoading();

  google.script.run.withSuccessHandler(res => {
    hideLoading();
    // ä¿å­˜ã•ã‚ŒãŸãƒ—ãƒ­ãƒ³ãƒ—ãƒˆãŒã‚ã‚Œã°ãã‚Œã‚’ã€ãªã‘ã‚Œã°ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆã‚’ä½¿ç”¨
    const initialPrompt = (res.success && res.prompt) ? res.prompt : DEFAULT_AI_PROMPT;

    Swal.fire({
      title: '<i class="bi bi-folder2-open me-2"></i>å˜å…ƒç®¡ç†',
      html: `
        <ul class="nav nav-tabs mb-3" id="unit-mgr-tabs" role="tablist">
          <li class="nav-item" role="presentation">
            <button class="nav-link active" id="um-create-tab" data-bs-toggle="tab" data-bs-target="#um-create" type="button">æ‰‹å‹•ã§æ–°è¦ä½œæˆ</button>
          </li>
          <li class="nav-item" role="presentation">
            <button class="nav-link" id="um-ai-tab" data-bs-toggle="tab" data-bs-target="#um-ai" type="button"><i class="bi bi-stars text-warning me-1"></i>AIã‚¤ãƒ³ãƒãƒ¼ãƒˆ</button>
          </li>
        </ul>
        <div class="tab-content text-start" id="unit-mgr-content">
          <!-- æ‰‹å‹•ä½œæˆã‚¿ãƒ– -->
          <div class="tab-pane fade show active" id="um-create" role="tabpanel">
            <div class="mb-3">
              <label class="form-label small fw-bold">å˜å…ƒå <span class="text-danger">*</span></label>
              <input id="cu-title" class="form-control" placeholder="ä¾‹ï¼šç«äº‹ã‹ã‚‰ãã‚‰ã—ã‚’å®ˆã‚‹">
            </div>
            <div class="row mb-3">
              <div class="col">
                <label class="form-label small fw-bold">æ•™ç§‘</label>
                <input id="cu-subject" class="form-control" placeholder="ä¾‹ï¼šç¤¾ä¼š">
              </div>
              <div class="col">
                <label class="form-label small fw-bold">å­¦å¹´</label>
                <input id="cu-grade" class="form-control" placeholder="ä¾‹ï¼š3å¹´">
              </div>
            </div>
            <div class="mb-3">
              <label class="form-label small fw-bold">ç·æ™‚æ•°ï¼ˆæ™‚é–“ï¼‰</label>
              <input type="number" id="cu-hours" class="form-control" value="8" min="1">
            </div>
            <div class="d-grid">
              <button class="btn btn-primary rounded-pill" onclick="submitCreateUnit()">ä½œæˆã™ã‚‹</button>
            </div>
          </div>
          
          <!-- AIã‚¤ãƒ³ãƒãƒ¼ãƒˆã‚¿ãƒ– -->
          <div class="tab-pane fade" id="um-ai" role="tabpanel">
            <div class="accordion mb-3" id="ai-steps">
              <!-- Step 1 -->
              <div class="accordion-item">
                <h2 class="accordion-header">
                  <button class="accordion-button" type="button" data-bs-toggle="collapse" data-bs-target="#step1">
                    Step 1: AIã«å‘ªæ–‡ã‚’å”±ãˆã‚‹
                  </button>
                </h2>
                <div id="step1" class="accordion-collapse collapse show" data-bs-parent="#ai-steps">
                  <div class="accordion-body bg-light">
                    <div class="d-flex justify-content-between align-items-end mb-2">
                      <p class="small text-muted mb-0">ã“ã®å‘ªæ–‡ï¼ˆãƒ—ãƒ­ãƒ³ãƒ—ãƒˆï¼‰ã‚’AIã«é€ä¿¡ã—ã¦ãã ã•ã„ã€‚<br>å†…å®¹ã¯è‡ªç”±ã«ç·¨é›†ãƒ»ä¿å­˜ã§ãã¾ã™ã€‚</p>
                      <div class="btn-group btn-group-sm">
                        <button class="btn btn-outline-secondary" onclick="resetCustomPrompt()" title="åˆæœŸå€¤ã«æˆ»ã™"><i class="bi bi-arrow-counterclockwise"></i></button>
                        <button class="btn btn-outline-primary" onclick="saveCustomPrompt()" title="ã“ã®å†…å®¹ã‚’ä¿å­˜"><i class="bi bi-save"></i> ä¿å­˜</button>
                      </div>
                    </div>
                    <!-- ç·¨é›†å¯èƒ½ã«å¤‰æ›´ (readonlyå‰Šé™¤) -->
                    <textarea id="prompt-area" class="form-control mb-2 border-primary" rows="8" style="font-size:0.85rem;">${initialPrompt}</textarea>
                    
                    <button class="btn btn-primary btn-sm mb-3 w-100" onclick="copyPrompt()"><i class="bi bi-clipboard me-1"></i>ãƒ—ãƒ­ãƒ³ãƒ—ãƒˆã‚’ã‚³ãƒ”ãƒ¼</button>
                    
                    <div class="d-flex gap-2">
                      <a href="https://chat.openai.com/" target="_blank" class="btn btn-dark btn-sm flex-fill"><i class="bi bi-robot me-1"></i>ChatGPT</a>
                      <a href="https://gemini.google.com/" target="_blank" class="btn btn-primary btn-sm flex-fill"><i class="bi bi-stars me-1"></i>Gemini</a>
                    </div>
                  </div>
                </div>
              </div>
              <!-- Step 2 -->
              <div class="accordion-item">
                <h2 class="accordion-header">
                  <button class="accordion-button collapsed" type="button" data-bs-toggle="collapse" data-bs-target="#step2">
                    Step 2: ã‚³ãƒ¼ãƒ‰ã‚’è²¼ã‚Šä»˜ã‘ã‚‹
                  </button>
                </h2>
                <div id="step2" class="accordion-collapse collapse" data-bs-parent="#ai-steps">
                  <div class="accordion-body">
                    <p class="small text-muted mb-2">AIãŒä½œæˆã—ãŸã‚³ãƒ¼ãƒ‰ï¼ˆ { ... } ã§å›²ã¾ã‚ŒãŸéƒ¨åˆ†ï¼‰ã‚’ã‚³ãƒ”ãƒ¼ã—ã¦ã€ã“ã“ã«è²¼ã‚Šä»˜ã‘ã¦ãã ã•ã„ã€‚</p>
                    <textarea id="json-input" class="form-control mb-3" rows="18" placeholder='{ "unitInfo": ... }'></textarea>
                    <div class="d-grid">
                      <button class="btn btn-success rounded-pill" onclick="submitImportJson()"><i class="bi bi-file-earmark-code me-2"></i>ã‚¤ãƒ³ãƒãƒ¼ãƒˆå®Ÿè¡Œ</button>
                    </div>
                  </div>
                </div>
              </div>
            </div>
          </div>
        </div>
      `,
      showConfirmButton: false,
      showCloseButton: true,
      width: '600px', // åˆæœŸå¹…
      didOpen: () => {
        const popup = Swal.getPopup();
        popup.style.transition = 'width 0.3s ease-in-out, max-width 0.3s ease-in-out';
        
        const tabCreate = document.getElementById('um-create-tab');
        const tabAi = document.getElementById('um-ai-tab');
        
        // ã‚¿ãƒ–åˆ‡ã‚Šæ›¿ãˆã‚¤ãƒ™ãƒ³ãƒˆãƒªã‚¹ãƒŠãƒ¼
        tabCreate.addEventListener('shown.bs.tab', () => {
           popup.style.width = '600px';
           popup.style.maxWidth = '95vw';
        });
        
        tabAi.addEventListener('shown.bs.tab', () => {
           popup.style.width = '90%'; // AIã‚¤ãƒ³ãƒãƒ¼ãƒˆæ™‚ã¯åºƒã’ã‚‹
           popup.style.maxWidth = '1200px';
        });
      }
    });
  }).withFailureHandler(handleError).getCustomAiPrompt();
}

function submitCreateUnit() {
  const title = document.getElementById('cu-title').value;
  if (!title) {
    Swal.showValidationMessage('å˜å…ƒåã‚’å…¥åŠ›ã—ã¦ãã ã•ã„');
    return;
  }
  const data = {
    title: title,
    subject: document.getElementById('cu-subject').value,
    grade: document.getElementById('cu-grade').value,
    totalHours: parseInt(document.getElementById('cu-hours').value) || 8
  };
  
  showLoading();
  google.script.run
    .withSuccessHandler(res => {
      if (res.success) {
        google.script.run.withSuccessHandler(dataRes => {
          updateDataStore(dataRes.json);
          changeUnit(res.unitId);
          renderUnitSelector();
          hideLoading();
          Swal.close();
          Swal.fire('ä½œæˆå®Œäº†', 'æ–°ã—ã„å˜å…ƒã‚’ä½œæˆã—ã¾ã—ãŸ', 'success');
        }).getData();
      } else { handleError(res); }
    })
    .withFailureHandler(handleError)
    .createNewUnit(data);
}

function copyPrompt() {
  const el = document.getElementById('prompt-area');
  el.select();
  document.execCommand('copy');
  
  // ãƒœã‚¿ãƒ³ã®è¦‹ãŸç›®ã‚’ä¸€æ™‚çš„ã«å¤‰æ›´
  const btn = document.querySelector('button[onclick="copyPrompt()"]');
  const originHTML = btn.innerHTML;
  btn.innerHTML = '<i class="bi bi-check"></i> ã‚³ãƒ”ãƒ¼ã—ã¾ã—ãŸï¼';
  btn.classList.replace('btn-outline-primary', 'btn-success');
  setTimeout(() => {
    btn.innerHTML = originHTML;
    btn.classList.replace('btn-success', 'btn-outline-primary');
  }, 2000);
}

// [è¿½åŠ ] ãƒ—ãƒ­ãƒ³ãƒ—ãƒˆã‚’ã‚µãƒ¼ãƒãƒ¼ã«ä¿å­˜ã™ã‚‹é–¢æ•°
function saveCustomPrompt() {
  const text = document.getElementById('prompt-area').value;
  google.script.run
    .withSuccessHandler(() => showToast('success', 'ãƒ—ãƒ­ãƒ³ãƒ—ãƒˆè¨­å®šã‚’ä¿å­˜ã—ã¾ã—ãŸ'))
    .withFailureHandler(handleError)
    .saveCustomAiPrompt(text);
}

// [è¿½åŠ ] ãƒ—ãƒ­ãƒ³ãƒ—ãƒˆã‚’åˆæœŸå€¤ã«æˆ»ã™é–¢æ•°
function resetCustomPrompt() {
  if(confirm('ãƒ—ãƒ­ãƒ³ãƒ—ãƒˆã‚’åˆæœŸå€¤ã«æˆ»ã—ã¾ã™ã‹ï¼Ÿï¼ˆä¿å­˜ã™ã‚‹ã«ã¯ã€Œä¿å­˜ã€ãƒœã‚¿ãƒ³ã‚’æŠ¼ã—ã¦ãã ã•ã„ï¼‰')) {
    document.getElementById('prompt-area').value = DEFAULT_AI_PROMPT;
  }
}

function submitImportJson() {
  const jsonStr = document.getElementById('json-input').value;
  if (!jsonStr) return;
  
  try {
    JSON.parse(jsonStr); // ãƒãƒªãƒ‡ãƒ¼ã‚·ãƒ§ãƒ³
  } catch(e) {
    Swal.showValidationMessage('JSONå½¢å¼ãŒæ­£ã—ãã‚ã‚Šã¾ã›ã‚“');
    return;
  }

  showLoading();
  google.script.run.withSuccessHandler(d => {
    if (d.success) {
      google.script.run.withSuccessHandler(dataRes => {
        updateDataStore(dataRes.json);
        // æ–°ã—ã„å˜å…ƒãŒå«ã¾ã‚Œã¦ã„ã‚‹ã‹ç¢ºèªã—ã¦åˆ‡ã‚Šæ›¿ãˆï¼ˆç°¡æ˜“çš„ã«æœ€å¾Œã®å˜å…ƒã¸ï¼‰
        if (appState.unitList.length > 0) {
           const newUnit = appState.unitList[0]; // æœ€æ–°é †ãªã®ã§å…ˆé ­
           changeUnit(newUnit.id);
           renderUnitSelector();
        }
        hideLoading();
        Swal.close();
        Swal.fire('ã‚¤ãƒ³ãƒãƒ¼ãƒˆå®Œäº†', d.count + 'ä»¶ã®èª²é¡Œã‚’è¿½åŠ ã—ã¾ã—ãŸ', 'success');
      }).getData();
    } else { handleError(d); }
  }).importUnitJson(jsonStr);
}

// å…ˆç”Ÿç”¨é€²è¡Œç®¡ç†ç”»é¢
function renderControlView(container) {
  container.className = "flex-grow-1 overflow-auto p-3";
  const todayStr = new Date().toISOString().split('T')[0];
  const unitOptions = appState.unitList.map(u => `<option value="${u.id}">${u.title}</option>`).join('');
  
  const periodButtons = CONSTANTS.CLASS_PERIODS.map(p => 
    `<button class="btn btn-outline-secondary btn-sm me-1 mb-1" onclick="setScheduleTime('${p.start}', '${p.end}')">${p.label}</button>`
  ).join('');

  container.innerHTML = `
    <div class="row g-4">
      <div class="col-md-6">
        <div class="card border-0 shadow-sm rounded-4 h-100">
          <div class="card-header bg-white border-0 fw-bold text-primary">
            <i class="bi bi-calendar-event me-2"></i>æˆæ¥­ã‚¹ã‚±ã‚¸ãƒ¥ãƒ¼ãƒ«ã®é…ä¿¡
          </div>
          <div class="card-body">
            <p class="small text-muted">è¨­å®šã—ãŸæ—¥æ™‚ã«ã€å…ç«¥ã®ç”»é¢ã¸ã€Œæˆæ¥­ã¸ã®ç§»å‹•é€šçŸ¥ã€ã‚’è¡¨ç¤ºã—ã¾ã™ã€‚</p>
            <div class="mb-3">
              <label class="form-label small">æ—¥ä»˜</label>
              <input type="date" id="sc-date" class="form-control" value="${todayStr}">
            </div>
            
            <div class="mb-2">
              <label class="form-label small">æ™‚é–“å‰²ã‹ã‚‰é¸æŠ</label>
              <div>${periodButtons}</div>
            </div>

            <div class="row mb-3">
              <div class="col">
                <label class="form-label small">é–‹å§‹</label>
                <input type="time" id="sc-start" class="form-control" value="08:45">
              </div>
              <div class="col">
                <label class="form-label small">çµ‚äº†</label>
                <input type="time" id="sc-end" class="form-control" value="09:30">
              </div>
            </div>
            <div class="mb-3">
              <label class="form-label small">å˜å…ƒ</label>
              <select id="sc-unit" class="form-select">${unitOptions}</select>
            </div>
            <div class="mb-3">
              <label class="form-label small">æ™‚æ•°</label>
              <input type="number" id="sc-hour" class="form-control" value="1" min="1">
            </div>
            <div class="mb-3">
              <label class="form-label small">ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ï¼ˆä»»æ„ï¼‰</label>
              <input type="text" id="sc-msg" class="form-control" placeholder="ä¾‹ï¼šä»Šæ—¥ã¯ãƒ†ã‚¹ãƒˆã§ã™">
            </div>
            <button class="btn btn-primary w-100 rounded-pill" onclick="submitSchedule()">è¨­å®šã‚’é…ä¿¡ã™ã‚‹</button>
          </div>
        </div>
      </div>
      
      <div class="col-md-6">
        <div class="card border-0 shadow-sm rounded-4 h-100">
          <div class="card-header bg-white border-0 fw-bold text-success">
            <i class="bi bi-list-check me-2"></i>é…ä¿¡æ¸ˆã¿ã‚¹ã‚±ã‚¸ãƒ¥ãƒ¼ãƒ«
          </div>
          <div class="card-body">
            <div class="alert alert-light border small h-100 overflow-auto">
              <ul class="mb-0 ps-3">
                ${appState.schedules.map(s => {
                   const u = appState.unitList.find(ul => ul.id === s.unitId);
                   return `<li>${s.date} ${s.startTime}-${s.endTime}<br>
                   <strong>${u ? u.title : 'ä¸æ˜'}</strong> ç¬¬${s.hour}æ™‚<br>
                   <span class="text-muted">${s.message || ''}</span></li>`;
                }).join('') || 'äºˆå®šãªã—'}
              </ul>
            </div>
          </div>
        </div>
      </div>
    </div>
  `;
}

function setScheduleTime(start, end) {
  document.getElementById('sc-start').value = start;
  document.getElementById('sc-end').value = end;
}

function submitSchedule() {
  const data = {
    classId: appState.view.teacherClassId === 'All' ? '1çµ„' : appState.view.teacherClassId, 
    date: document.getElementById('sc-date').value,
    startTime: document.getElementById('sc-start').value,
    endTime: document.getElementById('sc-end').value,
    unitId: document.getElementById('sc-unit').value,
    hour: document.getElementById('sc-hour').value,
    message: document.getElementById('sc-msg').value
  };
  
  if(!data.date || !data.startTime || !data.endTime) return Swal.fire('ã‚¨ãƒ©ãƒ¼', 'æ—¥æ™‚ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„', 'error');
  
  google.script.run
    .withSuccessHandler(() => {
      showToast('success', 'ã‚¹ã‚±ã‚¸ãƒ¥ãƒ¼ãƒ«ã‚’é…ä¿¡ã—ã¾ã—ãŸ');
      loadMainData();
    })
    .saveClassSchedule(data);
}

// ------------------------------------

function getFilteredStudents() {
  if (appState.view.teacherClassId === 'All') return dataStore.liveStatus;
  return dataStore.liveStatus.filter(s => s.classId === appState.view.teacherClassId);
}

function renderLiveCards(container, students) {
  container.className = "flex-grow-1 overflow-auto"; 
  if (students.length === 0) {
    container.innerHTML = `<div class="text-muted p-5 text-center">è¡¨ç¤ºã™ã‚‹ç”Ÿå¾’ãŒã„ã¾ã›ã‚“</div>`;
  } else {
    container.innerHTML = `<div class="row row-cols-2 row-cols-md-4 row-cols-lg-5 g-3">${students.map(s => {
      const isOtherUnit = s.currentUnitId && s.currentUnitId !== appState.unit.id;
      const opacity = isOtherUnit ? '0.5' : '1';
      const taskDisplay = isOtherUnit ? '<span class="small text-secondary">ä»–å˜å…ƒã‚’å­¦ç¿’ä¸­</span>' : (s.task || '-');
      return `
      <div class="col">
        <div class="card h-100 text-center p-3 shadow-sm border-0 rounded-4 ${s.mode==='ãŸã™ã‘ã¦'?'sos-alert':''}" style="opacity: ${opacity}">
          <div class="fw-bold text-truncate mb-2">${s.name}</div>
          <i class="bi bi-person-circle fs-1 my-2 ${s.mode==='ãŸã™ã‘ã¦'?'text-danger':s.mode==='ã—ã‚…ã†ã¡ã‚…ã†'?'text-info':'text-secondary'}"></i>
          <div class="small text-muted text-truncate">${taskDisplay}</div>
          <div class="badge bg-light text-muted mt-1 fw-normal">${s.mode}</div>
        </div>
      </div>`;
    }).join('')}</div>`;
  }
}

function renderHeatmap(container, students) {
  container.className = "flex-grow-1 overflow-auto";
  const currentTasks = getCurrentUnitTasks();
  if (currentTasks.length === 0) { container.innerHTML = `<div class="text-center p-5">ã“ã®å˜å…ƒã®èª²é¡Œãƒ‡ãƒ¼ã‚¿ãªã—</div>`; return; }
  const studentNames = students.map(s => s.name).sort();
  if (studentNames.length === 0) { container.innerHTML = `<div class="text-center p-5">ç”Ÿå¾’ãƒ‡ãƒ¼ã‚¿ãªã—</div>`; return; }

  let h = `<div class="table-responsive mb-4"><table class="table table-borderless heatmap-table"><thead><tr><th style="min-width:100px;text-align:left">åå‰</th>${currentTasks.map((t, i) => `<th title="${t.title}" onclick="showTeacherTaskDetailSimple('${t.taskId}')">${t.step ? t.step.replace(/[^0-9]/g, '') : i + 1}</th>`).join('')}</tr></thead><tbody>`;
  
  studentNames.forEach(n => {
    const st = dataStore.liveStatus.find(d => d.name === n);
    const ic = (st && st.mode === 'ãŸã™ã‘ã¦') ? '<i class="bi bi-exclamation-circle-fill text-danger ms-1 animate__animated animate__flash"></i>' : (st && st.mode === 'ã—ã‚…ã†ã¡ã‚…ã†' ? '<i class="bi bi-lightning-fill text-info ms-1"></i>' : '');
    h += `<tr><td class="text-start fw-bold text-truncate" style="max-width:120px;cursor:pointer;text-decoration:underline" onclick="renderPortfolioModal('${n}', true)">${n}${ic}</td>`;
    
    currentTasks.forEach(t => {
      const p = (dataStore.clsProgress[n] && dataStore.clsProgress[n][t.taskId]) || {};
      const stamp = (dataStore.clsFeedback[n] && dataStore.clsFeedback[n][t.taskId]);
      let cls = "", icon = "";
      if (p.status === 'å®Œäº†') cls = "heatmap-done";
      else if (p.status === 'é€”ä¸­') cls = "heatmap-doing";
      else if (st && st.mode === 'ãŸã™ã‘ã¦') cls = "heatmap-sos";
      if (stamp) { if(stamp==='check') icon='âœ…'; if(stamp==='good') icon='ğŸ‘'; if(stamp==='great') icon='ğŸ’®'; if(stamp==='support') icon='ğŸš©'; }
      h += `<td><div class="heatmap-cell-wrapper" onclick="showStudentTaskDetail('${n}', '${t.taskId}')"><div class="heatmap-cell ${cls}" title="${t.title}">${icon}</div></div></td>`;
    });
    h += '</tr>';
  });
  
  const indexHtml = `<div class="card bg-light border-0 rounded-4 p-3 mt-3"><h6 class="fw-bold text-muted mb-2"><i class="bi bi-list-ol me-2"></i>èª²é¡Œã‚¤ãƒ³ãƒ‡ãƒƒã‚¯ã‚¹ï¼ˆ${appState.unit.title}ï¼‰</h6><div class="row row-cols-1 row-cols-md-2 g-2 small">${currentTasks.map((t, i) => `<div class="col" style="cursor:pointer" onclick="showTeacherTaskDetailSimple('${t.taskId}')"><span class="badge bg-secondary me-2" style="width:25px;">${t.step ? t.step.replace(/[^0-9]/g, '') : i + 1}</span><span class="badge bg-white text-dark border me-1">${t.category}</span><span class="text-truncate d-inline-block" style="max-width:200px;vertical-align:middle">${t.title}</span></div>`).join('')}</div></div>`;
  container.innerHTML = h + '</tbody></table></div>' + indexHtml;
}

function renderSeatingView(container) {
  const students = getFilteredStudents();
  if (students.length === 0) {
    container.innerHTML = `<div class="text-center p-5 text-muted">è¡¨ç¤ºã™ã‚‹ç”Ÿå¾’ãŒã„ã¾ã›ã‚“</div>`;
    return;
  }

  container.className = "flex-grow-1 d-flex flex-column overflow-hidden";
  container.innerHTML = `
    <div class="d-flex justify-content-between mb-2 flex-shrink-0">
      <div class="small text-muted"><i class="bi bi-info-circle me-1"></i>ã‚«ãƒ¼ãƒ‰ã‚’ãƒ‰ãƒ©ãƒƒã‚°ã—ã¦åº§å¸­ã‚’é…ç½®ã§ãã¾ã™ï¼ˆã‚°ãƒªãƒƒãƒ‰å¸ç€ã‚ã‚Šï¼‰</div>
      <button class="btn btn-primary btn-sm rounded-pill px-3" onclick="saveSeating()">é…ç½®ã‚’ä¿å­˜</button>
    </div>
    <div class="seating-wrapper border rounded-4 bg-light shadow-inner flex-grow-1 position-relative overflow-hidden">
       <div id="seating-canvas" class="seating-canvas position-absolute top-0 start-0 w-100 h-100 overflow-auto">
         <!-- Cards will be injected here -->
       </div>
    </div>`;

  const canvas = document.getElementById('seating-canvas');
  
  students.forEach(s => {
    const x = s.x || 50;
    const y = s.y || 50;
    
    const card = document.createElement('div');
    card.className = `card shadow-sm seat-card position-absolute ${s.mode==='ãŸã™ã‘ã¦'?'sos-alert':''}`;
    card.style.left = x + 'px';
    card.style.top = y + 'px';
    card.style.width = '100px';
    card.setAttribute('data-name', s.name);
    
    card.innerHTML = `
      <div class="card-body p-2 text-center" style="cursor: move;" onmousedown="startDragSeat(event, this)" ontouchstart="startDragSeat(event, this)">
        <div class="fw-bold text-truncate small mb-1">${s.name}</div>
        <i class="bi bi-person-circle fs-3 ${s.mode==='ãŸã™ã‘ã¦'?'text-danger':s.mode==='ã—ã‚…ã†ã¡ã‚…ã†'?'text-info':'text-secondary'}"></i>
        <div class="x-small text-muted text-truncate mt-1">${s.task || '-'}</div>
      </div>
    `;
    canvas.appendChild(card);
  });
}

function startDragSeat(e, cardBody) {
  e.preventDefault(); 
  const card = cardBody.parentElement;
  dragSrcEl = card;
  isDraggingSeat = true;
  
  const clientX = e.type.includes('mouse') ? e.clientX : e.touches[0].clientX;
  const clientY = e.type.includes('mouse') ? e.clientY : e.touches[0].clientY;
  
  const shiftX = clientX - card.getBoundingClientRect().left;
  const shiftY = clientY - card.getBoundingClientRect().top;
  
  const canvas = document.getElementById('seating-canvas');
  const canvasRect = canvas.getBoundingClientRect();

  function moveAt(pageX, pageY) {
    let newLeft = pageX - shiftX - canvasRect.left;
    let newTop = pageY - shiftY - canvasRect.top;
    
    if (newLeft < 0) newLeft = 0;
    if (newTop < 0) newTop = 0;
    if (newLeft > canvasRect.width - card.offsetWidth) newLeft = canvasRect.width - card.offsetWidth;
    if (newTop > canvasRect.height - card.offsetHeight) newTop = canvasRect.height - card.offsetHeight;

    card.style.left = newLeft + 'px';
    card.style.top = newTop + 'px';
  }

  function onMouseMove(e) {
    const px = e.type.includes('mouse') ? e.pageX : e.touches[0].pageX;
    const py = e.type.includes('mouse') ? e.pageY : e.touches[0].pageY;
    moveAt(px, py);
  }

  function onMouseUp() {
    document.removeEventListener('mousemove', onMouseMove);
    document.removeEventListener('mouseup', onMouseUp);
    document.removeEventListener('touchmove', onMouseMove);
    document.removeEventListener('touchend', onMouseUp);
    
    const GRID = CONSTANTS.SEAT_GRID_SIZE;
    const currentLeft = parseInt(card.style.left, 10);
    const currentTop = parseInt(card.style.top, 10);
    
    const snapLeft = Math.round(currentLeft / GRID) * GRID + 10;
    const snapTop = Math.round(currentTop / GRID) * GRID + 10;
    
    card.style.transition = 'all 0.2s ease-out';
    card.style.left = snapLeft + 'px';
    card.style.top = snapTop + 'px';
    
    setTimeout(() => { card.style.transition = ''; }, 200);

    dragSrcEl = null;
    isDraggingSeat = false;
  }

  document.addEventListener('mousemove', onMouseMove);
  document.addEventListener('mouseup', onMouseUp);
  document.addEventListener('touchmove', onMouseMove, {passive: false});
  document.addEventListener('touchend', onMouseUp);
}

function saveSeating() {
  const cards = document.querySelectorAll('.seat-card');
  const coords = [];
  cards.forEach(c => {
    coords.push({
      name: c.getAttribute('data-name'),
      x: parseInt(c.style.left, 10),
      y: parseInt(c.style.top, 10)
    });
  });
  
  google.script.run
    .withSuccessHandler(() => showToast('success', 'åº§å¸­é…ç½®ã‚’ä¿å­˜ã—ã¾ã—ãŸ'))
    .withFailureHandler(handleError)
    .saveSeatCoordinates(coords);
}

function renderSummaryListView(container) {
  container.className = "flex-grow-1 p-3 overflow-hidden d-flex flex-column"; 
  
  const students = getFilteredStudents().sort((a,b) => a.name.localeCompare(b.name));
  
  if (students.length === 0) {
    container.innerHTML = `<div class="text-center p-5 text-muted">è¡¨ç¤ºã™ã‚‹ç”Ÿå¾’ãŒã„ã¾ã›ã‚“</div>`;
    return;
  }

  let tableRows = '';
  students.forEach((s, index) => {
    let pf = {};
    if (dataStore.clsPortfolios && dataStore.clsPortfolios[s.name] && dataStore.clsPortfolios[s.name][appState.unit.id]) {
      const rawPf = dataStore.clsPortfolios[s.name][appState.unit.id];
      pf = (typeof rawPf === 'object') ? rawPf : { summary: rawPf, feedback: "", stamp: "" };
    }
    const summary = pf.summary || "";
    const feedback = pf.feedback || "";
    const stamp = pf.stamp || "";

    const skillCounts = {};
    SKILL_DEFINITIONS.forEach(def => skillCounts[def.id] = 0);
    
    if (dataStore.clsReflections && dataStore.clsReflections[s.name] && dataStore.clsReflections[s.name][appState.unit.id]) {
      const reflections = dataStore.clsReflections[s.name][appState.unit.id];
      Object.values(reflections).forEach(r => {
        if (r.skills && Array.isArray(r.skills)) {
          r.skills.forEach(sid => { if (skillCounts[sid] !== undefined) skillCounts[sid]++; });
        }
      });
    }

    let skillBadges = '';
    SKILL_DEFINITIONS.forEach(def => {
      const count = skillCounts[def.id];
      if (count > 0) {
        skillBadges += `<span class="skill-mini-badge bg-${def.color}" title="${def.label}: ${count}å›">${def.label.charAt(0)}${count}</span>`;
      }
    });
    if (!skillBadges) skillBadges = '<span class="text-muted small">-</span>';

    const uniqueId = `pf-${index}`;

    tableRows += `
      <tr>
        <td class="st-col-name text-center text-muted small align-middle">${index + 1}</td>
        <td class="st-col-name align-middle">
          <div class="fw-bold text-primary" style="cursor:pointer;" onclick="renderPortfolioModal('${s.name}', true)">
            ${s.name} <i class="bi bi-box-arrow-up-right small ms-1 text-muted"></i>
          </div>
        </td>
        <td class="st-col-skills align-middle">
          <div class="skill-badge-group">${skillBadges}</div>
        </td>
        <td class="st-col-summary">
          <div class="summary-text-area" id="summary-${uniqueId}" onclick="this.style.maxHeight='none'; this.style.cursor='text';" title="ã‚¯ãƒªãƒƒã‚¯ã§å…¨æ–‡è¡¨ç¤º">
            ${summary ? summary.replace(/\n/g, '<br>') : '<span class="summary-empty">æœªæå‡º</span>'}
          </div>
        </td>
        <td class="st-col-feedback align-middle">
          <div class="stamp-select-group">
            <label>
              <input type="radio" name="stamp-${uniqueId}" value="check" class="stamp-input" ${stamp==='check'?'checked':''}>
              <span class="stamp-option" title="ç¢ºèª">âœ…</span>
            </label>
            <label>
              <input type="radio" name="stamp-${uniqueId}" value="good" class="stamp-input" ${stamp==='good'?'checked':''}>
              <span class="stamp-option" title="ã„ã„ã­">ğŸ‘</span>
            </label>
            <label>
              <input type="radio" name="stamp-${uniqueId}" value="great" class="stamp-input" ${stamp==='great'?'checked':''}>
              <span class="stamp-option" title="ã™ã°ã‚‰ã—ã„">ğŸ’®</span>
            </label>
            <label>
              <input type="radio" name="stamp-${uniqueId}" value="support" class="stamp-input" ${stamp==='support'?'checked':''}>
              <span class="stamp-option" title="å¿œæ´">ğŸš©</span>
            </label>
          </div>
          <div class="input-group input-group-sm">
            <input type="text" id="fb-text-${uniqueId}" class="form-control" placeholder="ã‚³ãƒ¡ãƒ³ãƒˆã‚’å…¥åŠ›..." value="${feedback}">
            <button id="btn-save-${uniqueId}" class="btn btn-primary" onclick="saveListFeedback('${s.name}', '${uniqueId}')">ä¿å­˜</button>
          </div>
        </td>
      </tr>
    `;
  });

  container.innerHTML = `
    <div class="summary-table-container h-100">
      <table class="summary-table">
        <thead>
          <tr>
            <th class="text-center" style="width:40px;">#</th>
            <th class="st-col-name">åå‰</th>
            <th class="st-col-skills">ç²å¾—ã‚¹ã‚­ãƒ«</th>
            <th class="st-col-summary">å˜å…ƒã®ã¾ã¨ã‚</th>
            <th class="st-col-feedback">
              <div class="d-flex justify-content-between align-items-center">
                <span>ãƒ•ã‚£ãƒ¼ãƒ‰ãƒãƒƒã‚¯</span>
                <button id="btn-bulk-save" class="btn btn-success btn-sm rounded-pill px-3 shadow-sm" onclick="saveAllListFeedbacks()">
                  <i class="bi bi-save me-1"></i>ä¸€æ‹¬ä¿å­˜
                </button>
              </div>
            </th>
          </tr>
        </thead>
        <tbody>
          ${tableRows}
        </tbody>
      </table>
    </div>
  `;
}

function saveListFeedback(studentName, uniqueId) {
  const comment = document.getElementById(`fb-text-${uniqueId}`).value;
  const stampEl = document.querySelector(`input[name="stamp-${uniqueId}"]:checked`);
  const stamp = stampEl ? stampEl.value : "";
  
  const btn = document.getElementById(`btn-save-${uniqueId}`);
  const originalText = btn.innerHTML; 
  
  btn.disabled = true;
  btn.innerHTML = '<span class="spinner-border spinner-border-sm me-1" role="status" aria-hidden="true"></span>';
  
  if (!dataStore.clsPortfolios[studentName]) dataStore.clsPortfolios[studentName] = {};
  if (!dataStore.clsPortfolios[studentName][appState.unit.id]) dataStore.clsPortfolios[studentName][appState.unit.id] = {};
  
  let pf = dataStore.clsPortfolios[studentName][appState.unit.id];
  if (typeof pf !== 'object') {
    pf = { summary: pf || "" };
    dataStore.clsPortfolios[studentName][appState.unit.id] = pf;
  }
  pf.feedback = comment;
  pf.stamp = stamp;

  google.script.run
    .withSuccessHandler(() => {
      showToast('success', 'ä¿å­˜ã—ã¾ã—ãŸ');
      btn.disabled = false;
      btn.innerHTML = originalText;
    })
    .withFailureHandler((e) => {
      handleError(e);
      btn.disabled = false;
      btn.innerHTML = originalText;
    })
    .savePortfolioFeedback(studentName, appState.unit.id, comment, stamp);
}

function saveAllListFeedbacks() {
  const students = getFilteredStudents();
  if (students.length === 0) return;

  const btn = document.getElementById('btn-bulk-save');
  const originalHtml = btn.innerHTML;
  btn.disabled = true;
  btn.innerHTML = '<span class="spinner-border spinner-border-sm me-1"></span>ä¿å­˜ä¸­...';

  const feedbackList = [];

  students.forEach((s, index) => {
    const uniqueId = `pf-${index}`;
    const commentInput = document.getElementById(`fb-text-${uniqueId}`);
    const stampEl = document.querySelector(`input[name="stamp-${uniqueId}"]:checked`);
    
    if (commentInput) {
      const comment = commentInput.value;
      const stamp = stampEl ? stampEl.value : "";
      const unitId = appState.unit.id;

      if (!dataStore.clsPortfolios[s.name]) dataStore.clsPortfolios[s.name] = {};
      if (!dataStore.clsPortfolios[s.name][unitId]) dataStore.clsPortfolios[s.name][unitId] = {};

      let pf = dataStore.clsPortfolios[s.name][unitId];
      if (typeof pf !== 'object') {
        pf = { summary: pf || "" };
        dataStore.clsPortfolios[s.name][unitId] = pf;
      }
      pf.feedback = comment;
      pf.stamp = stamp;

      feedbackList.push({
        studentName: s.name,
        unitId: unitId,
        feedback: comment,
        stamp: stamp
      });
    }
  });

  google.script.run
    .withSuccessHandler(() => {
      showToast('success', 'å…¨å“¡åˆ†ã‚’ä¿å­˜ã—ã¾ã—ãŸ');
      btn.disabled = false;
      btn.innerHTML = originalHtml;
    })
    .withFailureHandler((e) => {
      handleError(e);
      btn.disabled = false;
      btn.innerHTML = originalHtml;
    })
    .saveAllPortfolios(feedbackList);
}

function confirmArchive() {
  Swal.fire({
    title: 'å˜å…ƒã‚¢ãƒ¼ã‚«ã‚¤ãƒ–',
    text: `ç¾åœ¨ã®å˜å…ƒã€Œ${appState.unit.title}ã€ã®ãƒ­ã‚°ãƒ‡ãƒ¼ã‚¿ã‚’åˆ¥ãƒ•ã‚¡ã‚¤ãƒ«ã«é€€é¿ã—ã€ã“ã®ã‚¢ãƒ—ãƒªã‹ã‚‰å‰Šé™¤ã—ã¾ã™ã€‚å®Ÿè¡Œã—ã¾ã™ã‹ï¼Ÿ`,
    icon: 'warning',
    showCancelButton: true,
    confirmButtonColor: '#d33',
    confirmButtonText: 'ã‚¢ãƒ¼ã‚«ã‚¤ãƒ–å®Ÿè¡Œ'
  }).then((result) => {
    if (result.isConfirmed) {
      showLoading();
      google.script.run
        .withSuccessHandler(res => {
          hideLoading();
          if (res.success) {
            Swal.fire('å®Œäº†', res.message, 'success');
            loadMainData();
          } else { handleError(res); }
        })
        .withFailureHandler(handleError)
        .archiveUnitData(appState.unit.id, appState.unit.title);
    }
  });
}

function showStudentAllData(name) {
  renderPortfolioModal(name, true);
}

// --- Utils ---
function showToast(icon, title) { Swal.fire({ toast: true, position: 'top-end', icon: icon, title: title, timer: 2000, showConfirmButton: false }); }
function handleError(err) { hideLoading(); Swal.fire({ title: 'ã‚·ã‚¹ãƒ†ãƒ ã‚¨ãƒ©ãƒ¼', text: err.message || err.toString(), icon: 'error' }); }
function showLoading() { const e = document.getElementById('loading'); if (e) e.classList.remove('d-none'); }
function hideLoading() { const e = document.getElementById('loading'); if (e) e.classList.add('d-none'); }
function toggleSettings() { if (document.getElementById('settingsModal')) { new bootstrap.Modal(document.getElementById('settingsModal')).show(); } }
function unlockAudio() { const audio = document.getElementById('sos-chime'); if (audio && !appState.sound.unlocked) { audio.volume = 0; audio.play().then(() => { audio.pause(); audio.currentTime = 0; audio.volume = 0.5; appState.sound.unlocked = true; }).catch(e => {}); } }
function checkSosAndPlaySound() { const currentSosCount = dataStore.liveStatus.filter(d => d.mode === 'ãŸã™ã‘ã¦').length; if (currentSosCount > appState.sound.prevSosCount) { const audio = document.getElementById('sos-chime'); if (audio) audio.play().catch(e => {}); } appState.sound.prevSosCount = currentSosCount; }

function getStepNumber(stepStr) {
  if(!stepStr) return -1;
  const match = stepStr.match(/\d+/);
  return match ? parseInt(match[0], 10) : -1;
}

function getCategoryColorClass(cat) {
  if (cat.includes('ã¾ãªã¶')) return 'border-start-manabu';
  if (cat.includes('ãµã‹ã‚ã‚‹')) return 'border-start-fukameru';
  if (cat.includes('ã¾ã¨ã‚ã‚‹')) return 'border-start-matomeru';
  if (cat === 'ãƒã‚¤ã‚¿ã‚¹ã‚¯') return 'border-start-mytask';
  return 'border-start-other';
}

function setStudentViewMode(mode) { appState.view.student = mode; renderStudentView(); }
function changeCurrentHour(h) { appState.unit.currentHour = parseInt(h); renderStudentView(); }

// ------------------------------------
//  æ™‚æ•°ç®¡ç†ãƒ­ã‚¸ãƒƒã‚¯
// ------------------------------------

function getEffectiveTotalHours() {
  if (appState.mode === 'student') {
    if (dataStore.studentPlan._meta && dataStore.studentPlan._meta.totalHours) {
      return parseInt(dataStore.studentPlan._meta.totalHours);
    }
  }
  return appState.unit.totalHours;
}

function changeStudentTotalHours(delta) {
  const current = getEffectiveTotalHours();
  const next = current + delta;
  if (next < 1) return;

  if (!dataStore.studentPlan._meta) dataStore.studentPlan._meta = {};
  dataStore.studentPlan._meta.totalHours = next;
  
  savePlan(); // ã‚µãƒ¼ãƒãƒ¼ã¸ä¿å­˜
  renderStudentPlanning(); // å†æç”»
}

// ------------------------------------
//  åŒæœŸãƒ­ã‚¸ãƒƒã‚¯
// ------------------------------------

function syncStudentPlan() { 
  const plans = dataStore.clsPlans[appState.user.name] || {}; 
  const currentPlan = plans[appState.unit.id] || {}; 
  
  if (!currentPlan._meta) {
    currentPlan._meta = {}; 
  }

  const total = currentPlan._meta.totalHours || appState.unit.totalHours;
  for (let i = 1; i <= total; i++) { 
    if (!currentPlan[String(i)]) currentPlan[String(i)] = []; 
  } 
  
  dataStore.studentPlan = currentPlan; 
}

// --- å…ç«¥ç”»é¢ç³»é–¢æ•° ---
function renderStudentView() { if (appState.view.student === 'planning') renderStudentPlanning(); else renderStudentDaily(); }

function renderStudentDaily() {
  const myStat = dataStore.liveStatus.find(d => d.name === appState.user.name) || { mode: 'é€šå¸¸' };
  const currentTasks = getCurrentUnitTasks();
  const myTasksFiltered = dataStore.myTasks.filter(t => t.unitId === appState.unit.id);
  const allTasks = [...currentTasks, ...myTasksFiltered];
  
  computedState.todaysPlanIds = new Set();
  const hourKey = String(appState.unit.currentHour);
  const plannedIds = dataStore.studentPlan[hourKey] || [];
  plannedIds.forEach(tid => computedState.todaysPlanIds.add(tid));
  
  allTasks.forEach(t => { 
    if (t.format === 'teacher') {
      const stepNum = getStepNumber(t.step);
      if (stepNum === appState.unit.currentHour) {
        computedState.todaysPlanIds.add(t.taskId);
      }
    }
  });

  const todaysTasks = allTasks.filter(t => computedState.todaysPlanIds.has(t.taskId));
  let totalTime = 0; todaysTasks.forEach(t => totalTime += t.time);
  const timePercent = Math.min((totalTime / CONSTANTS.UNIT_TIME) * 100, 100);
  let timeColor = totalTime > CONSTANTS.UNIT_TIME ? 'bg-danger' : (totalTime > CONSTANTS.UNIT_TIME * 0.8 ? 'bg-warning' : 'bg-success');
  let taskListHtml = todaysTasks.length === 0 ? `<div class="text-center py-5 text-muted"><p>è¨ˆç”»ãªã—</p><button class="btn btn-outline-primary rounded-pill" onclick="setStudentViewMode('planning')">è¨ˆç”»ã‚’ç«‹ã¦ã‚‹</button></div>` : todaysTasks.map(t => createStudentTaskCard(t)).join('');
  
  const effectiveHours = getEffectiveTotalHours();
  let hourOptions = ''; 
  for(let i = 1; i <= effectiveHours; i++) { 
    hourOptions += `<option value="${i}" ${i === appState.unit.currentHour ? 'selected' : ''}>ç¬¬${i}æ™‚</option>`; 
  }
  
  let stBadge = ''; let rstBtn = 'd-none';
  if (myStat.mode === 'ãŸã™ã‘ã¦') { stBadge = `<span class="badge bg-danger rounded-pill px-2 py-1 me-2 animate__animated animate__flash">SOS</span>`; rstBtn = ''; } 
  else if (myStat.mode === 'ã—ã‚…ã†ã¡ã‚…ã†') { stBadge = `<span class="badge bg-info text-white rounded-pill px-2 py-1 me-2 animate__animated animate__pulse">é›†ä¸­</span>`; rstBtn = ''; }
  
  // å˜å…ƒæƒ…å ±ã®è¡¨ç¤º
  const currentUnit = appState.unitList.find(u => u.id === appState.unit.id) || {};
  const goalHtml = currentUnit.goal 
    ? `<div class="alert alert-success border-0 shadow-sm d-flex align-items-center py-2 px-3 mb-3 small">
         <i class="bi bi-flag-fill text-success me-2 fs-5"></i>
         <div class="fw-bold flex-grow-1">${currentUnit.goal}</div>
       </div>`
    : '';

  document.getElementById('app-container').innerHTML = `
    ${goalHtml}
    <div class="timeline-container shadow-sm p-3 mb-3 rounded-bottom border-bottom">
      <div class="d-flex justify-content-between align-items-center mb-2">
        <select class="form-select form-select-sm w-auto fw-bold text-primary border-0 bg-transparent" onchange="changeCurrentHour(this.value)">${hourOptions}</select>
        <div class="small fw-bold ${totalTime > CONSTANTS.UNIT_TIME ? 'text-danger' : 'text-muted'}">${totalTime} / ${CONSTANTS.UNIT_TIME}åˆ†</div>
      </div>
      <div class="progress" style="height: 1.5rem;"><div class="progress-bar progress-bar-striped ${timeColor}" role="progressbar" style="width: ${timePercent}%"></div></div>
    </div>
    <div class="px-2">
      <div class="d-flex justify-content-between align-items-center mb-3">
        <div class="fw-bold text-primary me-2 text-truncate" style="max-width:150px;"><i class="bi bi-person-circle me-1"></i>${appState.user.name} <span class="badge bg-light text-secondary border ms-1">${appState.user.classId}</span></div>
        <div class="d-flex gap-2">
          <button class="btn btn-outline-primary btn-sm rounded-pill" onclick="setStudentViewMode('planning')"><i class="bi bi-calendar-range"></i> <ruby>è¨ˆç”»<rt>ã‘ã„ã‹ã</rt></ruby></button>
          <button class="btn btn-outline-secondary btn-sm rounded-pill" onclick="renderPortfolioModal('${appState.user.name}')"><i class="bi bi-journal-text"></i></button>
          <button class="btn btn-outline-success btn-sm rounded-pill" onclick="openDailyReflectionModal()"><i class="bi bi-pencil-square"></i> ãµã‚Šã‹ãˆã‚Š</button>
        </div>
      </div>
      <div class="d-flex justify-content-end align-items-center mb-2">${stBadge}<div class="d-flex gap-1"><button class="btn btn-danger btn-sm rounded-pill px-3" onclick="submitUserStatus('ãŸã™ã‘ã¦')">SOS</button><button class="btn btn-info btn-sm rounded-pill px-3 text-white" onclick="submitUserStatus('ã—ã‚…ã†ã¡ã‚…ã†')">é›†ä¸­</button><button class="btn btn-secondary btn-sm rounded-pill px-3 ${rstBtn}" onclick="submitUserStatus('é€šå¸¸')">è§£é™¤</button></div></div>
      ${taskListHtml}
      <div class="d-grid gap-2 mb-4 mt-3"><button class="btn btn-outline-primary border-2 border-dashed py-3 rounded-4" onclick="openMyTaskModal()"><i class="bi bi-plus-circle-fill me-2"></i>ã˜ã¶ã‚“ã®<ruby>èª²é¡Œ<rt>ã‹ã ã„</rt></ruby></button></div>
    </div>`;
}

function createStudentTaskCard(t) {
  const prog = dataStore.studentProgress[t.taskId] || {};
  const stamp = dataStore.studentFeedback[t.taskId];
  const isDone = prog.status === 'å®Œäº†'; const isDoing = prog.status === 'é€”ä¸­';
  let isLocked = false;
  if (t.prerequisites && t.prerequisites.length > 0) {
    const allPreDone = t.prerequisites.every(pid => (dataStore.studentProgress[pid] && dataStore.studentProgress[pid].status === 'å®Œäº†'));
    if (!allPreDone) isLocked = true;
  }
  const cardClass = isLocked ? 'card-locked' : '';
  const borderClass = getCategoryColorClass(t.category);
  
  let stampHtml = stamp ? `<div class="stamp-badge animate__animated animate__bounceIn">${{'check':'âœ…','good':'ğŸ‘','great':'ğŸ’®','support':'ğŸš©'}[stamp]||''}</div>` : '';
  let actionBtn = '';
  if (isDone) { actionBtn = `<button class="btn btn-secondary rounded-pill px-3 btn-sm fw-bold" disabled>å®Œäº†</button>`; } 
  else {
    const doingBtn = isDoing ? 'btn-warning text-dark' : 'btn-outline-warning text-dark';
    let buttons = `<button class="btn btn-outline-success rounded-pill px-3 btn-sm fw-bold" onclick="event.stopPropagation(); submitTaskProgress('${t.taskId}','å®Œäº†',this)">ã§ããŸ</button>`;
    if (t.format !== 'teacher') buttons = `<button class="btn ${doingBtn} rounded-pill px-3 btn-sm fw-bold me-1" onclick="event.stopPropagation(); submitTaskProgress('${t.taskId}','é€”ä¸­',this)">é€”ä¸­</button>` + buttons;
    actionBtn = buttons;
  }
  if (t.format === 'teacher') actionBtn = `<span class="badge bg-info text-white me-2">å…ˆç”Ÿ</span>` + actionBtn;
  return `
    <div class="card shadow-sm mb-3 card-task ${cardClass} ${borderClass} position-relative" style="cursor:pointer;" onclick="openTaskDetailModal('${t.taskId}')">
      ${stampHtml}
      ${isLocked ? `<div class="position-absolute top-50 start-50 translate-middle text-center" style="z-index:2"><i class="bi bi-lock-fill fs-1 text-secondary"></i><br><span class="badge bg-secondary">ãƒ­ãƒƒã‚¯ä¸­</span></div>` : ''}
      <div class="card-body">
        <div class="d-flex justify-content-end align-items-center mb-2">
           <div class="text-end"><span class="badge bg-light text-secondary border">${t.time}åˆ†</span></div>
        </div>
        <h5 class="fw-bold mb-2">${t.title}</h5>
        <div class="d-flex justify-content-between align-items-center mt-1">
          <span class="badge bg-light text-secondary border rounded-pill" style="font-size:0.6rem">${t.category}</span>
          <div class="text-end">${actionBtn}</div>
        </div>
      </div>
    </div>`;
}

function getCategoryColorClass(cat) {
  if (cat.includes('ã¾ãªã¶')) return 'border-start-manabu';
  if (cat.includes('ãµã‹ã‚ã‚‹')) return 'border-start-fukameru';
  if (cat.includes('ã¾ã¨ã‚ã‚‹')) return 'border-start-matomeru';
  if (cat === 'ãƒã‚¤ã‚¿ã‚¹ã‚¯') return 'border-start-mytask';
  return 'border-start-other';
}

function setStudentViewMode(mode) { appState.view.student = mode; renderStudentView(); }
function changeCurrentHour(h) { appState.unit.currentHour = parseInt(h); renderStudentView(); }

function getStepNumber(stepStr) {
  if(!stepStr) return -1;
  const match = stepStr.match(/\d+/);
  return match ? parseInt(match[0], 10) : -1;
}

function renderStudentPlanning() {
  const planContainer = document.querySelector('.plan-container'); const scrollX = planContainer ? planContainer.scrollLeft : 0;
  const poolContainer = document.getElementById('task-pool-container'); const poolScrollY = poolContainer ? poolContainer.scrollTop : 0;
  const currentTasks = getCurrentUnitTasks();
  const myTasksFiltered = dataStore.myTasks.filter(t => t.unitId === appState.unit.id);
  const allTasks = [...currentTasks, ...myTasksFiltered];
  
  let taskPoolHtml = `<div class="d-grid gap-2 mb-3 sticky-top bg-white pt-2 pb-2 border-bottom" style="top:0; z-index:5;"><button class="btn btn-outline-primary btn-sm rounded-pill border-dashed" onclick="openMyTaskModal()"><i class="bi bi-plus-lg me-1"></i><ruby>èª²é¡Œ<rt>ã‹ã ã„</rt></ruby>ä½œæˆ</button></div>`;
  
  // ã‚¿ã‚¹ã‚¯ãƒ—ãƒ¼ãƒ«ï¼ˆå·¦å´ï¼‰
  allTasks.filter(t => t.format !== 'teacher').forEach(t => { 
    const borderClass = getCategoryColorClass(t.category);
    taskPoolHtml += `<div class="card p-2 mb-2 shadow-sm task-draggable ${borderClass}" style="${t.category==='ãƒã‚¤ã‚¿ã‚¹ã‚¯'?'background-color:#fbf5ff;':''}" data-id="${t.taskId}" onclick="openTaskDetailModal('${t.taskId}')">
        <div class="small fw-bold">${t.title}</div>
        <div class="d-flex justify-content-between align-items-center mt-1">
          <span class="badge bg-light text-secondary border rounded-pill" style="font-size:0.6rem">${t.category}</span>
          <span class="x-small text-muted">${t.time}åˆ†</span>
        </div>
      </div>`; 
  });
  
  const effectiveHours = getEffectiveTotalHours();
  let hoursHtml = '';
  
  // å„æ™‚æ•°ã®è¨ˆç”»ï¼ˆå³å´ï¼‰
  for(let i = 1; i <= effectiveHours; i++) {
    let plannedTasksHtml = '';
    const plannedIds = dataStore.studentPlan[String(i)] || [];
    let hourTotalTime = 0;
    const addedTaskIds = new Set(); 

    // 1. å…ˆç”Ÿã‚¿ã‚¹ã‚¯ï¼ˆå›ºå®šï¼‰
    allTasks.forEach(t => {
      if (t.format === 'teacher' && getStepNumber(t.step) === i) {
        hourTotalTime += t.time;
        const borderClass = getCategoryColorClass(t.category);
        plannedTasksHtml += `<div class="card p-2 mb-2 shadow-sm ${borderClass}" style="opacity:0.9;" onclick="openTaskDetailModal('${t.taskId}')">
          <div class="d-flex justify-content-between align-items-center">
            <span class="small fw-bold text-truncate"><span class="badge bg-info text-white me-1" style="font-size:0.6em">å›ºå®š</span>${t.title}</span>
          </div>
          <div class="d-flex justify-content-between align-items-center mt-1">
            <span class="badge bg-light text-secondary border rounded-pill" style="font-size:0.6rem">${t.category}</span>
            <span class="x-small text-muted">${t.time}åˆ†</span>
          </div>
        </div>`;
        addedTaskIds.add(t.taskId);
      }
    });

    // 2. ç”Ÿå¾’ã‚¿ã‚¹ã‚¯
    plannedIds.forEach(tid => {
      if (addedTaskIds.has(tid)) return;

      const t = allTasks.find(x => x.taskId === tid);
      if (t) {
        hourTotalTime += t.time;
        const borderClass = getCategoryColorClass(t.category);
        plannedTasksHtml += `<div class="card p-2 mb-2 shadow-sm task-draggable ${borderClass}" style="${t.category==='ãƒã‚¤ã‚¿ã‚¹ã‚¯'?'background-color:#fbf5ff;':''}" data-id="${t.taskId}" onclick="openTaskDetailModal('${t.taskId}')">
            <div class="d-flex justify-content-between">
              <span class="small fw-bold text-truncate">${t.title}</span>
              <i class="bi bi-x text-danger" style="cursor:pointer" onclick="event.stopPropagation(); removeFromPlan('${String(i)}', '${tid}')"></i>
            </div>
            <div class="d-flex justify-content-between align-items-center mt-1">
              <span class="badge bg-light text-secondary border rounded-pill" style="font-size:0.6rem">${t.category}</span>
              <span class="x-small text-muted">${t.time}åˆ†</span>
            </div>
          </div>`;
      }
    });

    const timeRatio = Math.min(hourTotalTime / CONSTANTS.UNIT_TIME, 1) * 100;
    const barColor = hourTotalTime > CONSTANTS.UNIT_TIME ? '#ffcdd2' : '#c8e6c9'; 
    const headerStyle = `background: linear-gradient(90deg, ${barColor} ${timeRatio}%, #f8f9fa ${timeRatio}%);`;

    hoursHtml += `
      <div class="plan-hour-row mb-3">
        <div class="plan-hour-header-v p-2 fw-bold text-center border rounded-top position-relative" style="${headerStyle}">
          ç¬¬${i}æ™‚ <span class="small ms-2 fw-normal badge bg-white text-dark border">${hourTotalTime}åˆ†</span>
        </div>
        <div class="plan-drop-zone-v p-2 border border-top-0 rounded-bottom" data-hour="${i}" style="min-height: 80px; background-color: #fff;">
          ${plannedTasksHtml}
        </div>
      </div>`;
  }

  document.getElementById('app-container').innerHTML = `
    <div class="p-3 d-flex flex-column h-100">
      <div class="d-flex justify-content-between align-items-center mb-3 flex-shrink-0">
        <div class="d-flex align-items-center">
          <h5 class="fw-bold m-0 me-3"><i class="bi bi-calendar-range me-2 text-primary"></i><ruby>è¨ˆç”»<rt>ã‘ã„ã‹ã</rt></ruby>ãƒ¢ãƒ¼ãƒ‰</h5>
          <!-- æ™‚æ•°å¤‰æ›´ãƒœã‚¿ãƒ³ -->
          <div class="input-group input-group-sm w-auto">
            <span class="input-group-text bg-white">å…¨</span>
            <input type="text" class="form-control text-center fw-bold bg-white" value="${effectiveHours}" style="width:40px;" readonly>
            <button class="btn btn-outline-secondary" onclick="changeStudentTotalHours(1)"><i class="bi bi-plus-lg"></i></button>
            <button class="btn btn-outline-secondary" onclick="changeStudentTotalHours(-1)"><i class="bi bi-dash-lg"></i></button>
          </div>
        </div>
        <button class="btn btn-primary rounded-pill px-4 shadow-sm" onclick="setStudentViewMode('daily')"><ruby>å®Œäº†<rt>ã‹ã‚“ã‚Šã‚‡ã†</rt></ruby></button>
      </div>
      <div class="row flex-grow-1" style="min-height:0; height: calc(100vh - 150px);">
        <!-- å·¦å´ï¼šèª²é¡Œãƒ—ãƒ¼ãƒ« -->
        <div class="col-4 h-100 border-end bg-white rounded-start d-flex flex-column">
          <div class="small text-muted mb-2 flex-shrink-0 p-2 border-bottom">èª²é¡Œãƒªã‚¹ãƒˆ</div>
          <div id="task-pool-container" class="flex-grow-1 overflow-auto p-2"><div id="task-pool">${taskPoolHtml}</div></div>
        </div>
        <!-- å³å´ï¼šè¨ˆç”»è¡¨ï¼ˆç¸¦ã‚¹ã‚¯ãƒ­ãƒ¼ãƒ«ï¼‰ -->
        <div class="col-8 h-100 overflow-auto">
          <div class="plan-container-v h-100 pt-2">
            ${hoursHtml}
          </div>
        </div>
      </div>
    </div>`;

  const newPoolContainer = document.getElementById('task-pool-container'); if (newPoolContainer) newPoolContainer.scrollTop = poolScrollY;
  
  new Sortable(document.getElementById('task-pool'), { group: { name: 'shared', pull: 'clone', put: false }, sort: false, animation: 150 });
  
  document.querySelectorAll('.plan-drop-zone-v').forEach(el => {
    new Sortable(el, {
      group: 'shared',
      sort: true,
      animation: 150,
      draggable: ".task-draggable", 
      onAdd: function (evt) {
        const tid = evt.item.getAttribute('data-id');
        const h = String(evt.to.getAttribute('data-hour'));
        addToPlan(h, tid);
        evt.item.remove();
      }
    });
  });
}

function addToPlan(hour, taskId) { 
  if (!dataStore.studentPlan[hour]) dataStore.studentPlan[hour] = []; 
  dataStore.studentPlan[hour].push(taskId); 
  savePlan(); 
  renderStudentPlanning(); 
}

// é…åˆ—ã®é †åºé€šã‚Šã«è¨ˆç”»ã‚’ä¿å­˜ã™ã‚‹ãƒ˜ãƒ«ãƒ‘ãƒ¼é–¢æ•°
function updatePlanByOrder(hour, newOrderArray) {
  // ä¿®æ­£: å…ˆç”Ÿã‚¿ã‚¹ã‚¯ã‚’é™¤å¤–ã›ãšã«ã€ç¾åœ¨ã®ä¸¦ã³é †ï¼ˆnewOrderArrayï¼‰ã‚’ãã®ã¾ã¾ä¿å­˜ã™ã‚‹
  // ã“ã‚Œã«ã‚ˆã‚Šã€[å…ˆç”Ÿã‚¿ã‚¹ã‚¯] -> [ç”Ÿå¾’ã‚¿ã‚¹ã‚¯] -> [å…ˆç”Ÿã‚¿ã‚¹ã‚¯] ã®ã‚ˆã†ãªã‚µãƒ³ãƒ‰ã‚¤ãƒƒãƒé…ç½®ãŒå¯èƒ½ã«ãªã‚‹
  dataStore.studentPlan[hour] = newOrderArray;
  savePlan();
}

function removeFromPlan(hour, taskId) { 
  if (dataStore.studentPlan[hour]) { 
    dataStore.studentPlan[hour] = dataStore.studentPlan[hour].filter(id => id !== taskId); 
    savePlan(); 
    renderStudentPlanning(); 
  } 
}

function openImportModal() { Swal.fire({ title: 'JSONã‚¤ãƒ³ãƒãƒ¼ãƒˆ', html: '<textarea id="ji" class="form-control" rows="10"></textarea>', showCancelButton: true, confirmButtonText: 'å®Ÿè¡Œ' }).then(r => { if (r.isConfirmed) { showLoading(); google.script.run.withSuccessHandler(d => { hideLoading(); Swal.fire('å®Œäº†', d.count + 'ä»¶', 'success'); loadMainData(); }).importUnitJson(document.getElementById('ji').value); } }); }
function showStudentTaskDetail(name, tid) { const t = dataStore.masterTasks.find(x => x.taskId === tid); const p = (dataStore.clsProgress[name] && dataStore.clsProgress[name][tid]) || {}; Swal.fire({ title: `${name} ã•ã‚“ã®çŠ¶æ³`, html: `<div class="text-start"><h6 class="fw-bold text-primary">${t.title}</h6><div class="mb-3"><span class="badge bg-secondary me-1">çŠ¶æ…‹: ${p.status||'æœª'}</span></div><div class="p-3 bg-light rounded mb-3 small">${p.reflection||'ãƒ¡ãƒ¢ãªã—'}</div><hr><div class="d-flex justify-content-center gap-2"><button class="btn btn-outline-primary rounded-circle p-2" style="width:50px;height:50px;font-size:1.5rem" onclick="sendStamp('${name}','${tid}','check')">âœ…</button><button class="btn btn-outline-primary rounded-circle p-2" style="width:50px;height:50px;font-size:1.5rem" onclick="sendStamp('${name}','${tid}','good')">ğŸ‘</button><button class="btn btn-outline-primary rounded-circle p-2" style="width:50px;height:50px;font-size:1.5rem" onclick="sendStamp('${name}','${tid}','great')">ğŸ’®</button><button class="btn btn-outline-primary rounded-circle p-2" style="width:50px;height:50px;font-size:1.5rem" onclick="sendStamp('${name}','${tid}','support')">ğŸš©</button></div></div>`, showConfirmButton: false, showCloseButton: true }); }
function sendStamp(name, tid, stamp) { if (!dataStore.clsFeedback[name]) dataStore.clsFeedback[name] = {}; dataStore.clsFeedback[name][tid] = stamp; renderTeacherDashboardContent(); showToast('success', 'ã‚¹ã‚¿ãƒ³ãƒ—é€ä¿¡'); google.script.run.sendFeedback(name, tid, stamp, appState.view.teacherClassId !== 'All' ? appState.view.teacherClassId : ''); }
function showTeacherTaskDetailSimple(tid) { const t = dataStore.masterTasks.find(x => x.taskId === tid); if (!t) return; Swal.fire({ title: t.title, html: `<div class="text-start"><p class="text-muted border p-3 rounded bg-light mb-0">${t.desc || 'èª¬æ˜ãªã—'}</p><div class="mt-2 text-end small text-muted">æ™‚é–“: ${t.time}åˆ†</div></div>`, showConfirmButton: false, showCloseButton: true }); }

function openMyTaskModal() { 
  Swal.fire({ 
    title: 'ã˜ã¶ã‚“ã®èª²é¡Œ', 
    html: `<div class="text-start"><label class="form-label small fw-bold">ã‚¿ã‚¤ãƒˆãƒ«</label><input id="mt-title" class="form-control mb-3"><label class="form-label small fw-bold">ã‚ã‚ã¦</label><textarea id="mt-desc" class="form-control mb-3" rows="2"></textarea><label class="form-label small fw-bold">æ™‚é–“</label><input id="mt-time" type="number" class="form-control" value="15"></div>`, 
    showCancelButton: true, 
    confirmButtonText: 'è¿½åŠ ', 
    preConfirm: () => { 
      const t = document.getElementById('mt-title').value; 
      if (!t) Swal.showValidationMessage('ã‚¿ã‚¤ãƒˆãƒ«å¿…é ˆ'); 
      return { title: t, desc: document.getElementById('mt-desc').value, time: document.getElementById('mt-time').value }; 
    } 
  }).then(r => { 
    if (r.isConfirmed) { 
      const v = r.value; 
      google.script.run.withSuccessHandler((res) => { 
        // ã‚µãƒ¼ãƒãƒ¼ã‹ã‚‰è¿”ã•ã‚ŒãŸIDã‚’ä½¿ç”¨
        const newId = (res && res.taskId) ? res.taskId : "MT_TEMP";
        dataStore.myTasks.push({ 
          taskId: newId, 
          title: v.title, 
          desc: v.desc, 
          time: parseInt(v.time), 
          category: 'ãƒã‚¤ã‚¿ã‚¹ã‚¯', 
          type: 'challenge', 
          format: 'student',
          unitId: appState.unit.id
        }); 
        
        if (appState.view.student === 'planning') {
          renderStudentPlanning(); 
        } else {
          // Dailyãƒ“ãƒ¥ãƒ¼ã®å ´åˆã¯ã€ç¾åœ¨ã®æ™‚æ•°ã«è‡ªå‹•ç™»éŒ²ã™ã‚‹
          const currentHour = String(appState.unit.currentHour);
          if (!dataStore.studentPlan[currentHour]) dataStore.studentPlan[currentHour] = [];
          dataStore.studentPlan[currentHour].push(newId);
          savePlan(); // è¨ˆç”»ã‚’ä¿å­˜
          
          loginStudent(true); // ç”»é¢æ›´æ–°
        }
        showToast('success', 'èª²é¡Œã‚’è¿½åŠ ã—ã€è¨ˆç”»ã«ç™»éŒ²ã—ã¾ã—ãŸ'); 
      }).addMyTask(appState.user.name, v.title, v.desc, v.time, appState.unit.id, appState.user.classId); 
    } 
  }); 
}

function openTaskDetailModal(taskId) { const allTasks = [...dataStore.masterTasks, ...dataStore.myTasks]; const t = allTasks.find(x => x.taskId === taskId); if (!t || t.isLocked) return; const mem = (dataStore.studentProgress[taskId] || {}).reflection || ""; Swal.fire({ title: t.title, html: `<div class="text-start"><p class="small bg-light p-2 rounded">${t.desc || ""}</p><label class="form-label fw-bold small">ãƒ¡ãƒ¢</label><textarea id="ref-txt" class="form-control" rows="3">${mem}</textarea></div>`, showCancelButton: true, confirmButtonText: 'ä¿å­˜' }).then(r => { if (r.isConfirmed) { const txt = document.getElementById('ref-txt').value; if (txt !== mem) { if (!dataStore.studentProgress[taskId]) dataStore.studentProgress[taskId] = {}; dataStore.studentProgress[taskId].reflection = txt; const curStatus = dataStore.studentProgress[taskId].status || 'æœªç€æ‰‹'; google.script.run.updateStatus(appState.user.name, t.taskId, t.title, curStatus, 'é€šå¸¸', txt, appState.user.classId, appState.unit.id); showToast('success', 'ä¿å­˜å®Œäº†'); renderStudentView(); } } }); }

/**
 * å˜å…ƒè©³ç´°æƒ…å ±ï¼ˆã‚ã‚ã¦ãƒ»æ¦‚è¦ï¼‰ã‚’è¡¨ç¤ºã™ã‚‹ãƒ¢ãƒ¼ãƒ€ãƒ«
 */
function showUnitInfoModal() {
  const unit = appState.unitList.find(u => u.id === appState.unit.id);
  if (!unit) return;

  Swal.fire({
    title: `<div class="fs-5 fw-bold text-primary">${unit.subject} ${unit.grade ? '('+unit.grade+')' : ''}</div><div class="fs-4">${unit.title}</div>`,
    html: `
      <div class="text-start p-2">
        <div class="mb-3">
          <label class="small text-muted fw-bold">å˜å…ƒã®ã‚ã‚ã¦</label>
          <div class="p-3 bg-light rounded border-start border-5 border-success">
            <i class="bi bi-flag-fill text-success me-2"></i>
            <span class="fw-bold text-dark">${unit.goal || 'ï¼ˆç›®æ¨™ã¯è¨­å®šã•ã‚Œã¦ã„ã¾ã›ã‚“ï¼‰'}</span>
          </div>
        </div>
        <div class="mb-3">
          <label class="small text-muted fw-bold">æ¦‚è¦</label>
          <div class="small text-secondary">
            ${unit.description ? unit.description.replace(/\n/g, '<br>') : 'ï¼ˆæ¦‚è¦ã¯ã‚ã‚Šã¾ã›ã‚“ï¼‰'}
          </div>
        </div>
        <div class="text-end small text-muted">
          ç·æ™‚æ•°: ${unit.totalHours}æ™‚é–“
        </div>
      </div>
    `,
    showCloseButton: true,
    showConfirmButton: false,
    width: '500px'
  });
}

// --- å…ˆç”Ÿèªè¨¼é–¢é€£ ---
function attemptTeacherLogin() {
  Swal.fire({
    title: 'æ•™å“¡ç”¨ãƒ­ã‚°ã‚¤ãƒ³',
    input: 'password',
    inputAttributes: { autocapitalize: 'off' },
    showCancelButton: true,
    confirmButtonText: 'ãƒ­ã‚°ã‚¤ãƒ³',
    showLoaderOnConfirm: true,
    preConfirm: (pass) => {
      return new Promise((resolve, reject) => {
        google.script.run.withSuccessHandler(res => {
          if (res.authenticated) {
            resolve(true); 
          } else {
            Swal.showValidationMessage('ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ãŒé•ã„ã¾ã™');
            resolve(false); 
          }
        }).withFailureHandler(e => { Swal.showValidationMessage(e.message); resolve(false); }).verifyPassword(pass);
      });
    }
  }).then((result) => {
    // ãƒãƒªãƒ‡ãƒ¼ã‚·ãƒ§ãƒ³ã‚¨ãƒ©ãƒ¼æ™‚ã¯resultãŒfalseã«ãªã‚‹ãŸã‚ã€isConfirmedã ã‘ã‚’ãƒã‚§ãƒƒã‚¯
    if (result.isConfirmed) {
      switchMode('teacher');
      showToast('success', 'å…ˆç”Ÿãƒ¢ãƒ¼ãƒ‰ã§ãƒ­ã‚°ã‚¤ãƒ³ã—ã¾ã—ãŸ');
    }
  });
}

function changePasswordPrompt() {
  Swal.fire({
    title: 'ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰å¤‰æ›´',
    input: 'text',
    inputLabel: 'æ–°ã—ã„ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ã‚’å…¥åŠ›',
    showCancelButton: true,
    confirmButtonText: 'å¤‰æ›´'
  }).then(r => {
    if (r.isConfirmed && r.value) {
      google.script.run.withSuccessHandler(() => Swal.fire('å®Œäº†', 'ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ã‚’å¤‰æ›´ã—ã¾ã—ãŸ', 'success'))
      .changeTeacherPassword(r.value);
    }
  });
}

// ------------------------------------
//  åç°¿ç®¡ç†æ©Ÿèƒ½ (New)
// ------------------------------------

function openRosterManagerModal() {
  // è¨­å®šãƒ¢ãƒ¼ãƒ€ãƒ«ã‚’ä¸€æ—¦é–‰ã˜ã‚‹
  const settingsModalEl = document.getElementById('settingsModal');
  const modal = bootstrap.Modal.getInstance(settingsModalEl);
  if (modal) modal.hide();

  Swal.fire({
    title: '<i class="bi bi-people-fill me-2"></i>åç°¿ç®¡ç†',
    html: `
      <div class="text-start">
        <p class="small text-muted mb-3">
          ã‚¯ãƒ©ã‚¹ã”ã¨ã®åç°¿ã‚’ç™»éŒ²ãƒ»ç·¨é›†ã—ã¾ã™ã€‚<br>
          åå‰ã‚’æ”¹è¡ŒåŒºåˆ‡ã‚Šã§è²¼ã‚Šä»˜ã‘ã‚‹ã ã‘ã§ä¸€æ‹¬ç™»éŒ²ã§ãã¾ã™ã€‚
        </p>
        <div class="mb-3">
          <label class="form-label small fw-bold">ã‚¯ãƒ©ã‚¹å</label>
          <input type="text" id="roster-class" class="form-control" list="roster-class-list" placeholder="ä¾‹ï¼š1çµ„">
          <datalist id="roster-class-list">
            <option value="1çµ„">
            <option value="2çµ„">
            <option value="3çµ„">
          </datalist>
        </div>
        <div class="mb-3">
          <label class="form-label small fw-bold">å…ç«¥åãƒªã‚¹ãƒˆï¼ˆ1è¡Œã«1åï¼‰</label>
          <textarea id="roster-names" class="form-control" rows="10" placeholder="ç›¸å· å¥å¤ª&#13;&#10;é£¯ç”° ç¾å’²&#13;&#10;..."></textarea>
        </div>
        <div class="d-flex justify-content-between align-items-center">
           <button class="btn btn-outline-secondary btn-sm" onclick="loadRosterToTextarea()">
             <i class="bi bi-arrow-clockwise me-1"></i>æ—¢å­˜ãƒ‡ãƒ¼ã‚¿ã‚’èª­è¾¼
           </button>
           <button class="btn btn-success rounded-pill px-4" onclick="submitSaveRoster()">
             <i class="bi bi-save me-1"></i>ä¿å­˜ã™ã‚‹
           </button>
        </div>
      </div>
    `,
    showConfirmButton: false,
    showCloseButton: true,
    width: '600px',
    didOpen: () => {
      // ã‚¯ãƒ©ã‚¹åãŒå…¥åŠ›ã•ã‚ŒãŸã‚‰ã€æ—¢å­˜ãƒ‡ãƒ¼ã‚¿ãŒã‚ã‚Œã°èª­ã¿è¾¼ã‚€
      document.getElementById('roster-class').addEventListener('change', loadRosterToTextarea);
    }
  });
}

function loadRosterToTextarea() {
  const classId = document.getElementById('roster-class').value;
  if (!classId) return;

  const names = dataStore.roster
    .filter(r => r.classId === classId)
    .sort((a,b) => a.number - b.number) // ç™»éŒ²é †ï¼ˆnumberãŒç©ºãªã‚‰ä½œæˆé †ï¼‰
    .map(r => r.name);
  
  if (names.length > 0) {
    document.getElementById('roster-names').value = names.join('\n');
    // showToast('info', `${names.length}åã®ãƒ‡ãƒ¼ã‚¿ã‚’èª­ã¿è¾¼ã¿ã¾ã—ãŸ`);
  } else {
    document.getElementById('roster-names').value = "";
    // showToast('info', 'ã“ã®ã‚¯ãƒ©ã‚¹ã®ãƒ‡ãƒ¼ã‚¿ã¯ã‚ã‚Šã¾ã›ã‚“');
  }
}

function submitSaveRoster() {
  const classId = document.getElementById('roster-class').value;
  const namesText = document.getElementById('roster-names').value;
  
  if (!classId) {
    Swal.showValidationMessage('ã‚¯ãƒ©ã‚¹åã‚’å…¥åŠ›ã—ã¦ãã ã•ã„');
    return;
  }
  
  // ç©ºè¡Œã‚’é™¤å»ã—ã¦ãƒªã‚¹ãƒˆåŒ–
  const nameList = namesText.split('\n').map(n => n.trim()).filter(n => n);
  
  if (nameList.length === 0) {
    Swal.showValidationMessage('åå‰ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„');
    return;
  }

  showLoading();
  google.script.run
    .withSuccessHandler(res => {
      if (res.success) {
        // ãƒ‡ãƒ¼ã‚¿å†å–å¾—ã—ã¦åæ˜ 
        google.script.run.withSuccessHandler(d => {
          updateDataStore(d.json);
          hideLoading();
          Swal.close();
          showToast('success', `${classId}ã®åç°¿ã‚’æ›´æ–°ã—ã¾ã—ãŸ`);
        }).getData();
      } else {
        handleError(res);
      }
    })
    .withFailureHandler(handleError)
    .saveClassRoster(classId, nameList);
}

</script>
