<script>
/**
 * ã¿ã‚‰ã„ã‚³ãƒ³ãƒ‘ã‚¹ Ver. 1.0 - ã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆã‚µã‚¤ãƒ‰ãƒ­ã‚¸ãƒƒã‚¯
 * * ç”»é¢ã®æç”»ã€ãƒœã‚¿ãƒ³æ“ä½œã€ã‚µãƒ¼ãƒãƒ¼ã¨ã®é€šä¿¡ãªã©ã‚’åˆ¶å¾¡ã—ã¾ã™ã€‚
 */

// ==========================================
//  1. ã‚°ãƒ­ãƒ¼ãƒãƒ«è¨­å®šã¨å®šæ•°
// ==========================================

const CONSTANTS = {
  LS_KEY_NAME: 'mirai_student_name',  // åå‰ã®ä¿å­˜ã‚­ãƒ¼
  LS_KEY_CLASS: 'mirai_student_class', // ã‚¯ãƒ©ã‚¹ã®ä¿å­˜ã‚­ãƒ¼
  LS_KEY_THEME: 'mirai_theme',        // ãƒ†ãƒ¼ãƒã®ä¿å­˜ã‚­ãƒ¼
  LS_KEY_UNIT: 'mirai_current_unit_id', // é¸æŠä¸­å˜å…ƒã®ä¿å­˜ã‚­ãƒ¼
  UNIT_TIME: 45,                      // 1å˜ä½æ™‚é–“ã®é•·ã•
  REFRESH_INTERVAL: 30000,            // è‡ªå‹•æ›´æ–°é–“éš”(ms)
  SEAT_GRID_SIZE: 110,                // åº§å¸­è¡¨ã®ã‚°ãƒªãƒƒãƒ‰ã‚µã‚¤ã‚º
  
  // æ™‚é–“å‰²ãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆï¼ˆãƒœã‚¿ãƒ³ç”¨ï¼‰
  CLASS_PERIODS: [
    { id: 1, label: '1é™', start: '08:45', end: '09:30' },
    { id: 2, label: '2é™', start: '09:40', end: '10:25' },
    { id: 3, label: '3é™', start: '10:45', end: '11:30' },
    { id: 4, label: '4é™', start: '11:40', end: '12:25' },
    { id: 5, label: '5é™', start: '13:55', end: '14:40' },
    { id: 6, label: '6é™', start: '14:50', end: '15:35' }
  ]
};

// è³‡è³ªãƒ»èƒ½åŠ›ã‚¹ã‚­ãƒ«å®šç¾©
const SKILL_DEFINITIONS = [
  { id: 'self_manage', label: 'è‡ªå·±ç®¡ç†', group: 'è‡ªåˆ†', color: 'primary' },
  { id: 'planning', label: 'è¨ˆç”»æ€§', group: 'è‡ªåˆ†', color: 'primary' },
  { id: 'communication', label: 'å¯¾è©±', group: 'äºº', color: 'success' },
  { id: 'collaboration', label: 'å”åŠ›', group: 'äºº', color: 'success' },
  { id: 'challenge', label: 'æŒ‘æˆ¦', group: 'èª²é¡Œ', color: 'danger' },
  { id: 'thinking', label: 'å·¥å¤«', group: 'èª²é¡Œ', color: 'danger' },
  { id: 'habit', label: 'é›†ä¸­', group: 'ç”Ÿæ´»', color: 'warning' },
  { id: 'responsibility', label: 'è²¬ä»»', group: 'ç”Ÿæ´»', color: 'warning' }
];

// ã‚¢ãƒ—ãƒªã®çŠ¶æ…‹ç®¡ç†
let appState = {
  mode: typeof INITIAL_MODE !== 'undefined' ? INITIAL_MODE : 'student',
  user: {
    isAdmin: false,
    name: "",
    classId: ""
  },
  view: {
    student: 'daily',
    teacher: 'cards', // cards, heatmap, seating, summaries, control, analysis
    teacherClassId: 'All'
  },
  sound: { enabled: true, unlocked: false, prevSosCount: 0 },
  unit: { id: "", title: "", totalHours: 8, currentHour: 1 },
  unitList: [],
  schedules: []
};

// ãƒ‡ãƒ¼ã‚¿ã‚¹ãƒˆã‚¢
let dataStore = {
  masterTasks: [], 
  myTasks: [], 
  clsMyTasks: {},
  liveStatus: [], 
  clsProgress: {}, 
  clsFeedback: {},
  clsPlans: {}, 
  clsReflections: {},
  studentProgress: {}, 
  studentFeedback: {}, 
  studentPlan: {}, 
  portfolioData: {},
  studentReflections: {},
  clsPortfolios: {},
  classList: []
};

let computedState = { todaysPlanIds: new Set() };
let autoRefreshTimer = null;
let ssUrl = "";
let dragSrcEl = null;
let isDraggingSeat = false;

// ã‚¿ã‚¤ãƒãƒ¼ã®çŠ¶æ…‹
let myTimer = {
  interval: null,
  seconds: 0,
  isActive: false,
  mode: 'up', // 'up' or 'down'
  target: 0
};

// ==========================================
//  2. åˆæœŸåŒ–ãƒ—ãƒ­ã‚»ã‚¹ (Initialization)
// ==========================================

window.onload = function() {
  // ãƒ†ãƒ¼ãƒã®å¾©å…ƒ
  const theme = localStorage.getItem(CONSTANTS.LS_KEY_THEME);
  if (theme === 'dark') {
    document.body.setAttribute('data-theme', 'dark');
    const toggle = document.getElementById('darkModeSwitch');
    if (toggle) toggle.checked = true;
  }
  
  // GAS APIã®å­˜åœ¨ãƒã‚§ãƒƒã‚¯ï¼ˆå¿µã®ãŸã‚ï¼‰
  if (typeof google === 'undefined' || typeof google.script === 'undefined') {
    console.warn('Google Script API not found.');
    return;
  }

  // åˆæœŸãƒ‡ãƒ¼ã‚¿å–å¾—é–‹å§‹
  google.script.run
    .withSuccessHandler(handleInitialResponse)
    .withFailureHandler(handleError)
    .getAppInitialData();
};

function handleInitialResponse(res) {
  if (!res.success) { handleError({ message: res.error }); return; }
  
  appState.user.isAdmin = res.isAdmin;
  ssUrl = res.ssUrl;

  // ãƒ¢ãƒ¼ãƒ‰ã®è‡ªå‹•æ±ºå®š
  if (appState.mode === 'auto') {
    appState.mode = appState.user.isAdmin ? 'teacher' : 'student';
  }

  // ã‚¹ãƒ—ãƒ¬ãƒƒãƒ‰ã‚·ãƒ¼ãƒˆãƒœã‚¿ãƒ³ã®è¨­å®š
  const btnSs = document.getElementById('btn-view-ss');
  if (btnSs && ssUrl) btnSs.onclick = () => window.open(ssUrl, '_blank');
  
  // å…ˆç”Ÿãƒ¢ãƒ¼ãƒ‰åˆæœŸè¨­å®š
  if (appState.mode === 'teacher') {
    const btnArc = document.getElementById('btn-archive');
    if(btnArc) btnArc.classList.remove('d-none');
    startAutoRefresh();
  } else {
    document.getElementById('sound-setting-area').style.display = 'none';
  }

  // æœªåˆæœŸåŒ–ãªã‚‰ã‚»ãƒƒãƒˆã‚¢ãƒƒãƒ—ç”»é¢ã¸
  if (!res.isInitialized) {
    renderSetupOverlay();
  } else {
    loadMainData();
  }
}

function loadMainData() {
  const container = document.getElementById('app-container');
  if (!container.hasChildNodes() || container.innerHTML === '') showLoading();
  
  google.script.run
    .withSuccessHandler(res => {
      if (res.success) {
        updateDataStore(res.json);
        renderUnitSelector();
        renderApp();
        hideLoading();
        
        // å…ç«¥ãƒ¢ãƒ¼ãƒ‰å›ºæœ‰ã®åˆæœŸåŒ–
        if (appState.mode === 'student') {
          renderMyTimer();
          checkScheduleAndNotify(); 
        }
      } else { handleError({ message: res.error }); }
    })
    .withFailureHandler(handleError)
    .getData();
}

function renderSetupOverlay() {
  const container = document.getElementById('app-container');
  container.innerHTML = `
    <div class="d-flex flex-column justify-content-center align-items-center vh-100 text-center">
      <div class="card p-5 shadow-lg border-0 rounded-4" style="max-width: 600px;">
        <h1 class="text-primary mb-4 fw-bold"><i class="bi bi-compass me-2"></i>ã‚ˆã†ã“ã</h1>
        <p class="lead text-muted mb-4">
          ã€Œã¿ã‚‰ã„ã‚³ãƒ³ãƒ‘ã‚¹ã€ã‚’ã¯ã˜ã‚ã‚‹æº–å‚™ã‚’ã—ã¾ã™ã€‚<br>
          ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹(ã‚¹ãƒ—ãƒ¬ãƒƒãƒ‰ã‚·ãƒ¼ãƒˆ)ã‚’è‡ªå‹•ä½œæˆã—ã¾ã™ã€‚
        </p>
        <button class="btn btn-primary btn-lg rounded-pill px-5 shadow-sm" onclick="startInitialization()">
          åˆæœŸè¨­å®šã‚’é–‹å§‹ã™ã‚‹
        </button>
      </div>
    </div>`;
  hideLoading();
}

function startInitialization() {
  showLoading();
  google.script.run
    .withSuccessHandler(r => {
      if (r.success) loadMainData();
      else handleError({ message: r.error });
    })
    .withFailureHandler(handleError)
    .initSystem();
}

function startAutoRefresh() {
  if (autoRefreshTimer) clearInterval(autoRefreshTimer);
  autoRefreshTimer = setInterval(() => {
    google.script.run
      .withSuccessHandler(res => {
        if (res.success) {
          updateDataStore(res.json);
          // å…ˆç”Ÿãƒ¢ãƒ¼ãƒ‰: ç”»é¢æ›´æ–°ï¼ˆåº§å¸­ç·¨é›†ä¸­ã¯é™¤ãï¼‰
          if (appState.mode === 'teacher' && document.getElementById('t-area')) {
            if (appState.view.teacher !== 'seating' || !isDraggingSeat) {
              renderTeacherDashboardContent();
            }
            checkSosAndPlaySound();
          } 
          // å…ç«¥ãƒ¢ãƒ¼ãƒ‰: ã‚¹ã‚±ã‚¸ãƒ¥ãƒ¼ãƒ«é€šçŸ¥ãƒã‚§ãƒƒã‚¯
          else if (appState.mode === 'student') {
            checkScheduleAndNotify();
          }
        }
      })
      .withFailureHandler(e => console.error("AutoRefresh Failed", e))
      .getData();
  }, CONSTANTS.REFRESH_INTERVAL);
}

function updateDataStore(jsonStr) {
  const d = JSON.parse(jsonStr);
  dataStore.masterTasks = d.unit || [];
  dataStore.liveStatus = d.live || [];
  dataStore.clsProgress = d.progress || {};
  dataStore.clsFeedback = d.feedback || {};
  dataStore.clsMyTasks = d.myTasks || {};
  dataStore.clsPlans = d.plans || {};
  dataStore.clsReflections = d.dailyReflections || {};
  dataStore.clsPortfolios = d.portfolios || {};
  appState.schedules = d.schedules || [];

  // å˜å…ƒãƒªã‚¹ãƒˆã®ç”Ÿæˆ
  const unitsMap = new Map();
  dataStore.masterTasks.forEach(t => {
    if (t.unitId && !unitsMap.has(t.unitId)) {
      unitsMap.set(t.unitId, {
        id: t.unitId,
        title: t.unitInfo?.title || 'ç„¡é¡Œã®å˜å…ƒ',
        subject: t.unitInfo?.subject || '',
        totalHours: Number(t.totalHours) || 8
      });
    }
  });
  appState.unitList = Array.from(unitsMap.values()).sort((a, b) => b.id.localeCompare(a.id));

  // ç¾åœ¨ã®å˜å…ƒã‚’æ±ºå®š
  if (appState.unitList.length > 0 && !appState.unit.id) {
    const savedId = localStorage.getItem(CONSTANTS.LS_KEY_UNIT);
    const target = appState.unitList.find(u => u.id === savedId) || appState.unitList[0];
    appState.unit.id = target.id;
    appState.unit.title = target.title;
    appState.unit.totalHours = target.totalHours;
  } else if (appState.unitList.length === 0) {
    appState.unit.id = "";
    appState.unit.title = "å˜å…ƒãƒ‡ãƒ¼ã‚¿ãªã—";
  }

  // ã‚¯ãƒ©ã‚¹ãƒªã‚¹ãƒˆã®æŠ½å‡º
  const classes = new Set();
  dataStore.liveStatus.forEach(s => { if(s.classId) classes.add(s.classId); });
  if(classes.size === 0) classes.add('1çµ„');
  dataStore.classList = Array.from(classes).sort();
}

function changeUnit(unitId) {
  const target = appState.unitList.find(u => u.id === unitId);
  if (target) {
    appState.unit.id = target.id;
    appState.unit.title = target.title;
    appState.unit.totalHours = target.totalHours;
    localStorage.setItem(CONSTANTS.LS_KEY_UNIT, unitId);
    
    if(appState.mode === 'student' && appState.user.name) {
      syncStudentPlan();
      renderStudentView();
      loginStudent(true); // ãƒ‡ãƒ¼ã‚¿å†å–å¾—
      submitUserStatus(getSelfStatusMode()); 
    } else if (appState.mode === 'teacher') {
      renderTeacherView();
    }
  }
}

function getSelfStatusMode() {
  const me = dataStore.liveStatus.find(s => s.name === appState.user.name);
  return me ? me.mode : 'é€šå¸¸';
}

function getCurrentUnitTasks() {
  return dataStore.masterTasks.filter(t => t.unitId === appState.unit.id);
}

// ã‚¹ã‚±ã‚¸ãƒ¥ãƒ¼ãƒ«é€šçŸ¥æ©Ÿèƒ½
function checkScheduleAndNotify() {
  if (!appState.user.classId || appState.schedules.length === 0) return;
  
  const now = new Date();
  const dateStr = now.getFullYear() + "-" + ('0' + (now.getMonth() + 1)).slice(-2) + "-" + ('0' + now.getDate()).slice(-2);
  const timeStr = ('0' + now.getHours()).slice(-2) + ":" + ('0' + now.getMinutes()).slice(-2);
  
  const currentSchedule = appState.schedules.find(s => 
    s.classId === appState.user.classId && 
    s.date === dateStr &&
    s.startTime <= timeStr && s.endTime >= timeStr
  );

  let notifyBar = document.getElementById('schedule-notify-bar');
  
  if (currentSchedule) {
    const unit = appState.unitList.find(u => u.id === currentSchedule.unitId);
    const unitTitle = unit ? unit.title : "ä¸æ˜ãªå˜å…ƒ";
    const msg = currentSchedule.message || `ãŸã ä»Šã®æˆæ¥­ï¼š${unitTitle} ç¬¬${currentSchedule.hour}æ™‚`;
    
    if (!notifyBar) {
      notifyBar = document.createElement('div');
      notifyBar.id = 'schedule-notify-bar';
      notifyBar.className = 'bg-info text-white text-center py-2 px-3 shadow-sm cursor-pointer animate__animated animate__fadeInDown';
      notifyBar.style.position = 'fixed';
      notifyBar.style.top = '60px'; 
      notifyBar.style.left = '0';
      notifyBar.style.right = '0';
      notifyBar.style.zIndex = '1020';
      notifyBar.innerHTML = `<i class="bi bi-broadcast me-2"></i><span class="fw-bold">${msg}</span> <small class="ms-2 border rounded-pill px-2">ç§»å‹•ã™ã‚‹</small>`;
      notifyBar.onclick = () => {
        if(unit) {
          changeUnit(unit.id);
          changeCurrentHour(currentSchedule.hour);
          if(currentSchedule.message) Swal.fire({ title: 'å…ˆç”Ÿã‹ã‚‰ã®ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸', text: currentSchedule.message, icon: 'info' });
        }
      };
      document.body.appendChild(notifyBar);
    } else {
      notifyBar.querySelector('span').innerHTML = `<i class="bi bi-broadcast me-2"></i><span class="fw-bold">${msg}</span> <small class="ms-2 border rounded-pill px-2">ç§»å‹•ã™ã‚‹</small>`;
    }
  } else {
    if (notifyBar) notifyBar.remove();
  }
}

// ==========================================
//  3. æç”»ãƒ‡ã‚£ã‚¹ãƒ‘ãƒƒãƒãƒ£ (Render Dispatcher)
// ==========================================

function renderUnitSelector() {
  const options = appState.unitList.map(u => 
    `<option value="${u.id}" ${u.id === appState.unit.id ? 'selected' : ''}>${u.subject ? 'ã€'+u.subject+'ã€‘' : ''} ${u.title}</option>`
  ).join('');
  
  const html = `
    <div class="input-group input-group-sm">
      <span class="input-group-text bg-white border-end-0 text-primary"><i class="bi bi-book-half"></i></span>
      <select class="form-select border-start-0 fw-bold text-primary bg-light" onchange="changeUnit(this.value)" style="box-shadow:none;">
        ${options.length > 0 ? options : '<option>å˜å…ƒãªã—</option>'}
      </select>
    </div>
  `;
  
  const c1 = document.getElementById('unit-selector-container');
  const c2 = document.getElementById('unit-selector-mobile');
  if(c1) c1.innerHTML = html;
  if(c2) c2.innerHTML = html;
}

function renderApp() {
  try {
    const container = document.getElementById('app-container');
    if (appState.mode === 'teacher') {
      renderTeacherView();
    } else {
      const savedName = localStorage.getItem(CONSTANTS.LS_KEY_NAME);
      const savedClass = localStorage.getItem(CONSTANTS.LS_KEY_CLASS);
      
      if (!appState.user.name && savedName) {
        appState.user.name = savedName;
        appState.user.classId = savedClass || "1çµ„";
        loginStudent(true);
      } else if (!appState.user.name) {
        renderNameEntry();
      } else {
        syncStudentPlan();
        renderStudentView();
      }
    }
  } catch (e) {
    console.error(e);
    handleError({ message: "æç”»ã‚¨ãƒ©ãƒ¼: " + e.message });
  }
}

function switchMode(newMode) {
  appState.mode = newMode;
  renderApp();
}

// ==========================================
//  4. å…ç«¥ãƒ¢ãƒ¼ãƒ‰ãƒ­ã‚¸ãƒƒã‚¯ (Student Logic)
// ==========================================

function renderNameEntry() {
  document.getElementById('app-container').innerHTML = `
    <div class="row justify-content-center animate__animated animate__fadeIn">
      <div class="col-md-6">
        <div class="card shadow-sm p-5 text-center border-0 rounded-4">
          <h4 class="fw-bold mb-4"><ruby>å§‹<rt>ã¯ã˜</rt></ruby>ã‚ã‚‹</h4>
          <div class="mb-3">
             <label class="form-label small text-muted">ã‚¯ãƒ©ã‚¹</label>
             <select id="input-class" class="form-select form-select-lg text-center rounded-pill border-0 bg-light">
               <option value="1çµ„">1çµ„</option>
               <option value="2çµ„">2çµ„</option>
               <option value="3çµ„">3çµ„</option>
               <option value="4çµ„">4çµ„</option>
               <option value="5çµ„">5çµ„</option>
             </select>
          </div>
          <div class="mb-4">
             <label class="form-label small text-muted">ãªã¾ãˆ</label>
             <input type="text" id="input-name" class="form-control form-control-lg text-center rounded-pill border-0 bg-light" placeholder="ä¾‹ï¼šã‚„ã¾ã  ãŸã‚ã†">
          </div>
          <div class="form-check mb-4 d-inline-block">
            <input class="form-check-input" type="checkbox" id="rm-me" checked>
            <label class="form-check-label small" for="rm-me"><ruby>æƒ…å ±<rt>ã˜ã‚‡ã†ã»ã†</rt></ruby>ã‚’<ruby>ä¿å­˜<rt>ã»ãã‚“</rt></ruby>ã™ã‚‹</label>
          </div>
          <button class="btn btn-primary btn-lg w-100 rounded-pill shadow-sm" onclick="handleLoginClick()">ã‚¹ã‚¿ãƒ¼ãƒˆ</button>
        </div>
      </div>
    </div>`;
}

function handleLoginClick() {
  const nameInput = document.getElementById('input-name');
  const classInput = document.getElementById('input-class');
  const remember = document.getElementById('rm-me').checked;
  const name = nameInput.value.trim();
  const cls = classInput.value;
  
  if (!name) return;
  
  if (remember) {
    localStorage.setItem(CONSTANTS.LS_KEY_NAME, name);
    localStorage.setItem(CONSTANTS.LS_KEY_CLASS, cls);
  } else {
    localStorage.removeItem(CONSTANTS.LS_KEY_NAME);
    localStorage.removeItem(CONSTANTS.LS_KEY_CLASS);
  }
  
  appState.user.name = name;
  appState.user.classId = cls;
  loginStudent(false);
}

function loginStudent(isAuto) {
  if (!isAuto) showLoading();
  google.script.run
    .withSuccessHandler(res => {
      if (res.success) {
        const d = JSON.parse(res.json);
        dataStore.studentProgress = d.progress || {};
        dataStore.studentFeedback = d.feedback || {};
        dataStore.myTasks = d.myTasks || [];
        dataStore.portfolioData = d.portfolio || { summary: '' };
        dataStore.studentReflections = d.reflections?.[appState.unit.id] || {};
        
        if (d.plans && d.plans[appState.unit.id]) {
           dataStore.clsPlans[appState.user.name] = { [appState.unit.id]: d.plans[appState.unit.id] };
        }
        syncStudentPlan();
        renderStudentView();
        if (!isAuto) hideLoading();
        renderMyTimer();
        checkScheduleAndNotify();
      }
    })
    .withFailureHandler(handleError)
    .getStudentProgress(appState.user.name, appState.user.classId, appState.unit.id);
}

// ---------------- ã‚¿ã‚¤ãƒãƒ¼æ©Ÿèƒ½ ----------------

function renderMyTimer() {
  if (document.getElementById('my-timer-widget')) return;
  
  const timerHtml = `
    <div id="my-timer-widget" class="card shadow rounded-4 bg-white" style="position:fixed; bottom:20px; right:20px; width:180px; z-index:1050; border:1px solid #ddd;">
      <div class="card-header bg-light border-0 py-1 d-flex justify-content-between align-items-center" style="cursor:move;" onmousedown="dragElement(document.getElementById('my-timer-widget'))">
        <small class="fw-bold text-muted"><i class="bi bi-clock me-1"></i>Timer</small>
        <button type="button" class="btn-close btn-close-sm" aria-label="Close" onclick="document.getElementById('my-timer-widget').classList.toggle('d-none')"></button>
      </div>
      <div class="card-body p-2 text-center">
        <div class="display-5 fw-bold mb-2" id="timer-display" style="font-family:monospace;">00:00</div>
        <div class="btn-group btn-group-sm w-100 mb-2">
          <button class="btn btn-outline-secondary" onclick="setTimerMode('up')">UP</button>
          <button class="btn btn-outline-secondary" onclick="setTimerMode('down')">DOWN</button>
        </div>
        <div class="input-group input-group-sm mb-2" id="timer-input-group" style="display:none;">
          <input type="number" id="timer-input-min" class="form-control" placeholder="åˆ†" min="1" max="60">
          <button class="btn btn-primary" onclick="setTimerTime()">è¨­å®š</button>
        </div>
        <div class="d-flex justify-content-between">
          <button class="btn btn-primary btn-sm rounded-pill px-3" onclick="toggleTimer()" id="timer-btn-toggle"><ruby>é–‹å§‹<rt>ã‹ã„ã—</rt></ruby></button>
          <button class="btn btn-outline-secondary btn-sm rounded-pill" onclick="resetTimer()">ãƒªã‚»ãƒƒãƒˆ</button>
        </div>
      </div>
    </div>
    <!-- æœ€å°åŒ–ã‚¢ã‚¤ã‚³ãƒ³ -->
    <button id="timer-launcher" class="btn btn-primary rounded-circle shadow" style="position:fixed; bottom:20px; right:20px; width:50px; height:50px; z-index:1040;" onclick="document.getElementById('my-timer-widget').classList.remove('d-none');">
      <i class="bi bi-stopwatch fs-4"></i>
    </button>
  `;
  document.body.insertAdjacentHTML('beforeend', timerHtml);
}

function setTimerMode(mode) {
  myTimer.mode = mode;
  document.getElementById('timer-input-group').style.display = (mode === 'down' && !myTimer.isActive) ? 'flex' : 'none';
  resetTimer();
}

function setTimerTime() {
  const min = parseInt(document.getElementById('timer-input-min').value);
  if (min > 0) {
    myTimer.seconds = min * 60;
    updateTimerDisplay();
    document.getElementById('timer-input-group').style.display = 'none';
  }
}

function toggleTimer() {
  if (myTimer.isActive) {
    clearInterval(myTimer.interval);
    myTimer.isActive = false;
    document.getElementById('timer-btn-toggle').innerHTML = '<ruby>å†é–‹<rt>ã•ã„ã‹ã„</rt></ruby>';
    document.getElementById('timer-btn-toggle').className = 'btn btn-primary btn-sm rounded-pill px-3';
  } else {
    if (myTimer.mode === 'down' && myTimer.seconds === 0) return;
    myTimer.isActive = true;
    document.getElementById('timer-btn-toggle').innerHTML = '<ruby>åœæ­¢<rt>ã¦ã„ã—</rt></ruby>';
    document.getElementById('timer-btn-toggle').className = 'btn btn-danger btn-sm rounded-pill px-3';
    
    myTimer.interval = setInterval(() => {
      if (myTimer.mode === 'up') {
        myTimer.seconds++;
      } else {
        myTimer.seconds--;
        if (myTimer.seconds <= 0) {
          clearInterval(myTimer.interval);
          myTimer.isActive = false;
          myTimer.seconds = 0;
          document.getElementById('timer-btn-toggle').innerHTML = '<ruby>é–‹å§‹<rt>ã‹ã„ã—</rt></ruby>';
          document.getElementById('timer-btn-toggle').className = 'btn btn-primary btn-sm rounded-pill px-3';
          showToast('info', 'æ™‚é–“ã§ã™ï¼');
        }
      }
      updateTimerDisplay();
    }, 1000);
  }
}

function resetTimer() {
  clearInterval(myTimer.interval);
  myTimer.isActive = false;
  myTimer.seconds = 0;
  updateTimerDisplay();
  document.getElementById('timer-btn-toggle').innerHTML = '<ruby>é–‹å§‹<rt>ã‹ã„ã—</rt></ruby>';
  document.getElementById('timer-btn-toggle').className = 'btn btn-primary btn-sm rounded-pill px-3';
  if(myTimer.mode === 'down') document.getElementById('timer-input-group').style.display = 'flex';
}

function updateTimerDisplay() {
  const m = Math.floor(myTimer.seconds / 60);
  const s = myTimer.seconds % 60;
  document.getElementById('timer-display').textContent = `${('0'+m).slice(-2)}:${('0'+s).slice(-2)}`;
}

// ç°¡æ˜“ãƒ‰ãƒ©ãƒƒã‚°
function dragElement(elmnt) {
  let pos1 = 0, pos2 = 0, pos3 = 0, pos4 = 0;
  elmnt.onmousedown = dragMouseDown;

  function dragMouseDown(e) {
    e = e || window.event;
    pos3 = e.clientX;
    pos4 = e.clientY;
    document.onmouseup = closeDragElement;
    document.onmousemove = elementDrag;
  }

  function elementDrag(e) {
    e = e || window.event;
    e.preventDefault();
    pos1 = pos3 - e.clientX;
    pos2 = pos4 - e.clientY;
    pos3 = e.clientX;
    pos4 = e.clientY;
    elmnt.style.top = (elmnt.offsetTop - pos2) + "px";
    elmnt.style.left = (elmnt.offsetLeft - pos1) + "px";
  }

  function closeDragElement() {
    document.onmouseup = null;
    document.onmousemove = null;
  }
}

// ------------------------------------------

function submitTaskProgress(taskId, status, btnElement) {
  if (status === 'å®Œäº†') {
    btnElement.className = "btn btn-secondary rounded-pill px-4 btn-sm fw-bold animate__animated animate__heartBeat";
    btnElement.innerHTML = `<i class="bi bi-check-circle-fill me-1"></i><ruby>å®Œäº†<rt>ã‹ã‚“ã‚Šã‚‡ã†</rt></ruby>`; 
    btnElement.disabled = true;
  }
  if (!dataStore.studentProgress[taskId]) dataStore.studentProgress[taskId] = {};
  dataStore.studentProgress[taskId].status = status;
  
  const allTasks = [...dataStore.masterTasks, ...dataStore.myTasks];
  const t = allTasks.find(x => x.taskId === taskId);
  const mem = dataStore.studentProgress[taskId].reflection || "";
  
  google.script.run
    .withFailureHandler(err => console.error(err))
    .updateStatus(appState.user.name, t.taskId, t.title, status, 'é€šå¸¸', mem, appState.user.classId, appState.unit.id);
  
  if (status === 'é€”ä¸­') showToast('info', 'é€”ä¸­çµŒéã‚’ä¿å­˜ã—ã¾ã—ãŸ');
  if (status === 'å®Œäº†') setTimeout(renderStudentView, 1000);
}

function submitUserStatus(mode) {
  const idx = dataStore.liveStatus.findIndex(d => d.name === appState.user.name);
  if (idx >= 0) {
    dataStore.liveStatus[idx].mode = (mode === 'é€šå¸¸' ? '' : mode);
    dataStore.liveStatus[idx].classId = appState.user.classId;
    dataStore.liveStatus[idx].currentUnitId = appState.unit.id;
  }
  renderStudentView();
  
  let msg = "ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹è§£é™¤"; let icon = "success";
  if (mode === 'ãŸã™ã‘ã¦') { msg = "SOSé€ä¿¡ï¼"; icon = "warning"; }
  else if (mode === 'ã—ã‚…ã†ã¡ã‚…ã†') { msg = "é›†ä¸­ãƒ¢ãƒ¼ãƒ‰é–‹å§‹"; icon = "info"; }
  if (mode !== 'é€šå¸¸' && mode !== '') showToast(icon, msg);
  
  google.script.run
    .withFailureHandler(err => console.error(err))
    .updateStatus(appState.user.name, 'st_upd', 'ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹', 'æ›´æ–°', mode, '', appState.user.classId, appState.unit.id);
}

function savePlan() {
  google.script.run
    .withFailureHandler(handleError)
    .saveStudentPlan(appState.user.name, appState.unit.id, dataStore.studentPlan, appState.user.classId);
}

function openDailyReflectionModal(targetHour = null) {
  const hourToEdit = targetHour || appState.unit.currentHour;
  let ref = { achievement: 'A', comment: '', skills: [] };
  
  if (dataStore.studentReflections && dataStore.studentReflections[hourToEdit]) {
    ref = dataStore.studentReflections[hourToEdit];
  } else if (dataStore.clsReflections[appState.user.name]?.[appState.unit.id]?.[hourToEdit]) {
     ref = dataStore.clsReflections[appState.user.name][appState.unit.id][hourToEdit];
  }

  const skillButtons = SKILL_DEFINITIONS.map(s => {
    const isChecked = ref.skills && ref.skills.includes(s.id);
    return `
      <div class="col-3 col-md-3 mb-2">
        <input type="checkbox" class="btn-check skill-check" id="skill-${s.id}" value="${s.id}" ${isChecked ? 'checked' : ''}>
        <label class="btn btn-outline-${s.color} w-100 rounded-pill btn-sm py-2" for="skill-${s.id}">
          <div class="small fw-light" style="font-size:0.7rem">${s.group}</div>
          <div class="fw-bold">${s.label}</div>
        </label>
      </div>`;
  }).join('');

  Swal.fire({
    title: `<div class="fs-4 fw-bold">ç¬¬${hourToEdit}æ™‚ã®ãµã‚Šã‹ãˆã‚Š</div>`,
    html: `
      <div class="text-start">
        <div class="mb-4">
          <label class="form-label small fw-bold text-muted"><ruby>é”æˆåº¦<rt>ãŸã£ã›ã„ã©</rt></ruby></label>
          <div class="btn-group w-100" role="group">
            <input type="radio" class="btn-check" name="ach-btn" id="ach-a" value="A" ${ref.achievement==='A'?'checked':''}>
            <label class="btn btn-outline-primary" for="ach-a">â— <ruby>è¨ˆç”»<rt>ã‘ã„ã‹ã</rt></ruby>é€šã‚Š</label>
            <input type="radio" class="btn-check" name="ach-btn" id="ach-b" value="B" ${ref.achievement==='B'?'checked':''}>
            <label class="btn btn-outline-primary" for="ach-b">ã€‡ ã¾ã‚ã¾ã‚</label>
            <input type="radio" class="btn-check" name="ach-btn" id="ach-c" value="C" ${ref.achievement==='C'?'checked':''}>
            <label class="btn btn-outline-primary" for="ach-c">â–³ ã‚ã¾ã‚Š</label>
          </div>
        </div>

        <div class="mb-4">
          <label class="form-label small fw-bold text-muted">ä»Šæ—¥<ruby>ç™ºæ®<rt>ã¯ã£ã</rt></ruby>ã—ãŸ<ruby>åŠ›<rt>ã¡ã‹ã‚‰</rt></ruby>ï¼ˆè¤‡æ•°é¸æŠå¯ï¼‰</label>
          <div class="row gx-2">
            ${skillButtons}
          </div>
        </div>

        <div>
          <label class="form-label small fw-bold text-muted">ã²ã¨ã“ã¨ã‚³ãƒ¡ãƒ³ãƒˆ</label>
          <textarea id="rf-com" class="form-control bg-light border-0" rows="3" placeholder="ã‚ã‹ã£ãŸã“ã¨ã€æ¬¡ãŒã‚“ã°ã‚ŠãŸã„ã“ã¨">${ref.comment||''}</textarea>
        </div>
      </div>
    `,
    width: '600px',
    showCancelButton: true,
    confirmButtonText: 'è¨˜éŒ²ã™ã‚‹',
    confirmButtonColor: '#1a73e8',
    customClass: { popup: 'rounded-5' },
    preConfirm: () => {
      const achEl = document.querySelector('input[name="ach-btn"]:checked');
      if (!achEl) { Swal.showValidationMessage('é”æˆåº¦ã‚’é¸æŠã—ã¦ãã ã•ã„'); return false; }
      
      const skills = Array.from(document.querySelectorAll('.skill-check:checked')).map(el => el.value);
      return {
        achievement: achEl.value,
        comment: document.getElementById('rf-com').value,
        skills: skills
      };
    }
  }).then(r => {
    if (r.isConfirmed) {
      const v = r.value;
      if(!dataStore.studentReflections) dataStore.studentReflections = {};
      dataStore.studentReflections[hourToEdit] = v;

      google.script.run.saveDailyReflection(appState.user.name, appState.unit.id, hourToEdit, v.achievement, v.comment, appState.user.classId, v.skills);
      showToast('success', 'ãµã‚Šã‹ãˆã‚Šã‚’è¨˜éŒ²ã—ã¾ã—ãŸ');
      renderStudentView();
    }
  });
}

function renderPortfolioModal(name, isTeacherMode = false) {
  let reflections = {};
  let summary = "";

  if (isTeacherMode) {
    if (dataStore.clsReflections[name] && dataStore.clsReflections[name][appState.unit.id]) {
      reflections = dataStore.clsReflections[name][appState.unit.id];
    }
    if(dataStore.clsPortfolios && dataStore.clsPortfolios[name] && dataStore.clsPortfolios[name][appState.unit.id]) {
      summary = dataStore.clsPortfolios[name][appState.unit.id];
    }
  } else {
    reflections = dataStore.studentReflections || {};
    summary = dataStore.portfolioData ? dataStore.portfolioData.summary : "";
  }

  const skillCounts = {};
  SKILL_DEFINITIONS.forEach(s => skillCounts[s.id] = 0);
  Object.values(reflections).forEach(r => {
    if (r.skills && Array.isArray(r.skills)) {
      r.skills.forEach(sId => {
        if (skillCounts[sId] !== undefined) skillCounts[sId]++;
      });
    }
  });

  const chartLabels = SKILL_DEFINITIONS.map(s => s.label);
  const chartData = SKILL_DEFINITIONS.map(s => skillCounts[s.id]);
  const maxVal = Math.max(5, ...chartData) + 1;

  let timelineHtml = '<div class="timeline-wrapper ps-2 border-start border-3 ms-3">';
  const sortedHours = Object.keys(reflections).map(Number).sort((a,b)=>a-b);
  
  if (sortedHours.length === 0) {
    timelineHtml += '<div class="text-muted ms-3 small">ã¾ã ãµã‚Šã‹ãˆã‚Šã®è¨˜éŒ²ãŒã‚ã‚Šã¾ã›ã‚“</div>';
  } else {
    sortedHours.forEach(h => {
      const r = reflections[h];
      const achIcon = r.achievement === 'A' ? 'â—' : (r.achievement === 'B' ? 'ã€‡' : 'â–³');
      const achColor = r.achievement === 'A' ? 'text-primary' : (r.achievement === 'B' ? 'text-success' : 'text-secondary');
      
      let tagsHtml = '';
      if(r.skills && r.skills.length > 0) {
        tagsHtml = '<div class="mt-1">' + r.skills.map(sid => {
          const def = SKILL_DEFINITIONS.find(d => d.id === sid);
          return def ? `<span class="badge rounded-pill bg-light text-dark border me-1 small fw-normal">${def.label}</span>` : '';
        }).join('') + '</div>';
      }

      const editBtn = !isTeacherMode ? `<i class="bi bi-pencil-square text-muted ms-2 cursor-pointer edit-icon" onclick="Swal.close(); setTimeout(() => openDailyReflectionModal(${h}), 300);"></i>` : '';

      timelineHtml += `
        <div class="position-relative mb-4 ms-3">
          <div class="position-absolute top-0 start-0 translate-middle rounded-circle bg-white border border-2" style="width:12px;height:12px;left:-22px!important;"></div>
          <div class="small fw-bold text-muted mb-1 d-flex align-items-center">
            ç¬¬${h}æ™‚ <span class="${achColor} ms-2 fs-6">${achIcon}</span>
            ${editBtn}
          </div>
          <div class="bg-light p-2 rounded small">${r.comment || 'ã‚³ãƒ¡ãƒ³ãƒˆãªã—'}</div>
          ${tagsHtml}
        </div>`;
    });
  }
  timelineHtml += '</div>';

  const readonlyAttr = isTeacherMode ? 'readonly' : '';
  const saveBtnHtml = isTeacherMode ? '' : `<button class="btn btn-primary rounded-pill w-100 mt-3" onclick="saveSummary()"><ruby>ä¿å­˜<rt>ã»ãã‚“</rt></ruby>ã™ã‚‹</button>`;
  const summaryHtml = `
    <div class="p-2">
      <div class="small text-muted mb-2">ã“ã®å˜å…ƒã‚’é€šã—ã¦å­¦ã‚“ã ã“ã¨ã€ã§ãã‚‹ã‚ˆã†ã«ãªã£ãŸã“ã¨ã‚’æ›¸ãã¾ã—ã‚‡ã†ã€‚</div>
      <textarea id="pf-summary" class="form-control bg-light border-0" rows="8" placeholder="ã“ã“ã«ã¾ã¨ã‚ã‚’æ›¸ã“ã†..." ${readonlyAttr}>${summary||''}</textarea>
      ${saveBtnHtml}
    </div>
  `;

  Swal.fire({
    title: `<div class="fs-4 fw-bold"><i class="bi bi-journal-text me-2"></i>${name} ã•ã‚“ã®ãƒãƒ¼ãƒˆãƒ•ã‚©ãƒªã‚ª</div>`,
    html: `
      <div class="container-fluid text-start px-0">
        <ul class="nav nav-pills mb-3 justify-content-center" id="pills-tab" role="tablist">
          <li class="nav-item"><button class="nav-link active rounded-pill px-4" id="pills-graph-tab" data-bs-toggle="pill" data-bs-target="#pills-graph" type="button">ã‚°ãƒ©ãƒ•</button></li>
          <li class="nav-item"><button class="nav-link rounded-pill px-4" id="pills-log-tab" data-bs-toggle="pill" data-bs-target="#pills-log" type="button">ã‚ã‚†ã¿</button></li>
          <li class="nav-item"><button class="nav-link rounded-pill px-4" id="pills-sum-tab" data-bs-toggle="pill" data-bs-target="#pills-sum" type="button">ã¾ã¨ã‚</button></li>
        </ul>
        <div class="tab-content" id="pills-tabContent" style="min-height: 300px;">
          <div class="tab-pane fade show active" id="pills-graph" role="tabpanel">
            <div class="chart-container" style="position: relative; height:300px; width:100%">
              <canvas id="skillRadarChart"></canvas>
            </div>
            <div class="text-center small text-muted mt-2">â€»æ—¥ã€…ã®ãµã‚Šã‹ãˆã‚Šã§é¸æŠã—ãŸã‚¹ã‚­ãƒ«ãŒé›†è¨ˆã•ã‚Œã¾ã™</div>
          </div>
          <div class="tab-pane fade" id="pills-log" role="tabpanel">
            <div style="max-height: 350px; overflow-y: auto;">${timelineHtml}</div>
          </div>
          <div class="tab-pane fade" id="pills-sum" role="tabpanel">${summaryHtml}</div>
        </div>
      </div>
    `,
    width: '650px',
    showCloseButton: true,
    showConfirmButton: false,
    didOpen: () => {
      const ctx = document.getElementById('skillRadarChart').getContext('2d');
      new Chart(ctx, {
        type: 'radar',
        data: {
          labels: chartLabels,
          datasets: [{
            label: 'ç™ºæ®ã—ãŸåŠ›',
            data: chartData,
            backgroundColor: 'rgba(26, 115, 232, 0.2)',
            borderColor: 'rgba(26, 115, 232, 1)',
            pointBackgroundColor: 'rgba(26, 115, 232, 1)',
            borderWidth: 2
          }]
        },
        options: {
          scales: {
            r: {
              angleLines: { display: true },
              suggestedMin: 0,
              suggestedMax: maxVal,
              ticks: { stepSize: 1, backdropColor: 'transparent' }
            }
          },
          plugins: { legend: { display: false } },
          maintainAspectRatio: false
        }
      });
    }
  });
}

function saveSummary() {
  const val = document.getElementById('pf-summary').value;
  if(!dataStore.portfolioData) dataStore.portfolioData = {};
  dataStore.portfolioData.summary = val;
  google.script.run.savePortfolio(appState.user.name, appState.unit.id, val, appState.user.classId);
  Swal.fire({ toast: true, position: 'top-end', icon: 'success', title: 'ä¿å­˜ã—ã¾ã—ãŸ', timer: 2000, showConfirmButton: false });
}

// ==========================================
//  5. å…ˆç”Ÿãƒ¢ãƒ¼ãƒ‰ãƒ­ã‚¸ãƒƒã‚¯ (Teacher Logic)
// ==========================================

function renderTeacherView() {
  const container = document.getElementById('app-container');
  const classes = ['All', ...dataStore.classList];
  const tabsHtml = classes.map(c => 
    `<li class="nav-item"><a class="nav-link ${appState.view.teacherClassId === c ? 'active fw-bold' : ''}" href="#" onclick="setTeacherClass('${c}')">${c === 'All' ? 'å…¨å“¡' : c}</a></li>`
  ).join('');

  container.innerHTML = `
    <div class="card shadow-sm p-4 border-0 rounded-4 teacher-view-card h-100">
      <div class="d-flex justify-content-between align-items-center mb-3 flex-shrink-0">
        <h5 class="fw-bold m-0 text-primary"><i class="bi bi-speedometer2 me-2"></i>ãƒ¢ãƒ‹ã‚¿ãƒ¼ <span class="badge bg-success ms-2 small" style="font-size:0.6rem">AUTO</span></h5>
        <div class="d-flex gap-3 align-items-center">
          <div class="btn-group shadow-sm rounded-pill" role="group">
            <button class="btn btn-sm ${appState.view.teacher === 'cards' ? 'btn-primary' : 'btn-outline-primary'}" onclick="setTeacherView('cards')">LIVE</button>
            <button class="btn btn-sm ${appState.view.teacher === 'heatmap' ? 'btn-primary' : 'btn-outline-primary'}" onclick="setTeacherView('heatmap')">ä¸€è¦§</button>
            <button class="btn btn-sm ${appState.view.teacher === 'seating' ? 'btn-primary' : 'btn-outline-primary'}" onclick="setTeacherView('seating')">åº§å¸­</button>
            <button class="btn btn-sm ${appState.view.teacher === 'summaries' ? 'btn-primary' : 'btn-outline-primary'}" onclick="setTeacherView('summaries')">ã¾ã¨ã‚</button>
            <button class="btn btn-sm ${appState.view.teacher === 'control' ? 'btn-primary' : 'btn-outline-primary'}" onclick="setTeacherView('control')">é€²è¡Œ</button>
            <button class="btn btn-sm ${appState.view.teacher === 'analysis' ? 'btn-primary' : 'btn-outline-primary'}" onclick="setTeacherView('analysis')">åˆ†æ</button>
          </div>
          <button class="btn btn-primary btn-sm rounded-pill px-3 shadow-sm" onclick="openImportModal()">ã‚¤ãƒ³ãƒãƒ¼ãƒˆ</button>
        </div>
      </div>
      <ul class="nav nav-tabs mb-4 border-bottom-0 flex-shrink-0">${tabsHtml}</ul>
      <div id="t-area" class="position-relative flex-grow-1 d-flex flex-column overflow-hidden"></div>
    </div>`;
  renderTeacherDashboardContent();
}

function setTeacherClass(cls) { appState.view.teacherClassId = cls; renderTeacherView(); }
function setTeacherView(mode) { appState.view.teacher = mode; renderTeacherView(); }

function renderTeacherDashboardContent() {
  const el = document.getElementById('t-area');
  if (!el) return;
  const scrollPos = el.scrollTop;

  if (appState.view.teacher === 'analysis') { renderAnalysisView(el); return; }
  if (appState.view.teacher === 'summaries') { renderSummaryListView(el); el.scrollTop = scrollPos; return; }
  if (appState.view.teacher === 'seating') { renderSeatingView(el); return; }
  if (appState.view.teacher === 'control') { renderControlView(el); return; }
  
  const targetStudents = getFilteredStudents();
  if (appState.view.teacher === 'cards') {
    renderLiveCards(el, targetStudents);
  } else {
    renderHeatmap(el, targetStudents);
  }
  
  if(scrollPos > 0) el.scrollTop = scrollPos;
}

// å…ˆç”Ÿç”¨é€²è¡Œç®¡ç†ç”»é¢
function renderControlView(container) {
  container.className = "flex-grow-1 overflow-auto p-3";
  const todayStr = new Date().toISOString().split('T')[0];
  const unitOptions = appState.unitList.map(u => `<option value="${u.id}">${u.title}</option>`).join('');
  
  // æ™‚é–“å‰²ãƒœã‚¿ãƒ³ç”Ÿæˆ
  const periodButtons = CONSTANTS.CLASS_PERIODS.map(p => 
    `<button class="btn btn-outline-secondary btn-sm me-1 mb-1" onclick="setScheduleTime('${p.start}', '${p.end}')">${p.label}</button>`
  ).join('');

  container.innerHTML = `
    <div class="row g-4">
      <div class="col-md-6">
        <div class="card border-0 shadow-sm rounded-4 h-100">
          <div class="card-header bg-white border-0 fw-bold text-primary">
            <i class="bi bi-calendar-event me-2"></i>æˆæ¥­ã‚¹ã‚±ã‚¸ãƒ¥ãƒ¼ãƒ«ã®é…ä¿¡
          </div>
          <div class="card-body">
            <p class="small text-muted">è¨­å®šã—ãŸæ—¥æ™‚ã«ã€å…ç«¥ã®ç”»é¢ã¸ã€Œæˆæ¥­ã¸ã®ç§»å‹•é€šçŸ¥ã€ã‚’è¡¨ç¤ºã—ã¾ã™ã€‚</p>
            <div class="mb-3">
              <label class="form-label small">æ—¥ä»˜</label>
              <input type="date" id="sc-date" class="form-control" value="${todayStr}">
            </div>
            
            <div class="mb-2">
              <label class="form-label small">æ™‚é–“å‰²ã‹ã‚‰é¸æŠ</label>
              <div>${periodButtons}</div>
            </div>

            <div class="row mb-3">
              <div class="col">
                <label class="form-label small">é–‹å§‹</label>
                <input type="time" id="sc-start" class="form-control" value="08:45">
              </div>
              <div class="col">
                <label class="form-label small">çµ‚äº†</label>
                <input type="time" id="sc-end" class="form-control" value="09:30">
              </div>
            </div>
            <div class="mb-3">
              <label class="form-label small">å˜å…ƒ</label>
              <select id="sc-unit" class="form-select">${unitOptions}</select>
            </div>
            <div class="mb-3">
              <label class="form-label small">æ™‚æ•°</label>
              <input type="number" id="sc-hour" class="form-control" value="1" min="1">
            </div>
            <div class="mb-3">
              <label class="form-label small">ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ï¼ˆä»»æ„ï¼‰</label>
              <input type="text" id="sc-msg" class="form-control" placeholder="ä¾‹ï¼šä»Šæ—¥ã¯ãƒ†ã‚¹ãƒˆã§ã™">
            </div>
            <button class="btn btn-primary w-100 rounded-pill" onclick="submitSchedule()">è¨­å®šã‚’é…ä¿¡ã™ã‚‹</button>
          </div>
        </div>
      </div>
      
      <div class="col-md-6">
        <div class="card border-0 shadow-sm rounded-4 h-100">
          <div class="card-header bg-white border-0 fw-bold text-success">
            <i class="bi bi-list-check me-2"></i>é…ä¿¡æ¸ˆã¿ã‚¹ã‚±ã‚¸ãƒ¥ãƒ¼ãƒ«
          </div>
          <div class="card-body">
            <div class="alert alert-light border small h-100 overflow-auto">
              <ul class="mb-0 ps-3">
                ${appState.schedules.map(s => {
                   const u = appState.unitList.find(ul => ul.id === s.unitId);
                   return `<li>${s.date} ${s.startTime}-${s.endTime}<br>
                   <strong>${u ? u.title : 'ä¸æ˜'}</strong> ç¬¬${s.hour}æ™‚<br>
                   <span class="text-muted">${s.message || ''}</span></li>`;
                }).join('') || 'äºˆå®šãªã—'}
              </ul>
            </div>
          </div>
        </div>
      </div>
    </div>
  `;
}

function setScheduleTime(start, end) {
  document.getElementById('sc-start').value = start;
  document.getElementById('sc-end').value = end;
}

function submitSchedule() {
  const data = {
    classId: appState.view.teacherClassId === 'All' ? '1çµ„' : appState.view.teacherClassId, 
    date: document.getElementById('sc-date').value,
    startTime: document.getElementById('sc-start').value,
    endTime: document.getElementById('sc-end').value,
    unitId: document.getElementById('sc-unit').value,
    hour: document.getElementById('sc-hour').value,
    message: document.getElementById('sc-msg').value
  };
  
  if(!data.date || !data.startTime || !data.endTime) return Swal.fire('ã‚¨ãƒ©ãƒ¼', 'æ—¥æ™‚ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„', 'error');
  
  google.script.run
    .withSuccessHandler(() => {
      showToast('success', 'ã‚¹ã‚±ã‚¸ãƒ¥ãƒ¼ãƒ«ã‚’é…ä¿¡ã—ã¾ã—ãŸ');
      loadMainData();
    })
    .saveClassSchedule(data);
}

// ------------------------------------

function getFilteredStudents() {
  if (appState.view.teacherClassId === 'All') return dataStore.liveStatus;
  return dataStore.liveStatus.filter(s => s.classId === appState.view.teacherClassId);
}

function renderLiveCards(container, students) {
  container.className = "flex-grow-1 overflow-auto"; 
  if (students.length === 0) {
    container.innerHTML = `<div class="text-muted p-5 text-center">è¡¨ç¤ºã™ã‚‹ç”Ÿå¾’ãŒã„ã¾ã›ã‚“</div>`;
  } else {
    container.innerHTML = `<div class="row row-cols-2 row-cols-md-4 row-cols-lg-5 g-3">${students.map(s => {
      const isOtherUnit = s.currentUnitId && s.currentUnitId !== appState.unit.id;
      const opacity = isOtherUnit ? '0.5' : '1';
      const taskDisplay = isOtherUnit ? '<span class="small text-secondary">ä»–å˜å…ƒã‚’å­¦ç¿’ä¸­</span>' : (s.task || '-');
      return `
      <div class="col">
        <div class="card h-100 text-center p-3 shadow-sm border-0 rounded-4 ${s.mode==='ãŸã™ã‘ã¦'?'sos-alert':''}" style="opacity: ${opacity}">
          <div class="fw-bold text-truncate mb-2">${s.name}</div>
          <i class="bi bi-person-circle fs-1 my-2 ${s.mode==='ãŸã™ã‘ã¦'?'text-danger':s.mode==='ã—ã‚…ã†ã¡ã‚…ã†'?'text-info':'text-secondary'}"></i>
          <div class="small text-muted text-truncate">${taskDisplay}</div>
          <div class="badge bg-light text-muted mt-1 fw-normal">${s.mode}</div>
        </div>
      </div>`;
    }).join('')}</div>`;
  }
}

function renderHeatmap(container, students) {
  container.className = "flex-grow-1 overflow-auto";
  const currentTasks = getCurrentUnitTasks();
  if (currentTasks.length === 0) { container.innerHTML = `<div class="text-center p-5">ã“ã®å˜å…ƒã®èª²é¡Œãƒ‡ãƒ¼ã‚¿ãªã—</div>`; return; }
  const studentNames = students.map(s => s.name).sort();
  if (studentNames.length === 0) { container.innerHTML = `<div class="text-center p-5">ç”Ÿå¾’ãƒ‡ãƒ¼ã‚¿ãªã—</div>`; return; }

  let h = `<div class="table-responsive mb-4"><table class="table table-borderless heatmap-table"><thead><tr><th style="min-width:100px;text-align:left">åå‰</th>${currentTasks.map((t, i) => `<th title="${t.title}" onclick="showTeacherTaskDetailSimple('${t.taskId}')">${t.step ? t.step.replace(/[^0-9]/g, '') : i + 1}</th>`).join('')}</tr></thead><tbody>`;
  
  studentNames.forEach(n => {
    const st = dataStore.liveStatus.find(d => d.name === n);
    const ic = (st && st.mode === 'ãŸã™ã‘ã¦') ? '<i class="bi bi-exclamation-circle-fill text-danger ms-1 animate__animated animate__flash"></i>' : (st && st.mode === 'ã—ã‚…ã†ã¡ã‚…ã†' ? '<i class="bi bi-lightning-fill text-info ms-1"></i>' : '');
    h += `<tr><td class="text-start fw-bold text-truncate" style="max-width:120px;cursor:pointer;text-decoration:underline" onclick="renderPortfolioModal('${n}', true)">${n}${ic}</td>`;
    
    currentTasks.forEach(t => {
      const p = (dataStore.clsProgress[n] && dataStore.clsProgress[n][t.taskId]) || {};
      const stamp = (dataStore.clsFeedback[n] && dataStore.clsFeedback[n][t.taskId]);
      let cls = "", icon = "";
      if (p.status === 'å®Œäº†') cls = "heatmap-done";
      else if (p.status === 'é€”ä¸­') cls = "heatmap-doing";
      else if (st && st.mode === 'ãŸã™ã‘ã¦') cls = "heatmap-sos";
      if (stamp) { if(stamp==='check') icon='âœ…'; if(stamp==='good') icon='ğŸ‘'; if(stamp==='great') icon='ğŸ’®'; if(stamp==='support') icon='ğŸš©'; }
      h += `<td><div class="heatmap-cell-wrapper" onclick="showStudentTaskDetail('${n}', '${t.taskId}')"><div class="heatmap-cell ${cls}" title="${t.title}">${icon}</div></div></td>`;
    });
    h += '</tr>';
  });
  
  const indexHtml = `<div class="card bg-light border-0 rounded-4 p-3 mt-3"><h6 class="fw-bold text-muted mb-2"><i class="bi bi-list-ol me-2"></i>èª²é¡Œã‚¤ãƒ³ãƒ‡ãƒƒã‚¯ã‚¹ï¼ˆ${appState.unit.title}ï¼‰</h6><div class="row row-cols-1 row-cols-md-2 g-2 small">${currentTasks.map((t, i) => `<div class="col" style="cursor:pointer" onclick="showTeacherTaskDetailSimple('${t.taskId}')"><span class="badge bg-secondary me-2" style="width:25px;">${t.step ? t.step.replace(/[^0-9]/g, '') : i + 1}</span><span class="badge bg-white text-dark border me-1">${t.category}</span><span class="text-truncate d-inline-block" style="max-width:200px;vertical-align:middle">${t.title}</span></div>`).join('')}</div></div>`;
  container.innerHTML = h + '</tbody></table></div>' + indexHtml;
}

function renderSeatingView(container) {
  const students = getFilteredStudents();
  if (students.length === 0) {
    container.innerHTML = `<div class="text-center p-5 text-muted">è¡¨ç¤ºã™ã‚‹ç”Ÿå¾’ãŒã„ã¾ã›ã‚“</div>`;
    return;
  }

  container.className = "flex-grow-1 d-flex flex-column overflow-hidden";
  container.innerHTML = `
    <div class="d-flex justify-content-between mb-2 flex-shrink-0">
      <div class="small text-muted"><i class="bi bi-info-circle me-1"></i>ã‚«ãƒ¼ãƒ‰ã‚’ãƒ‰ãƒ©ãƒƒã‚°ã—ã¦åº§å¸­ã‚’é…ç½®ã§ãã¾ã™ï¼ˆã‚°ãƒªãƒƒãƒ‰å¸ç€ã‚ã‚Šï¼‰</div>
      <button class="btn btn-primary btn-sm rounded-pill px-3" onclick="saveSeating()">é…ç½®ã‚’ä¿å­˜</button>
    </div>
    <div class="seating-wrapper border rounded-4 bg-light shadow-inner flex-grow-1 position-relative overflow-hidden">
       <div id="seating-canvas" class="seating-canvas position-absolute top-0 start-0 w-100 h-100 overflow-auto">
         <!-- Cards will be injected here -->
       </div>
    </div>`;

  const canvas = document.getElementById('seating-canvas');
  
  students.forEach(s => {
    const x = s.x || 50;
    const y = s.y || 50;
    
    const card = document.createElement('div');
    card.className = `card shadow-sm seat-card position-absolute ${s.mode==='ãŸã™ã‘ã¦'?'sos-alert':''}`;
    card.style.left = x + 'px';
    card.style.top = y + 'px';
    card.style.width = '100px';
    card.setAttribute('data-name', s.name);
    
    card.innerHTML = `
      <div class="card-body p-2 text-center" style="cursor: move;" onmousedown="startDragSeat(event, this)" ontouchstart="startDragSeat(event, this)">
        <div class="fw-bold text-truncate small mb-1">${s.name}</div>
        <i class="bi bi-person-circle fs-3 ${s.mode==='ãŸã™ã‘ã¦'?'text-danger':s.mode==='ã—ã‚…ã†ã¡ã‚…ã†'?'text-info':'text-secondary'}"></i>
        <div class="x-small text-muted text-truncate mt-1">${s.task || '-'}</div>
      </div>
    `;
    canvas.appendChild(card);
  });
}

function startDragSeat(e, cardBody) {
  e.preventDefault(); 
  const card = cardBody.parentElement;
  dragSrcEl = card;
  isDraggingSeat = true;
  
  const clientX = e.type.includes('mouse') ? e.clientX : e.touches[0].clientX;
  const clientY = e.type.includes('mouse') ? e.clientY : e.touches[0].clientY;
  
  const shiftX = clientX - card.getBoundingClientRect().left;
  const shiftY = clientY - card.getBoundingClientRect().top;
  
  const canvas = document.getElementById('seating-canvas');
  const canvasRect = canvas.getBoundingClientRect();

  function moveAt(pageX, pageY) {
    let newLeft = pageX - shiftX - canvasRect.left;
    let newTop = pageY - shiftY - canvasRect.top;
    
    if (newLeft < 0) newLeft = 0;
    if (newTop < 0) newTop = 0;
    if (newLeft > canvasRect.width - card.offsetWidth) newLeft = canvasRect.width - card.offsetWidth;
    if (newTop > canvasRect.height - card.offsetHeight) newTop = canvasRect.height - card.offsetHeight;

    card.style.left = newLeft + 'px';
    card.style.top = newTop + 'px';
  }

  function onMouseMove(e) {
    const px = e.type.includes('mouse') ? e.pageX : e.touches[0].pageX;
    const py = e.type.includes('mouse') ? e.pageY : e.touches[0].pageY;
    moveAt(px, py);
  }

  function onMouseUp() {
    document.removeEventListener('mousemove', onMouseMove);
    document.removeEventListener('mouseup', onMouseUp);
    document.removeEventListener('touchmove', onMouseMove);
    document.removeEventListener('touchend', onMouseUp);
    
    const GRID = CONSTANTS.SEAT_GRID_SIZE;
    const currentLeft = parseInt(card.style.left, 10);
    const currentTop = parseInt(card.style.top, 10);
    
    const snapLeft = Math.round(currentLeft / GRID) * GRID + 10;
    const snapTop = Math.round(currentTop / GRID) * GRID + 10;
    
    card.style.transition = 'all 0.2s ease-out';
    card.style.left = snapLeft + 'px';
    card.style.top = snapTop + 'px';
    
    setTimeout(() => { card.style.transition = ''; }, 200);

    dragSrcEl = null;
    isDraggingSeat = false;
  }

  document.addEventListener('mousemove', onMouseMove);
  document.addEventListener('mouseup', onMouseUp);
  document.addEventListener('touchmove', onMouseMove, {passive: false});
  document.addEventListener('touchend', onMouseUp);
}

function saveSeating() {
  const cards = document.querySelectorAll('.seat-card');
  const coords = [];
  cards.forEach(c => {
    coords.push({
      name: c.getAttribute('data-name'),
      x: parseInt(c.style.left, 10),
      y: parseInt(c.style.top, 10)
    });
  });
  
  google.script.run
    .withSuccessHandler(() => showToast('success', 'åº§å¸­é…ç½®ã‚’ä¿å­˜ã—ã¾ã—ãŸ'))
    .withFailureHandler(handleError)
    .saveSeatCoordinates(coords);
}

function renderSummaryListView(container) {
  container.className = "flex-grow-1 overflow-auto";
  const students = getFilteredStudents().sort((a,b) => a.name.localeCompare(b.name));
  if (students.length === 0) {
    container.innerHTML = `<div class="text-center p-5 text-muted">è¡¨ç¤ºã™ã‚‹ç”Ÿå¾’ãŒã„ã¾ã›ã‚“</div>`;
    return;
  }
  let html = `<div class="row row-cols-1 row-cols-md-2 row-cols-xl-3 g-3">`;
  students.forEach(s => {
    const summary = (dataStore.clsPortfolios && dataStore.clsPortfolios[s.name] && dataStore.clsPortfolios[s.name][appState.unit.id]) || "";
    const hasSummary = summary.trim().length > 0;
    const cardClass = hasSummary ? "border-primary" : "border-0";
    const bgClass = hasSummary ? "bg-white" : "bg-light";
    const statusText = hasSummary ? summary.replace(/\n/g, '<br>') : '<span class="text-muted small">æœªæå‡º</span>';
    html += `
      <div class="col">
        <div class="card h-100 shadow-sm ${bgClass} ${cardClass} rounded-4" style="cursor:pointer; transition: transform 0.2s;" onclick="renderPortfolioModal('${s.name}', true)">
          <div class="card-body">
            <h6 class="fw-bold text-primary mb-2"><i class="bi bi-person-circle me-2"></i>${s.name}</h6>
            <div class="small text-break" style="max-height: 150px; overflow-y: hidden; text-overflow: ellipsis;">${statusText}</div>
          </div>
          ${hasSummary ? '<div class="card-footer bg-transparent border-0 text-end"><small class="text-primary fw-bold">è©³ç´°ã‚’è¦‹ã‚‹ <i class="bi bi-arrow-right"></i></small></div>' : ''}
        </div>
      </div>`;
  });
  html += `</div>`;
  container.innerHTML = html;
}

function renderAnalysisView(container) {
  container.className = "flex-grow-1 overflow-auto";
  google.script.run.withSuccessHandler(res => {
    const d = JSON.parse(res.json);
    const tasks = d.tasks.filter(t => t.unitId === appState.unit.id);
    const labels = tasks.map(t => t.title.substring(0, 10) + "...");
    const counts = tasks.map(t => d.counts[t.id] || 0);
    container.innerHTML = `
      <div class="row">
        <div class="col-md-8">
          <h6 class="fw-bold text-muted">å®Œäº†æ•°ï¼ˆ${appState.unit.title}ï¼‰</h6>
          <div class="chart-container"><canvas id="completionChart"></canvas></div>
        </div>
        <div class="col-md-4">
          <div class="card bg-light border-0 p-3 h-100">
            <h6 class="fw-bold text-muted">ãƒ‡ãƒ¼ã‚¿ç®¡ç†</h6>
            <p class="small text-muted">å­¦ç¿’ãƒ‡ãƒ¼ã‚¿ã‚’CSVå½¢å¼ã§ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰ã—ã¾ã™ã€‚</p>
            <button class="btn btn-outline-dark w-100 mb-3" onclick="downloadCsv()">
              <i class="bi bi-download me-2"></i>CSVãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰
            </button>
          </div>
        </div>
      </div>`;
    new Chart(document.getElementById('completionChart'), {
      type: 'bar',
      data: { labels: labels, datasets: [{ label: 'äººæ•°', data: counts, backgroundColor: '#4285f4' }] },
      options: { responsive: true, maintainAspectRatio: false, scales: { y: { beginAtZero: true, ticks: { stepSize: 1 } } } }
    });
  }).getAnalysisData();
}

function confirmArchive() {
  Swal.fire({
    title: 'å˜å…ƒã‚¢ãƒ¼ã‚«ã‚¤ãƒ–',
    text: `ç¾åœ¨ã®å˜å…ƒã€Œ${appState.unit.title}ã€ã®ãƒ­ã‚°ãƒ‡ãƒ¼ã‚¿ã‚’åˆ¥ãƒ•ã‚¡ã‚¤ãƒ«ã«é€€é¿ã—ã€ã“ã®ã‚¢ãƒ—ãƒªã‹ã‚‰å‰Šé™¤ã—ã¾ã™ã€‚å®Ÿè¡Œã—ã¾ã™ã‹ï¼Ÿ`,
    icon: 'warning',
    showCancelButton: true,
    confirmButtonColor: '#d33',
    confirmButtonText: 'ã‚¢ãƒ¼ã‚«ã‚¤ãƒ–å®Ÿè¡Œ'
  }).then((result) => {
    if (result.isConfirmed) {
      showLoading();
      google.script.run
        .withSuccessHandler(res => {
          hideLoading();
          if (res.success) {
            Swal.fire('å®Œäº†', res.message, 'success');
            loadMainData();
          } else { handleError(res); }
        })
        .withFailureHandler(handleError)
        .archiveUnitData(appState.unit.id, appState.unit.title);
    }
  });
}

function showStudentAllData(name) {
  renderPortfolioModal(name, true);
}

function downloadCsv() {
  const content = [
    ["Class","Student","TaskID","Status","Reflection","Timestamp"], 
    ...Object.keys(dataStore.clsProgress).flatMap(n => 
      Object.keys(dataStore.clsProgress[n]).map(tid => {
        const p = dataStore.clsProgress[n][tid]; 
        const cls = dataStore.liveStatus.find(s => s.name === n)?.classId || "";
        return [cls,n,tid,p.status,p.reflection,new Date().toLocaleString()];
      })
    )
  ].map(e => e.join(",")).join("\n");
  const blob = new Blob([content], {type:'text/csv'}); 
  const url = URL.createObjectURL(blob); 
  const a = document.createElement("a"); 
  a.href = url; a.download = "learning_logs.csv"; 
  a.click();
}

// --- Utils (æ—¢å­˜é–¢æ•°) ---
function showToast(icon, title) { Swal.fire({ toast: true, position: 'top-end', icon: icon, title: title, timer: 2000, showConfirmButton: false }); }
function handleError(err) { hideLoading(); Swal.fire({ title: 'ã‚·ã‚¹ãƒ†ãƒ ã‚¨ãƒ©ãƒ¼', text: err.message || err.toString(), icon: 'error' }); }
function showLoading() { const e = document.getElementById('loading'); if (e) e.classList.remove('d-none'); }
function hideLoading() { const e = document.getElementById('loading'); if (e) e.classList.add('d-none'); }
function toggleSettings() { if (document.getElementById('settingsModal')) { new bootstrap.Modal(document.getElementById('settingsModal')).show(); unlockAudio(); } }
function toggleDarkMode() { const isDark = document.getElementById('darkModeSwitch').checked; if (isDark) { document.body.setAttribute('data-theme', 'dark'); localStorage.setItem(CONSTANTS.LS_KEY_THEME, 'dark'); } else { document.body.removeAttribute('data-theme'); localStorage.setItem(CONSTANTS.LS_KEY_THEME, 'light'); } }
function toggleSound() { appState.sound.enabled = document.getElementById('soundSwitch').checked; if (appState.sound.enabled) unlockAudio(); }
function unlockAudio() { const audio = document.getElementById('sos-chime'); if (audio && !appState.sound.unlocked) { audio.volume = 0; audio.play().then(() => { audio.pause(); audio.currentTime = 0; audio.volume = 0.5; appState.sound.unlocked = true; }).catch(e => {}); } }
function checkSosAndPlaySound() { if (!appState.sound.enabled) return; const currentSosCount = dataStore.liveStatus.filter(d => d.mode === 'ãŸã™ã‘ã¦').length; if (currentSosCount > appState.sound.prevSosCount) { const audio = document.getElementById('sos-chime'); if (audio) audio.play().catch(e => {}); } appState.sound.prevSosCount = currentSosCount; }

// --- å…ç«¥ç”»é¢ç³»é–¢æ•° ---
function renderStudentView() { if (appState.view.student === 'planning') renderStudentPlanning(); else renderStudentDaily(); }
function renderStudentDaily() {
  const myStat = dataStore.liveStatus.find(d => d.name === appState.user.name) || { mode: 'é€šå¸¸' };
  const currentTasks = getCurrentUnitTasks();
  const myTasksFiltered = dataStore.myTasks.filter(t => t.unitId === appState.unit.id);
  const allTasks = [...currentTasks, ...myTasksFiltered];
  computedState.todaysPlanIds = new Set();
  const hourKey = String(appState.unit.currentHour);
  const plannedIds = dataStore.studentPlan[hourKey] || [];
  plannedIds.forEach(tid => computedState.todaysPlanIds.add(tid));
  allTasks.forEach(t => { if (t.format === 'teacher') computedState.todaysPlanIds.add(t.taskId); });
  const todaysTasks = allTasks.filter(t => computedState.todaysPlanIds.has(t.taskId));
  let totalTime = 0; todaysTasks.forEach(t => totalTime += t.time);
  const timePercent = Math.min((totalTime / CONSTANTS.UNIT_TIME) * 100, 100);
  let timeColor = totalTime > CONSTANTS.UNIT_TIME ? 'bg-danger' : (totalTime > CONSTANTS.UNIT_TIME * 0.8 ? 'bg-warning' : 'bg-success');
  let taskListHtml = todaysTasks.length === 0 ? `<div class="text-center py-5 text-muted"><p>è¨ˆç”»ãªã—</p><button class="btn btn-outline-primary rounded-pill" onclick="setStudentViewMode('planning')">è¨ˆç”»ã‚’ç«‹ã¦ã‚‹</button></div>` : todaysTasks.map(t => createStudentTaskCard(t)).join('');
  let hourOptions = ''; for(let i = 1; i <= appState.unit.totalHours; i++) { hourOptions += `<option value="${i}" ${i === appState.unit.currentHour ? 'selected' : ''}>ç¬¬${i}æ™‚</option>`; }
  let stBadge = ''; let rstBtn = 'd-none';
  if (myStat.mode === 'ãŸã™ã‘ã¦') { stBadge = `<span class="badge bg-danger rounded-pill px-2 py-1 me-2 animate__animated animate__flash">SOS</span>`; rstBtn = ''; } 
  else if (myStat.mode === 'ã—ã‚…ã†ã¡ã‚…ã†') { stBadge = `<span class="badge bg-info text-white rounded-pill px-2 py-1 me-2 animate__animated animate__pulse">é›†ä¸­</span>`; rstBtn = ''; }
  document.getElementById('app-container').innerHTML = `
    <div class="timeline-container shadow-sm p-3 mb-3 rounded-bottom border-bottom">
      <div class="d-flex justify-content-between align-items-center mb-2">
        <select class="form-select form-select-sm w-auto fw-bold text-primary border-0 bg-transparent" onchange="changeCurrentHour(this.value)">${hourOptions}</select>
        <div class="small fw-bold ${totalTime > CONSTANTS.UNIT_TIME ? 'text-danger' : 'text-muted'}">${totalTime} / ${CONSTANTS.UNIT_TIME}åˆ†</div>
      </div>
      <div class="progress" style="height: 1.5rem;"><div class="progress-bar progress-bar-striped ${timeColor}" role="progressbar" style="width: ${timePercent}%"></div></div>
    </div>
    <div class="px-2">
      <div class="d-flex justify-content-between align-items-center mb-3">
        <div class="fw-bold text-primary me-2 text-truncate" style="max-width:150px;"><i class="bi bi-person-circle me-1"></i>${appState.user.name} <span class="badge bg-light text-secondary border ms-1">${appState.user.classId}</span></div>
        <div class="d-flex gap-2">
          <button class="btn btn-outline-primary btn-sm rounded-pill" onclick="setStudentViewMode('planning')"><i class="bi bi-calendar-range"></i> <ruby>è¨ˆç”»<rt>ã‘ã„ã‹ã</rt></ruby></button>
          <button class="btn btn-outline-secondary btn-sm rounded-pill" onclick="renderPortfolioModal('${appState.user.name}')"><i class="bi bi-journal-text"></i></button>
          <button class="btn btn-outline-success btn-sm rounded-pill" onclick="openDailyReflectionModal()"><i class="bi bi-pencil-square"></i> ãµã‚Šã‹ãˆã‚Š</button>
        </div>
      </div>
      <div class="d-flex justify-content-end align-items-center mb-2">${stBadge}<div class="d-flex gap-1"><button class="btn btn-danger btn-sm rounded-pill px-3" onclick="submitUserStatus('ãŸã™ã‘ã¦')">SOS</button><button class="btn btn-info btn-sm rounded-pill px-3 text-white" onclick="submitUserStatus('ã—ã‚…ã†ã¡ã‚…ã†')">é›†ä¸­</button><button class="btn btn-secondary btn-sm rounded-pill px-3 ${rstBtn}" onclick="submitUserStatus('é€šå¸¸')">è§£é™¤</button></div></div>
      ${taskListHtml}
      <div class="d-grid gap-2 mb-4 mt-3"><button class="btn btn-outline-primary border-2 border-dashed py-3 rounded-4" onclick="openMyTaskModal()"><i class="bi bi-plus-circle-fill me-2"></i>ã˜ã¶ã‚“ã®<ruby>èª²é¡Œ<rt>ã‹ã ã„</rt></ruby></button></div>
    </div>`;
}

function createStudentTaskCard(t) {
  const prog = dataStore.studentProgress[t.taskId] || {};
  const stamp = dataStore.studentFeedback[t.taskId];
  const isDone = prog.status === 'å®Œäº†'; const isDoing = prog.status === 'é€”ä¸­';
  let isLocked = false;
  if (t.prerequisites && t.prerequisites.length > 0) {
    const allPreDone = t.prerequisites.every(pid => (dataStore.studentProgress[pid] && dataStore.studentProgress[pid].status === 'å®Œäº†'));
    if (!allPreDone) isLocked = true;
  }
  const cardClass = isLocked ? 'card-locked' : '';
  let stampHtml = stamp ? `<div class="stamp-badge animate__animated animate__bounceIn">${{'check':'âœ…','good':'ğŸ‘','great':'ğŸ’®','support':'ğŸš©'}[stamp]||''}</div>` : '';
  let actionBtn = '';
  if (isDone) { actionBtn = `<button class="btn btn-secondary rounded-pill px-3 btn-sm fw-bold" disabled>å®Œäº†</button>`; } 
  else {
    const doingBtn = isDoing ? 'btn-warning text-dark' : 'btn-outline-warning text-dark';
    let buttons = `<button class="btn btn-outline-success rounded-pill px-3 btn-sm fw-bold" onclick="event.stopPropagation(); submitTaskProgress('${t.taskId}','å®Œäº†',this)">ã§ããŸ</button>`;
    if (t.format !== 'teacher') buttons = `<button class="btn ${doingBtn} rounded-pill px-3 btn-sm fw-bold me-1" onclick="event.stopPropagation(); submitTaskProgress('${t.taskId}','é€”ä¸­',this)">é€”ä¸­</button>` + buttons;
    actionBtn = buttons;
  }
  if (t.format === 'teacher') actionBtn = `<span class="badge bg-info text-white me-2">å…ˆç”Ÿ</span>` + actionBtn;
  return `
    <div class="card shadow-sm mb-3 card-task ${cardClass} position-relative" style="cursor:pointer;" onclick="openTaskDetailModal('${t.taskId}')">
      ${stampHtml}
      ${isLocked ? `<div class="position-absolute top-50 start-50 translate-middle text-center" style="z-index:2"><i class="bi bi-lock-fill fs-1 text-secondary"></i><br><span class="badge bg-secondary">ãƒ­ãƒƒã‚¯ä¸­</span></div>` : ''}
      <div class="card-body">
        <div class="d-flex justify-content-between align-items-center mb-2">
           <div class="d-flex align-items-center"><span class="badge bg-light text-dark border me-2">${t.category}</span></div>
           <div class="text-end"><span class="badge bg-light text-secondary border">${t.time}åˆ†</span></div>
        </div>
        <h5 class="fw-bold mb-2">${t.title}</h5>
        <div class="text-end mt-2 d-flex justify-content-end align-items-center">${actionBtn}</div>
      </div>
    </div>`;
}

function setStudentViewMode(mode) { appState.view.student = mode; renderStudentView(); }
function changeCurrentHour(h) { appState.unit.currentHour = parseInt(h); renderStudentView(); }
function syncStudentPlan() { const plans = dataStore.clsPlans[appState.user.name] || {}; const currentPlan = plans[appState.unit.id] || {}; for (let i = 1; i <= appState.unit.totalHours; i++) { if (!currentPlan[String(i)]) currentPlan[String(i)] = []; } dataStore.studentPlan = currentPlan; }

function renderStudentPlanning() {
  const planContainer = document.querySelector('.plan-container'); const scrollX = planContainer ? planContainer.scrollLeft : 0;
  const poolContainer = document.getElementById('task-pool-container'); const poolScrollY = poolContainer ? poolContainer.scrollTop : 0;
  const currentTasks = getCurrentUnitTasks();
  const myTasksFiltered = dataStore.myTasks.filter(t => t.unitId === appState.unit.id);
  const allTasks = [...currentTasks, ...myTasksFiltered].filter(t => t.format !== 'teacher');
  let taskPoolHtml = `<div class="d-grid gap-2 mb-3 sticky-top bg-white pt-2 pb-2 border-bottom" style="top:0; z-index:5;"><button class="btn btn-outline-primary btn-sm rounded-pill border-dashed" onclick="openMyTaskModal()"><i class="bi bi-plus-lg me-1"></i><ruby>èª²é¡Œ<rt>ã‹ã ã„</rt></ruby>ä½œæˆ</button></div>`;
  allTasks.forEach(t => { taskPoolHtml += `<div class="card p-2 mb-2 shadow-sm task-draggable" style="${t.category==='ãƒã‚¤ã‚¿ã‚¹ã‚¯'?'background-color:#fbf5ff;':''}" data-id="${t.taskId}"><div class="small fw-bold">${t.title}</div><div class="x-small text-muted">${t.time}åˆ†</div></div>`; });
  
  // v12.13: ç¸¦ã‚¹ã‚¯ãƒ­ãƒ¼ãƒ«ãƒ¬ã‚¤ã‚¢ã‚¦ãƒˆã¸ã®å¤‰æ›´
  let hoursHtml = '';
  for(let i = 1; i <= appState.unit.totalHours; i++) {
    let plannedTasksHtml = '';
    const plannedIds = dataStore.studentPlan[String(i)] || [];
    plannedIds.forEach(tid => {
      const t = allTasks.find(x => x.taskId === tid);
      if (t) plannedTasksHtml += `<div class="card p-2 mb-2 shadow-sm task-draggable" style="${t.category==='ãƒã‚¤ã‚¿ã‚¹ã‚¯'?'background-color:#fbf5ff;':''}" data-id="${t.taskId}"><div class="d-flex justify-content-between"><span class="small fw-bold text-truncate">${t.title}</span><i class="bi bi-x text-danger" style="cursor:pointer" onclick="removeFromPlan('${String(i)}', '${tid}')"></i></div></div>`;
    });
    // ç¸¦ä¸¦ã³ã‚³ãƒ³ãƒ†ãƒŠ
    hoursHtml += `
      <div class="plan-hour-row mb-3">
        <div class="plan-hour-header-v p-2 fw-bold text-center bg-light border rounded-top">ç¬¬${i}æ™‚</div>
        <div class="plan-drop-zone-v p-2 border border-top-0 rounded-bottom" data-hour="${i}" style="min-height: 80px; background-color: #f8f9fa;">
          ${plannedTasksHtml}
        </div>
      </div>`;
  }

  document.getElementById('app-container').innerHTML = `
    <div class="p-3 d-flex flex-column h-100">
      <div class="d-flex justify-content-between align-items-center mb-3 flex-shrink-0">
        <h5 class="fw-bold m-0"><i class="bi bi-calendar-range me-2 text-primary"></i><ruby>è¨ˆç”»<rt>ã‘ã„ã‹ã</rt></ruby>ãƒ¢ãƒ¼ãƒ‰</h5>
        <button class="btn btn-primary rounded-pill px-4 shadow-sm" onclick="setStudentViewMode('daily')"><ruby>å®Œäº†<rt>ã‹ã‚“ã‚Šã‚‡ã†</rt></ruby></button>
      </div>
      <div class="row flex-grow-1" style="min-height:0; height: calc(100vh - 150px);">
        <!-- å·¦å´ï¼šèª²é¡Œãƒ—ãƒ¼ãƒ« -->
        <div class="col-4 h-100 border-end bg-white rounded-start d-flex flex-column">
          <div class="small text-muted mb-2 flex-shrink-0 p-2 border-bottom">èª²é¡Œãƒªã‚¹ãƒˆ</div>
          <div id="task-pool-container" class="flex-grow-1 overflow-auto p-2"><div id="task-pool">${taskPoolHtml}</div></div>
        </div>
        <!-- å³å´ï¼šè¨ˆç”»è¡¨ï¼ˆç¸¦ã‚¹ã‚¯ãƒ­ãƒ¼ãƒ«ï¼‰ -->
        <div class="col-8 h-100 overflow-auto">
          <div class="plan-container-v h-100 pt-2">
            ${hoursHtml}
          </div>
        </div>
      </div>
    </div>`;

  const newPoolContainer = document.getElementById('task-pool-container'); if (newPoolContainer) newPoolContainer.scrollTop = poolScrollY;
  
  // Sortable.jsã®è¨­å®š
  new Sortable(document.getElementById('task-pool'), { group: { name: 'shared', pull: 'clone', put: false }, sort: false, animation: 150 });
  
  document.querySelectorAll('.plan-drop-zone-v').forEach(el => {
    new Sortable(el, {
      group: 'shared',
      sort: true,
      animation: 150,
      onAdd: function (evt) {
        const tid = evt.item.getAttribute('data-id');
        const h = String(evt.to.getAttribute('data-hour'));
        addToPlan(h, tid);
        evt.item.remove(); // ã‚¯ãƒ­ãƒ¼ãƒ³å…ƒã®DOMã¯å‰Šé™¤ï¼ˆå†æç”»ã•ã‚Œã‚‹ãŸã‚ï¼‰
      }
    });
  });
}

function addToPlan(hour, taskId) { if (!dataStore.studentPlan[hour]) dataStore.studentPlan[hour] = []; dataStore.studentPlan[hour].push(taskId); savePlan(); renderStudentPlanning(); }
function removeFromPlan(hour, taskId) { if (dataStore.studentPlan[hour]) { dataStore.studentPlan[hour] = dataStore.studentPlan[hour].filter(id => id !== taskId); savePlan(); renderStudentPlanning(); } }

function openImportModal() { Swal.fire({ title: 'JSONã‚¤ãƒ³ãƒãƒ¼ãƒˆ', html: '<textarea id="ji" class="form-control" rows="10"></textarea>', showCancelButton: true, confirmButtonText: 'å®Ÿè¡Œ' }).then(r => { if (r.isConfirmed) { showLoading(); google.script.run.withSuccessHandler(d => { hideLoading(); Swal.fire('å®Œäº†', d.count + 'ä»¶', 'success'); loadMainData(); }).importUnitJson(document.getElementById('ji').value); } }); }
function showStudentTaskDetail(name, tid) { const t = dataStore.masterTasks.find(x => x.taskId === tid); const p = (dataStore.clsProgress[name] && dataStore.clsProgress[name][tid]) || {}; Swal.fire({ title: `${name} ã•ã‚“ã®çŠ¶æ³`, html: `<div class="text-start"><h6 class="fw-bold text-primary">${t.title}</h6><div class="mb-3"><span class="badge bg-secondary me-1">çŠ¶æ…‹: ${p.status||'æœª'}</span></div><div class="p-3 bg-light rounded mb-3 small">${p.reflection||'ãƒ¡ãƒ¢ãªã—'}</div><hr><div class="d-flex justify-content-center gap-2"><button class="btn btn-outline-primary rounded-circle p-2" style="width:50px;height:50px;font-size:1.5rem" onclick="sendStamp('${name}','${tid}','check')">âœ…</button><button class="btn btn-outline-primary rounded-circle p-2" style="width:50px;height:50px;font-size:1.5rem" onclick="sendStamp('${name}','${tid}','good')">ğŸ‘</button><button class="btn btn-outline-primary rounded-circle p-2" style="width:50px;height:50px;font-size:1.5rem" onclick="sendStamp('${name}','${tid}','great')">ğŸ’®</button><button class="btn btn-outline-primary rounded-circle p-2" style="width:50px;height:50px;font-size:1.5rem" onclick="sendStamp('${name}','${tid}','support')">ğŸš©</button></div></div>`, showConfirmButton: false, showCloseButton: true }); }
function sendStamp(name, tid, stamp) { if (!dataStore.clsFeedback[name]) dataStore.clsFeedback[name] = {}; dataStore.clsFeedback[name][tid] = stamp; renderTeacherDashboardContent(); showToast('success', 'ã‚¹ã‚¿ãƒ³ãƒ—é€ä¿¡'); google.script.run.sendFeedback(name, tid, stamp, appState.view.teacherClassId !== 'All' ? appState.view.teacherClassId : ''); }
function showTeacherTaskDetailSimple(tid) { const t = dataStore.masterTasks.find(x => x.taskId === tid); if (!t) return; Swal.fire({ title: t.title, html: `<div class="text-start"><p class="text-muted border p-3 rounded bg-light mb-0">${t.desc || 'èª¬æ˜ãªã—'}</p><div class="mt-2 text-end small text-muted">æ™‚é–“: ${t.time}åˆ†</div></div>`, showConfirmButton: false, showCloseButton: true }); }
function openMyTaskModal() { Swal.fire({ title: 'ã˜ã¶ã‚“ã®èª²é¡Œ', html: `<div class="text-start"><label class="form-label small fw-bold">ã‚¿ã‚¤ãƒˆãƒ«</label><input id="mt-title" class="form-control mb-3"><label class="form-label small fw-bold">ã‚ã‚ã¦</label><textarea id="mt-desc" class="form-control mb-3" rows="2"></textarea><label class="form-label small fw-bold">æ™‚é–“</label><input id="mt-time" type="number" class="form-control" value="15"></div>`, showCancelButton: true, confirmButtonText: 'è¿½åŠ ', preConfirm: () => { const t = document.getElementById('mt-title').value; if (!t) Swal.showValidationMessage('ã‚¿ã‚¤ãƒˆãƒ«å¿…é ˆ'); return { title: t, desc: document.getElementById('mt-desc').value, time: document.getElementById('mt-time').value }; } }).then(r => { if (r.isConfirmed) { const v = r.value; google.script.run.withSuccessHandler(() => { dataStore.myTasks.push({ taskId: "MT_TEMP", title: v.title, desc: v.desc, time: parseInt(v.time), category: 'ãƒã‚¤ã‚¿ã‚¹ã‚¯', type: 'challenge', format: 'student' }); if (appState.view.student === 'planning') renderStudentPlanning(); else loginStudent(true); showToast('success', 'èª²é¡Œè¿½åŠ '); }).addMyTask(appState.user.name, v.title, v.desc, v.time, appState.unit.id, appState.user.classId); } }); }
function openTaskDetailModal(taskId) { const allTasks = [...dataStore.masterTasks, ...dataStore.myTasks]; const t = allTasks.find(x => x.taskId === taskId); if (!t || t.isLocked) return; const mem = (dataStore.studentProgress[taskId] || {}).reflection || ""; Swal.fire({ title: t.title, html: `<div class="text-start"><p class="small bg-light p-2 rounded">${t.desc || ""}</p><label class="form-label fw-bold small">ãƒ¡ãƒ¢</label><textarea id="ref-txt" class="form-control" rows="3">${mem}</textarea></div>`, showCancelButton: true, confirmButtonText: 'ä¿å­˜' }).then(r => { if (r.isConfirmed) { const txt = document.getElementById('ref-txt').value; if (txt !== mem) { if (!dataStore.studentProgress[taskId]) dataStore.studentProgress[taskId] = {}; dataStore.studentProgress[taskId].reflection = txt; const curStatus = dataStore.studentProgress[taskId].status || 'æœªç€æ‰‹'; google.script.run.updateStatus(appState.user.name, t.taskId, t.title, curStatus, 'é€šå¸¸', txt, appState.user.classId, appState.unit.id); showToast('success', 'ä¿å­˜å®Œäº†'); renderStudentView(); } } }); }
</script>
